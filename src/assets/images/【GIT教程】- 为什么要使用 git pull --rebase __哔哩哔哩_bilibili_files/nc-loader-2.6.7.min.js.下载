/*! #metadata# bp-nc-sdk: 2.6.7-e22a9b63 (Fri May 20 2022 18:03:38 GMT+0800 (China Standard Time)) mode: production*/
var e,t;e=window,t=function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=39)}([function(e,t,r){"use strict";r.r(t),r.d(t,"__extends",(function(){return i})),r.d(t,"__assign",(function(){return o})),r.d(t,"__rest",(function(){return s})),r.d(t,"__decorate",(function(){return a})),r.d(t,"__param",(function(){return c})),r.d(t,"__metadata",(function(){return u})),r.d(t,"__awaiter",(function(){return l})),r.d(t,"__generator",(function(){return d})),r.d(t,"__createBinding",(function(){return h})),r.d(t,"__exportStar",(function(){return f})),r.d(t,"__values",(function(){return p})),r.d(t,"__read",(function(){return m})),r.d(t,"__spread",(function(){return g})),r.d(t,"__spreadArrays",(function(){return v})),r.d(t,"__spreadArray",(function(){return y})),r.d(t,"__await",(function(){return b})),r.d(t,"__asyncGenerator",(function(){return R})),r.d(t,"__asyncDelegator",(function(){return _})),r.d(t,"__asyncValues",(function(){return C})),r.d(t,"__makeTemplateObject",(function(){return S})),r.d(t,"__importStar",(function(){return w})),r.d(t,"__importDefault",(function(){return D})),r.d(t,"__classPrivateFieldGet",(function(){return P})),r.d(t,"__classPrivateFieldSet",(function(){return k}));var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var o=function(){return(o=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function s(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function a(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}function c(e,t){return function(r,n){t(r,n,e)}}function u(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function l(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))}function d(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var h=Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]};function f(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||h(t,e,r)}function p(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function m(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s}function g(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(m(arguments[t]));return e}function v(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<r;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)n[i]=o[s];return n}function y(e,t){for(var r=0,n=t.length,i=e.length;r<n;r++,i++)e[i]=t[r];return e}function b(e){return this instanceof b?(this.v=e,this):new b(e)}function R(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,i=r.apply(e,t||[]),o=[];return n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n;function s(e){i[e]&&(n[e]=function(t){return new Promise((function(r,n){o.push([e,t,r,n])>1||a(e,t)}))})}function a(e,t){try{(r=i[e](t)).value instanceof b?Promise.resolve(r.value.v).then(c,u):l(o[0][2],r)}catch(e){l(o[0][3],e)}var r}function c(e){a("next",e)}function u(e){a("throw",e)}function l(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}}function _(e){var t,r;return t={},n("next"),n("throw",(function(e){throw e})),n("return"),t[Symbol.iterator]=function(){return this},t;function n(n,i){t[n]=e[n]?function(t){return(r=!r)?{value:b(e[n](t)),done:"return"===n}:i?i(t):t}:i}}function C(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=p(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise((function(n,i){!function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)}(n,i,(t=e[r](t)).done,t.value)}))}}}function S(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var T=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};function w(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&h(t,e,r);return T(t,e),t}function D(e){return e&&e.__esModule?e:{default:e}}function P(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)}function k(e,t,r){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,r),r}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LOG_LEVEL=void 0;const n=r(0).__importDefault(r(8));var i;!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARNING=3]="WARNING",e[e.ERROR=4]="ERROR"}(i=t.LOG_LEVEL||(t.LOG_LEVEL={}));class o{constructor(e=""){this.namespace=e,this.state={level:i.INFO,historyList:[]}}static getInstance(){return o.instance||(o.instance=new o),o.instance}setLevel(e){this.state.level=e}debug(e,...t){this.baseLog([e,...t],i.VERBOSE)}log(e,...t){this.baseLog([e,...t],i.INFO)}logNoRecord(e,...t){this.baseLog([e,...t],i.INFO,!1)}warn(e,...t){this.baseLog([e,...t],i.WARNING)}error(e,...t){this.baseLog([e,...t],i.ERROR)}baseLog(e,t=i.INFO,r=!0){const s=new Date,a={level:t,time:`${s.getMonth()+1}/${s.getDate()} ${s.toTimeString().substr(0,8)}.${s.getMilliseconds()}`,timeStamp:s.getTime(),msgArr:e};let c;try{c=JSON.parse(localStorage.getItem("bp_nc_config")||"{}").showNCLog}catch(e){console.log("bp_nc_config error",e)}if(r){const t=JSON.stringify(e);t.length<5e3?this.state.historyList.push(a):c&&console.warn("---big log: "+t),this.state.historyList.length>=o.MAX_LOG_LENGTH&&this.state.historyList.shift()}if(a.level>=this.state.level&&1===c){const t=`[v${n.default.getInstance().version}]-[${a.time}]`;switch(a.level){case i.WARNING:console.warn(t,...e);break;case i.ERROR:console.error(t,...e);break;case i.VERBOSE:console.debug(t,...e);break;default:console.log(t,...e)}}}getHistory(e=i.INFO){let t="";return this.state.historyList.forEach(r=>{r.level>=e&&(t+=`\n[BPNC ${this.namespace} ${r.time}] ${JSON.stringify(r.msgArr)}`)}),t}reset(){this.state={level:i.INFO,historyList:[]}}}o.MAX_LOG_LENGTH=1e3,t.default=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(21),i=r(22);class o{static cloneDeep(e,t){if(null===e||"object"!=typeof e)return e;let r;if(o.isTypedArray(e)&&"function"==typeof e.slice)return r=e.slice(),r;r=Array.isArray(e)?[]:{};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const i=e[n];r[n]=t&&"object"==typeof i?o.cloneDeep(i,t):i}return r}static isTypedArray(e){return!!(e&&e.buffer instanceof ArrayBuffer&&e.BYTES_PER_ELEMENT)}static downloadFile(e,t){let r=document.createElement("a"),n=t.slice&&"data:"===t.slice(0,5),i=t.lastIndexOf&&t.lastIndexOf(".")>-1;r.download=e,r.style.display="none",r.href=i||n?t:URL.createObjectURL(new Blob([t])),document.body.appendChild(r),r.click(),document.body.removeChild(r)}static concatArrayBuffer(e,t){if(!e)return t;if(!t)return e;let r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}static concatUint8Array(e,t){if(!e)return t;if(!t)return e;let r=new Uint8Array(e.byteLength+t.byteLength);return r.set(e,0),r.set(t,e.byteLength),r}static encodeUTF8(e){const t=encodeURIComponent(e),r=[];for(let e=0;e<t.length;e++){const n=t.charAt(e);if("%"===n){const n=t.charAt(e+1)+t.charAt(e+2),i=parseInt(n,16);r.push(i),e+=2}else r.push(n.charCodeAt(0))}return new Uint8Array(r)}static decodeUTF8(e){let t="";for(let r=0;r<e.byteLength;r++)t+="%"+e[r].toString(16);return decodeURIComponent(t)}static isChrome(){const e=navigator.userAgent;return-1===e.indexOf("Edge")&&e.indexOf("Chrome")>-1&&e.indexOf("Safari")>-1}static isChromeAboveCertainVersion(e){var t;const r=null===(t=navigator.userAgent.match(/(?:crios|crmo|chrome)\/([0-9]+)/i))||void 0===t?void 0:t[1],n=parseInt(r);return!(Number.isNaN(n)||n<e)}static isSupportSeeder(){let e=new RTCPeerConnection,t=e.createDataChannel("__test__");const r=void 0!==t.onbufferedamountlow;return t.close(),e.close(),t=null,e=null,r}static canUseRealP2P(e){let{rid:t,aid:r,qn:n}=e||{};if(void 0!==t&&(n=parseInt(o.getQnAndCid(t).qn)),void 0!==n){if(isNaN(n)||n<=0)return!1;if(this.realP2PRestrictions.qn.every(e=>!(n>e[0]&&n<=e[1])))return!1}return!0}static isSupportP2P(){var e;const t=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,r=null===(e=window.RTCDataChannel)||void 0===e?void 0:e.prototype.send;return!!(window.indexedDB&&(null==t?void 0:t.prototype.createDataChannel)&&r&&o.checkLocalStorage())}static getCookie(e){if(null==e)return"";const t=document.cookie.split(";"),r=decodeURIComponent(e);for(let e=0;e<t.length;e++){const[n,i]=t[e].trim().split("=");if(decodeURIComponent(n)===r)return decodeURIComponent(i)}return""}static getLocalSettings(e){return window.localStorage&&localStorage.getItem?localStorage.getItem(e):o.getCookie(e)}static getLocalStorage(e){return localStorage.getItem(e)}static setLocalStorage(e,t){localStorage.setItem(e,JSON.stringify(t))}static randomString(e){const t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=t.length,n=[];for(let i=0;i<e;i++){const e=Math.floor(Math.random()*r);n.push(t[e])}return n.join("")}static get BROWSER_ENV(){return window.location.hostname.includes("pre-")?i.RUNTIME_MODE.PRE:n.metadata.mode}static getQnAndCid(e){const t=e.split(/[-_\.]/);return{cid:t[0],qn:t[t.length-2]}}static tryCatchSync(e,...t){try{return[null,e(...t)]}catch(e){return[e]}}static tryCatchAsync(e){return e.then(e=>[null,e]).catch(e=>[e])}static checkLocalStorage(){try{return localStorage.getItem("happy"),!0}catch(e){return!1}}static getAttrsOfObj(e,t){return t.reduce((t,r)=>(t[r]=e[r],t),{})}static onBeforeUnload(e){window.addEventListener("beforeunload",e)}static isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}static getPeerTarget(e){return e?parseInt(e.split(":")[1])===i.DEVICE_TYPE.BOX?"box":"browser":"unknown"}static promiseState(e){const t={};return Promise.race([e,t]).then(e=>e===t?"pending":"fulfilled",()=>"rejected")}static noop(){}}o.realP2PRestrictions={aidLastNum:[0,1,3,6,8],qn:[[3e4,30076],[30200,30280],[100022,100025]]},t.default=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorkshopEvent=void 0;class n{}n.TRACK="track",n.SOCKET_CONNECT="socket_connect",n.SOCKET_MESSAGE="socket_message",n.SOCKET_DISCONNECT="socket_disconnect",n.WEBRTC_ANSWER_TIMEOUT="webrtc_answer_timeout",n.WEBRTC_CHANNEL_OPEN_TIMEOUT="webrtc_channel_open_timeout",n.WEBRTC_CHANNEL_CLOSE="webrtc_channel_close",n.WEBRTC_CHANNEL_OPEN="webrtc_channel_open",n.WEBRTC_GET_DATA_FAIL="webrtc_get_data_fail",n.WEBRTC_GET_DATA_TIMEOUT="webrtc_get_data_timeout",n.WEBRTC_OFFER_REJECTED="webrtc_offer_rejected",n.WEBRTC_SET_REMOTE_DESC="webrtc_set_remote_description";class i{}t.WorkshopEvent=i,i.GET_DATA_SUCCESS="workshop_get_data_success",i.GET_DATA_FAIL="workshop_get_data_fail",t.default=n},function(e,t,r){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let n=0,i=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(n++,"%c"===e&&(i=n))}),t.splice(i,0,r)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=r(44)(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},function(e,t,r){function n(e){if(e)return function(e){for(var t in n.prototype)e[t]=n.prototype[t];return e}(e)}e.exports=n,n.prototype.on=n.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},n.prototype.once=function(e,t){function r(){this.off(e,r),t.apply(this,arguments)}return r.fn=t,this.on(e,r),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=n.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var r,n=this._callbacks["$"+e];if(!n)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var i=0;i<n.length;i++)if((r=n[i])===t||r.fn===t){n.splice(i,1);break}return 0===n.length&&delete this._callbacks["$"+e],this},n.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),r=this._callbacks["$"+e],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(r){n=0;for(var i=(r=r.slice(0)).length;n<i;++n)r[n].apply(this,t)}return this},n.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},n.prototype.hasListeners=function(e){return!!this.listeners(e).length}},function(e,t,r){"use strict";var n;function i(e,t,r){if(!r||typeof r.value!==n.typeOfFunction)throw new TypeError("Only methods can be decorated with @bind. <"+t+"> is not a method!");return{configurable:n.boolTrue,get:function(){var e=r.value.bind(this);return Object.defineProperty(this,t,{value:e,configurable:n.boolTrue,writable:n.boolTrue}),e}}}Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.typeOfFunction="function",e.boolTrue=!0}(n||(n={})),t.bind=i,t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBUtils=void 0;const n=r(0),i=n.__importDefault(r(8)),o=r(34),s=r(19),a=r(35),c=r(64),u=r(36),l=n.__importDefault(r(2));class d{static transaction(e,t,r,i){return(o,s,a)=>{const c=(a=a||Object.getOwnPropertyDescriptor(o,s)).value;return a.value=function(...o){return n.__awaiter(this,void 0,void 0,(function*(){return this.transaction(e,t,()=>n.__awaiter(this,void 0,void 0,(function*(){return yield c.apply(this,o)}))).catch(e=>{d.handleError(e,!0,r+"错误",i)})}))},a}}static waitingForReport(e,t,r){const i=(r=r||Object.getOwnPropertyDescriptor(e,t)).value;return r.value=function(...e){return n.__awaiter(this,void 0,void 0,(function*(){try{const t=yield i.apply(this,e),{rid:r,rangeArr:n}=t,o=r+":"+d.getRangeMB(n[0]).rangeMB,s=this.hasSavedResources.findIndex(e=>e.id===o);return-1===s?this.hasSavedResources.push({rangeArr:n,id:o}):this.hasSavedResources[s].rangeArr.push(n[0]),t}catch(e){d.handleError(e,!0)}}))},r}static trackComplete(e){const t=(t,r)=>{var n;null===(n=e[t])||void 0===n||n.forEach(e=>{Array.isArray(e)?"function"==typeof e[1]?u.track.dbStat[e[0]]+=e[1](r):u.track.dbStat[e[0]]+=e[1]:u.track.dbStat[e]++})};return(e,r,i)=>{const o=(i=i||Object.getOwnPropertyDescriptor(e,r)).value;i.value=function(...e){return n.__awaiter(this,void 0,void 0,(function*(){try{const r=yield o.apply(this,e);return t("success",r),r}catch(e){t("failure"),d.handleError(e,!0)}}))}}}static updateLocalStorage(e,t,r){const i=(r=r||Object.getOwnPropertyDescriptor(e,t)).value;r.value=function(...e){return n.__awaiter(this,void 0,void 0,(function*(){try{const t=yield i.apply(this,e),r=Array.isArray(t)?l.default.getQnAndCid(d.decode(t[0].rid)).cid:l.default.getQnAndCid(d.decode(t.rid)).cid;return null===this.updateLocalStorageTimer&&(d.setSaveRestriction(r,{timestamp:Date.now()}),this.updateLocalStorageTimer=window.setTimeout(()=>{this.updateLocalStorageTimer=null},3e4)),t}catch(e){d.handleError(e,!0)}}))}}static timeout(e){return(t,r,i)=>{const o=(i=i||Object.getOwnPropertyDescriptor(t,r)).value;return i.value=function(...t){return n.__awaiter(this,void 0,void 0,(function*(){return yield Promise.race([o.apply(this,t),new Promise((t,r)=>{setTimeout(()=>r(new s.DBError(43006,"供血端获取indexedDB数据超时")),e)})])}))},i}}static getSaveRestriction(){const e=l.default.getLocalStorage(d.SAVE_RESTRICTION),[t,r]=l.default.tryCatchSync(JSON.parse,e);return t||!l.default.isObject(r)?{}:r}static setSaveRestriction(e,t){const r=d.getSaveRestriction();if(Object.keys(r).length>=d.localStorageMaxItem)throw new Error("不允许同时存超过10个视频");l.default.setLocalStorage(this.SAVE_RESTRICTION,Object.assign(Object.assign({},r),{[e]:Object.assign(Object.assign({},r[e]),t)}))}static parseRange(e){const t=e.split("-").map(Number).filter(e=>!Number.isNaN(e));if(2!==t.length)throw new s.DBError(43002,"invalid range: "+e);return t}static getSizeFromRange(e){const t=this.parseRange(e);return t[1]-t[0]+1}static getRangeMB(e){const[t,r]=this.parseRange(e),n=d.resourceBlockSize*i.default.BLOCK_SIZE,o=Math.floor(t/n);if(o>=2e3/d.resourceBlockSize)throw new s.DBError(43003,"slice range too big, disable saving");const[a,c]=[o*d.resourceBlockSize,(o+1)*d.resourceBlockSize-1];return{rangeMB:`${a}-${c}`,byteStart:a*n,byteEnd:c*n,rangeStart:t,rangeEnd:r}}static getBPNCConfig(){try{return Object.assign({showDBLog:0,showNCLog:0,showLog:0,enableEncryption:1,showSeederLog:0},JSON.parse(localStorage.getItem("bp_nc_config")||"{}"))}catch(e){return{showDBLog:0,showNCLog:0,showLog:0,showSeederLog:0,enableEncryption:1}}}static configureLog(){const e=new Date,t=`DBLog-[v${i.default.getInstance().version}]-[${e.toTimeString().slice(0,8)}-${e.getTime()}]`,{showDBLog:r,showSeederLog:n}=this.getBPNCConfig();return{baseLog:t,showDBLog:r,showSeederLog:n}}static log(...e){const t=["color: #fff","background-color: #444","padding: 2px 4px","border-radius: 2px"],{baseLog:r,showDBLog:n}=this.configureLog();0!==n&&n<=1&&console.log("%cDebug Logs",t.join(";"),r,...e)}static happyLog(...e){const t=["color: #fff","background-color: green","padding: 2px 4px","border-radius: 2px"],{baseLog:r,showDBLog:n}=this.configureLog();0!==n&&n<=2&&console.log("%cSuccess Logs",t.join(";"),r,...e)}static warn(...e){const t=["color: #eee","background-color: red","padding: 2px 4px","border-radius: 2px"],{baseLog:r,showDBLog:n}=this.configureLog();0!==n&&n<=3&&console.log("%cWarn Logs",t.join(";"),r,...e)}static sLog(...e){const t=["color: #fff","background-color: green","padding: 2px 4px","border-radius: 2px"],{baseLog:r,showSeederLog:n}=this.configureLog();n>=1&&console.log("%cSeeder Logs",t.join(";"),r,...e)}static handleError(e,t,r,n){let i=43009;n&&(i=n),e instanceof s.DBError&&(i=e.code);const o=(r?[r,e.message]:[e.message]).join("; ");if(t)throw new s.DBError(i,o);d.warn(`错误是${null==e?void 0:e.name}类型, 错误信息是${o}, 错误码是${i}`)}static transformResource(e){if(e)return e.map(({id:e,rangeArr:t})=>{const[r,n]=e.split(":");return{id:d.decode(r)+":"+n,rangeArr:t}})}static encode(e){return c.dbEncryption.encode(e)}static decode(e){return c.dbEncryption.decode(e)}static getSizeFromRangeArr(e){return e.reduce((e,t)=>e+d.getSizeFromRange(t),0)}static getSizeFromResources(e){return e&&0!==e.length?o.DBController.isWriteResourceRes(e)?e.reduce((e,t)=>e+t.byteLength,0):a.ResourceDocument.isResourceDocument(e)?e.reduce((e,t)=>e+t.getSize(),0):e.reduce((e,t)=>e+d.getSizeFromRangeArr(t.rangeArr),0):0}static formatMs(e){if(e<=1e3)return e+"ms";if(e<=6e4)return Math.floor(e/1e3)+"s";const t=Math.floor(e/1e3);return`${Math.floor(t/60)}min${t%60}s`}static setLocalStorageV2(e,t,r){if("function"!=typeof t)return void localStorage.setItem(e,JSON.stringify(t));const n=localStorage.getItem(e);if(null!==n)try{const r=JSON.parse(n);localStorage.setItem(e,JSON.stringify(t(r)))}catch(t){localStorage.setItem(e,JSON.stringify(r))}else localStorage.setItem(e,JSON.stringify(t))}static isContainRange(e,t,r){if("string"==typeof t){const[[r,n],[i,o]]=[e,t].map(d.parseRange);return r<=i&&n>=o}const[n,i]=d.parseRange(e);return n<=t&&i>=r}}t.DBUtils=d,d.SAVE_RESTRICTION="bp_nc_sr",d.localStorageMaxItem=10,d.resourceBlockSize=100,d.canDeleteMaxTimeDelta=864e5,d.dbMaxSize=524288e3,d.ridMaxNum=30},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(21);class i{constructor(){this.version=n.metadata.version+"-"+n.metadata.hash.substr(0,8)}static getInstance(){return i.instance||(i.instance=new i),i.instance}reset(){}}i.BLOCK_SIZE=1048576,t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createSocket=t.createMessage=void 0,t.createMessage=function(e,t){return Object.assign({type:e},t)},t.createSocket=function(e,t){return{emit:(...r)=>t.emit(e,...r),on:r=>t.on(e,r),off:r=>t.off(e,r)}}},function(e,t,r){"use strict";var n={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},n.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},n.getDescription=function(e){var t=n.splitSections(e);return t&&t[0]},n.getMediaSections=function(e){var t=n.splitSections(e);return t.shift(),t},n.matchPrefix=function(e,t){return n.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},n.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1]}return r},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},n.parseIceOptions=function(e){return e.substr(14).split(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},n.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<n.length;i++)r[(t=n[i].trim().split("="))[0].trim()]=t[1];return r},n.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},n.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},n.getMid=function(e){var t=n.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},n.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},n.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:n.matchPrefix(e+t,"a=fingerprint:").map(n.parseFingerprint)}},n.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},n.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},n.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?n.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},n.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},n.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},n.getCryptoParameters=function(e,t){return n.matchPrefix(e+t,"a=crypto:").map(n.parseCryptoLine)},n.getIceParameters=function(e,t){var r=n.matchPrefix(e+t,"a=ice-ufrag:")[0],i=n.matchPrefix(e+t,"a=ice-pwd:")[0];return r&&i?{usernameFragment:r.substr(12),password:i.substr(10)}:null},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=n.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var o=r[i],s=n.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){var a=n.parseRtpMap(s),c=n.matchPrefix(e,"a=fmtp:"+o+" ");switch(a.parameters=c.length?n.parseFmtp(c[0]):{},a.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(n.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(n.parseExtmap(e))})),t},n.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=n.writeRtpMap(e),r+=n.writeFmtp(e),r+=n.writeRtcpFb(e)}));var i=0;return t.codecs.forEach((function(e){e.maxptime>i&&(i=e.maxptime)})),i>0&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach((function(e){r+=n.writeExtmap(e)})),r},n.parseRtpEncodingParameters=function(e){var t,r=[],i=n.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),s=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=a.length>0&&a[0].ssrc,u=n.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));u.length>0&&u[0].length>1&&u[0][0]===c&&(t=u[0][1]),i.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(n.rtx={ssrc:t}),r.push(n),o&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},r.push(n))}})),0===r.length&&c&&r.push({ssrc:c});var l=n.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=l}))),r},n.parseRtcpParameters=function(e){var t={},r=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var i=n.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0,t.compound=0===i.length;var o=n.matchPrefix(e,"a=rtcp-mux");return t.mux=o.length>0,t},n.parseMsid=function(e){var t,r=n.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var i=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return i.length>0?{stream:(t=i[0].value.split(" "))[0],track:t[1]}:void 0},n.parseSctpDescription=function(e){var t,r=n.parseMLine(e),i=n.matchPrefix(e,"a=max-message-size:");i.length>0&&(t=parseInt(i[0].substr(19),10)),isNaN(t)&&(t=65536);var o=n.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:r.fmt,maxMessageSize:t};if(n.matchPrefix(e,"a=sctpmap:").length>0){var s=n.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:t}}},n.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},n.generateSessionId=function(){return Math.random().toString().substr(2,21)},n.writeSessionBoilerplate=function(e,t,r){var i=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||n.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,r,i){var o=n.writeRtpDescription(e.kind,t);if(o+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",e.direction?o+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var s="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+s,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),o},n.getDirection=function(e,t){for(var r=n.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return t?n.getDirection(t):"sendrecv"},n.getKind=function(e){return n.splitLines(e)[0].split(" ")[0].substr(2)},n.isRejected=function(e){return"0"===e.split(" ",2)[1]},n.parseMLine=function(e){var t=n.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},n.parseOLine=function(e){var t=n.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},n.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=n.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},e.exports=n},function(e,t,r){const n=r(50),i=r(51),o=String.fromCharCode(30);e.exports={protocol:4,encodePacket:n,encodePayload:(e,t)=>{const r=e.length,i=new Array(r);let s=0;e.forEach((e,a)=>{n(e,!1,e=>{i[a]=e,++s===r&&t(i.join(o))})})},decodePacket:i,decodePayload:(e,t)=>{const r=e.split(o),n=[];for(let e=0;e<r.length;e++){const o=i(r[e],t);if(n.push(o),"error"===o.type)break}return n}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0).__importDefault(r(13));class i{constructor(){this.events=new n.default}static getInstance(){return i.instance||(i.instance=new i),i.instance}on(e,t){var r;null===(r=this.events)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.events)||void 0===r||r.off(e,t)}trigger(e,...t){var r;null===(r=this.events)||void 0===r||r.trigger(e,...t)}destroy(){this.events&&(this.events.destroy(),this.events=new n.default)}}t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importDefault(r(1));n.__importStar(r(3)),t.default=class{constructor(){this.events={}}on(e,t){"function"==typeof t&&(this.events[e]||(this.events[e]=[]),this.events[e].push(t))}off(e,t){if("function"==typeof t&&this.events[e])if(t){const r=this.events[e].indexOf(t);r>-1&&this.events[e].splice(r,1)}else this.events[e]=[]}trigger(e,...t){this.events[e]&&this.events[e].length&&[...this.events[e]].forEach(e=>{try{e(...t)}catch(e){i.default.getInstance().error(e)}})}destroy(){this.events={}}}},function(e,t){e.exports="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{}n.TRACK_TYPE={TEST:1e3,ENTER:1001,QUIT:1002,SAVE_DATA:2001,GET_DATA:2002,OPEN_DB:2003,DB_UPGRADE:2004,OPEN_DB_ERROR:2005,OPEN_DB_SUCCESS:2006,DB_CLOSE:2007,PUT_DB:2008,PUT_DB_SUCCESS:2009,PUT_DB_ERROR:2010,DB_RESOURCE:2011,DEL_DB_ERROR:2012,REPORT_RESOURCE:2013,DEBUG_TOTAL_SIZE_NOT_EQUAL:5e3},n.RESOURCE_OPTION={UPDATE:1,ADD:2,DEL:3},n.RESPONSE_CODE={SUCCESS:1,ERROR:-1,FILE_READER_ERROR:-2,ANSWER_INVALID:-3,WEBRTC_OPEN_TIMEOUT:-300,WEBRTC_OPEN_TIMEOUT_BY_NO_LDP:-301,WEBRTC_OPEN_TIMEOUT_BY_NO_RDP:-302,WEBRTC_OPEN_TIMEOUT_BY_NO_RC:-303,WEBRTC_OPEN_TIMEOUT_BY_NO_ACS:-304},n.RTC_STATE_CODE={INIT:1,DATA_CHANNEL_OPEN_SUCCESS:2,DATA_CHANNEL_OPEN_ERROR:3,SEND_DATA_SUCCESS:4,GET_DATA_SUCCESS:5},t.default=n},function(e,t,r){const n=r(11),i=r(5),o=r(4)("engine.io-client:transport");e.exports=class extends i{constructor(e){super(),this.opts=e,this.query=e.query,this.readyState="",this.socket=e.socket}onError(e,t){const r=new Error(e);return r.type="TransportError",r.description=t,this.emit("error",r),this}open(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState?this.write(e):o("transport is not open, discarding packets")}onOpen(){this.readyState="open",this.writable=!0,this.emit("open")}onData(e){const t=n.decodePacket(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){this.emit("packet",e)}onClose(){this.readyState="closed",this.emit("close")}}},function(e,t){t.encode=function(e){var t="";for(var r in e)e.hasOwnProperty(r)&&(t.length&&(t+="&"),t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t},t.decode=function(e){for(var t={},r=e.split("&"),n=0,i=r.length;n<i;n++){var o=r[n].split("=");t[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return t}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Decoder=t.Encoder=t.PacketType=t.protocol=void 0;const n=r(5),i=r(56),o=r(32),s=r(4)("socket.io-parser");var a;t.protocol=5,function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(a=t.PacketType||(t.PacketType={})),t.Encoder=class{encode(e){return s("encoding packet %j",e),e.type!==a.EVENT&&e.type!==a.ACK||!o.hasBinary(e)?[this.encodeAsString(e)]:(e.type=e.type===a.EVENT?a.BINARY_EVENT:a.BINARY_ACK,this.encodeAsBinary(e))}encodeAsString(e){let t=""+e.type;return e.type!==a.BINARY_EVENT&&e.type!==a.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data)),s("encoded %j as %s",e,t),t}encodeAsBinary(e){const t=i.deconstructPacket(e),r=this.encodeAsString(t.packet),n=t.buffers;return n.unshift(r),n}};class c extends n{constructor(){super()}add(e){let t;if("string"==typeof e)t=this.decodeString(e),t.type===a.BINARY_EVENT||t.type===a.BINARY_ACK?(this.reconstructor=new u(t),0===t.attachments&&super.emit("decoded",t)):super.emit("decoded",t);else{if(!o.isBinary(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emit("decoded",t))}}decodeString(e){let t=0;const r={type:Number(e.charAt(0))};if(void 0===a[r.type])throw new Error("unknown packet type "+r.type);if(r.type===a.BINARY_EVENT||r.type===a.BINARY_ACK){const n=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const i=e.substring(n,t);if(i!=Number(i)||"-"!==e.charAt(t))throw new Error("Illegal attachments");r.attachments=Number(i)}if("/"===e.charAt(t+1)){const n=t+1;for(;++t&&","!==e.charAt(t)&&t!==e.length;);r.nsp=e.substring(n,t)}else r.nsp="/";const n=e.charAt(t+1);if(""!==n&&Number(n)==n){const n=t+1;for(;++t;){const r=e.charAt(t);if(null==r||Number(r)!=r){--t;break}if(t===e.length)break}r.id=Number(e.substring(n,t+1))}if(e.charAt(++t)){const n=function(e){try{return JSON.parse(e)}catch(e){return!1}}(e.substr(t));if(!c.isPayloadValid(r.type,n))throw new Error("invalid payload");r.data=n}return s("decoded %s as %j",e,r),r}static isPayloadValid(e,t){switch(e){case a.CONNECT:return"object"==typeof t;case a.DISCONNECT:return void 0===t;case a.CONNECT_ERROR:return"string"==typeof t||"object"==typeof t;case a.EVENT:case a.BINARY_EVENT:return Array.isArray(t)&&t.length>0;case a.ACK:case a.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&this.reconstructor.finishedReconstruction()}}t.Decoder=c;class u{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=i.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBError=void 0;class n extends Error{constructor(e,t){super(t),this.code=e,this.name="CustomIndexedDBError"}}t.DBError=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCLeecher=void 0;const n=r(0),i=n.__importDefault(r(6)),o=r(9),s=n.__importDefault(r(3)),a=n.__importDefault(r(1)),c=r(37);class u extends c.WebRTCBase{constructor(e,t,r,n,i,o,a,c){super(e,t,r,n,i),this.needDataByte=0,this.receivedDataByte=0,this.tempPassageByteLength=0,this.saveRangeIndex=0,this.heartbeatTime=2e3,this.dataChannelOpenTimer=0,this.dataChannelOpenTimeout=this.sdk.fawkesConfig.leecherChannelOpenTimeout,this.dataChannelMessageTimeoutTimer=0,this.dataChannelMessageTimeout=3500,this.isSucking=!1,this.maxBitrate={browser:1e3},this.identity="leecher",this.index=o,this.uuid=a,this.webrtcStore=c,this.socketController.on(s.default.SOCKET_MESSAGE,this.onSocketMessage),this.init()}init(){a.default.getInstance().log(`init ${this.path} index: ${this.index} WebRTCLeecher -- cSid: ${this.cPeerSocketID}`),super.init(),this.dataChannel=this.peerConnection.createDataChannel("receiveDataChannel",Object.assign({ordered:!0},"browser"===this.peerTarget?{negotiated:!0,id:0}:void 0)),this.dataChannel.binaryType="arraybuffer",this.dataChannelBindEvent()}dataChannelBindEvent(){this.dataChannel.onmessage=e=>{var t,r,n,i,o,c,u,l,d,h,f,p,m;if(!this.leecherGetDataParam)return void(null===(t=this.getDataOnReject)||void 0===t||t.call(this,{code:42e3,msg:"webRTC onmessage no getDataInternalParam",responseData:this.makeResponseData()}));if(this.createDataChannelMessageTimeout(),a.default.getInstance().log(`[onDataChannelMessage] ${this.path} index: ${this.index} cSid: ${this.cPeerSocketID}, label: ${this.dataChannel.label}`,"string"==typeof e.data?e.data:e.data.byteLength),this.leecherGetDataParam.prefetch){if("string"==typeof e.data){if(!isNaN(Number(e.data)))return this.saveRangeIndex=this.leecherGetDataParam.allocatedIndex,void(this.needDataByte=Number(e.data));a.default.getInstance().log(`[heartbeat] ${this.path} index: ${this.index} webRTCController heartbeat -- cPeerSocketID: ${this.cPeerSocketID}, isPaused: ${this.isPaused}`),this.isPaused&&"pending"===this.webrtcStore.detectActiveBuffer(this.path)&&this.webrtcStore.resumeSend(this.path,this.cPeerSocketID,!0),this.heartbeatTimer||(this.heartbeatTimer=setTimeout(()=>{a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController heartbeat stop -- cPeerSocketID: ${this.cPeerSocketID}, isPaused: ${this.isPaused}`),this.isPaused||this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index)},this.heartbeatTime))}else{if(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(()=>{a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController heartbeat stop -- cPeerSocketID: ${this.cPeerSocketID}, isPaused: ${this.isPaused}`),!this.isPaused&&this.webrtcStore.getReceivedLastDataCount(this.path)<5&&this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index)},this.heartbeatTime),!this.needDataByte)return void a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received invalid buffer -- cSid: ${this.cPeerSocketID}`);const t=new Uint8Array(e.data);t.byteLength!==this.leecherGetDataParam.allocatedByteLength?(this.webrtcStore.setReceivedLastDataCount(this.path,1),a.default.getInstance().error("[onDataChannelMessage-error]",this.path,e.data)):this.webrtcStore.setReceivedLastDataCount(this.path,0),this.isPaused=!1,this.receivedDataByte+=t.byteLength,this.tempPassageByteLength+=t.byteLength,this.tempPassageByteLength>=this.leecherGetDataParam.prefetch&&(this.isPaused=!0,this.tempPassageByteLength=0),this.webrtcStore.saveArrayBuffer(this.path,this.cPeerSocketID,t,this.leecherGetDataParam.originRange.start,this.saveRangeIndex,this.leecherGetDataParam.allocatedByteLength),this.saveRangeIndex+=this.leecherGetDataParam.totalPeerCount}return}const g=this.leecherGetDataParam.useRange.end-this.leecherGetDataParam.useRange.start+1;if("string"==typeof e.data){const t=parseInt(e.data,10);return this.needDataByte=parseInt(e.data,10),t!==g?(a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received invalid totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: `+t),null===(r=this.getDataOnReject)||void 0===r||r.call(this,{code:42001,msg:this.path+" webRTCController received invalid totalSize",responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index)):this.receivedU8Buffer?(a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received totalSize after receivedU8Buffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: `+t),null===(n=this.getDataOnReject)||void 0===n||n.call(this,{code:42002,msg:this.path+" webRTCController received totalSize after receivedU8Buffer",responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index)):(this.receivedU8Buffer=new Uint8Array(parseInt(e.data,10)),this.receivedDataByte=0,void a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: `+(null===(i=this.receivedU8Buffer)||void 0===i?void 0:i.byteLength)))}if(0===this.needDataByte)return void a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received invalid buffer -- cSid: ${this.cPeerSocketID}`);if(!this.receivedU8Buffer)return a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data before received totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),null===(o=this.getDataOnReject)||void 0===o||o.call(this,{code:42003,msg:this.path+" webRTCController received data before received totalSize",responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index);let v=new Uint8Array(e.data);if(this.updateReceiveRtcStat(v.byteLength),!v.byteLength)return a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received 0 byte data -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),void(null===(c=this.getDataOnReject)||void 0===c||c.call(this,{code:42004,msg:this.path+" webRTCController received 0 byte data",responseData:this.makeResponseData()}));if(this.receivedDataByte+v.byteLength>g)return a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data more than needed -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),null===(u=this.getDataOnReject)||void 0===u||u.call(this,{code:42005,msg:this.path+" webRTCController received data more than needed",responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index);if(this.receivedU8Buffer.set(v,this.receivedDataByte),this.receivedDataByte+=v.byteLength,this.receivedDataByte===(null===(l=this.receivedU8Buffer)||void 0===l?void 0:l.byteLength)){if(a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received all data -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: `+(null===(d=this.receivedU8Buffer)||void 0===d?void 0:d.byteLength)),(null===(h=this.receivedU8Buffer)||void 0===h?void 0:h.byteLength)!==g)return null===(f=this.getDataOnReject)||void 0===f||f.call(this,{code:42006,msg:"WebRTC get data not enough",responseData:this.makeResponseData()}),a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data not enough -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: `+(null===(p=this.receivedU8Buffer)||void 0===p?void 0:p.byteLength)),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index);null===(m=this.getDataOnResolve)||void 0===m||m.call(this,{code:24e3,msg:"success",responseData:this.makeResponseData()}),"browser"===this.peerTarget&&this.rtcStat.getSuccessFromBrowser++}},this.dataChannel.onopen=()=>{var e,t,r;if(this.isOpen=!0,this.trigger(s.default.WEBRTC_CHANNEL_OPEN,this.cPeerSocketID,this.path,this.index),this.dataChannelOpenTimer&&window.clearTimeout(this.dataChannelOpenTimer),"open"===(null===(e=this.dataChannel)||void 0===e?void 0:e.readyState)){const e=this.peerConnection.sctp;if(e&&e.maxMessageSize&&(this.maxMessageSize=e.maxMessageSize),a.default.getInstance().log(`${this.path} index: ${this.index} dataChannel open -- cSid: ${this.cPeerSocketID}, label: ${this.dataChannel.label}`),"browser"===this.peerTarget&&(null===(t=this.socketController)||void 0===t||t.reportStatToTracker("leecherDataChannelOpen")),this.leecherGetDataParam&&"box"===this.peerTarget){const e=this.leecherGetDataParam,t=Object.assign(Object.assign({},e),{range:`${e.originRange.start}-${e.originRange.end}`,originRange:`${e.originRange.start}-${e.originRange.end}`,useRange:`${e.useRange.start}-${e.useRange.end}`,latency:this.leecherGetDataParam.latency,flag:this.leecherGetDataParam.prefetch?2:void 0}),n=o.createMessage("getData",{data:JSON.stringify(t),rid:this.path,s:0});null===(r=this.socketController)||void 0===r||r.sendMessage(this.cPeerSocketID,n)}"browser"===this.peerTarget&&this.rtcStat.offerDataChannelOpenToBrowser++}},this.dataChannel.onclose=()=>{this.isOpen=!1,this.getDataOnReject?(this.getDataOnReject({code:40014,msg:"dataChannel Close",responseData:this.makeResponseData()}),this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index)):this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index,{code:40014,msg:"dataChannel Close"}),a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController dataChannel closed -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}}changePeer(){var e;null===(e=this.getDataOnReject)||void 0===e||e.call(this,{code:41005,msg:"answer peer lose",responseData:this.makeResponseData()}),a.default.getInstance().log(`${this.path} index: ${this.index} answer peer lose -- cSid: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}createOffer(){var e;null===(e=this.peerConnection)||void 0===e||e.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!1}).then(e=>{var t,r,n,i;if(this.isDestroyed)return;null===(t=this.peerConnection)||void 0===t||t.setLocalDescription(e).then(()=>{this.hasLocalDescription=!0,a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController setLocalDescription success from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}).catch(e=>{a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController createOffer setLocalDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, errorMessage: ${""+e}`)}),a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController setLocalDescription from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`);const s=o.createMessage("offer",{data:JSON.stringify(e),isSameIP:this.isSameIP,qn:null===(r=this.path)||void 0===r?void 0:r.split(".")[0].slice(-5),rid:this.path,s:0});"browser"===this.peerTarget&&this.rtcStat.offerInitToBrowser++,"browser"===this.peerTarget&&(null===(n=this.socketController)||void 0===n||n.reportStatToTracker("offerSent")),null===(i=this.socketController)||void 0===i||i.sendMessage(this.cPeerSocketID,s)},e=>{var t;"browser"===this.peerTarget&&(null===(t=this.socketController)||void 0===t||t.reportStatToTracker("createOfferErr")),this.isDestroyed||a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController createOffer error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, error: `+e.toString())}),this.createDataChannelOpenTimeout()}createDataChannelMessageTimeout(){this.dataChannelMessageTimeoutTimer&&window.clearTimeout(this.dataChannelMessageTimeoutTimer),this.dataChannelMessageTimeoutTimer=window.setTimeout(()=>{var e;this.dataChannelMessageTimeoutTimer=0,null===(e=this.getDataOnReject)||void 0===e||e.call(this,{code:40013,msg:"inner getData timeout",responseData:this.makeResponseData()}),this.trigger(s.default.WEBRTC_GET_DATA_TIMEOUT,this.cPeerSocketID,this.path,this.index)},this.dataChannelMessageTimeout)}createDataChannelOpenTimeout(){this.dataChannelOpenTimer=window.setTimeout(()=>{this.trigger(s.default.WEBRTC_CHANNEL_OPEN_TIMEOUT,this.cPeerSocketID,this.path,this.index),this.dataChannelOpenTimer=0},this.dataChannelOpenTimeout)}reset(){this.needDataByte=0,this.receivedDataByte=0,this.receivedU8Buffer=null}getReceivedU8Buffer(){return this.receivedU8Buffer}getReceivedDataByte(){return this.receivedDataByte}getNeedDataByte(){return this.needDataByte}getData(e){return new Promise((t,r)=>{var n,i;if(this.isSucking=!0,this.leecherGetDataParam=e,this.saveRangeIndex=e.allocatedIndex,this.getDataOnResolve=e=>{t(e),this.dataChannelMessageTimeoutTimer&&window.clearTimeout(this.dataChannelMessageTimeoutTimer),this.isSucking=!1,this.receivedDataByte=0},this.getDataOnReject=e=>{r(e),this.dataChannelMessageTimeoutTimer&&window.clearTimeout(this.dataChannelMessageTimeoutTimer),this.isSucking=!1,this.receivedDataByte=0},this.reset(),!this.leecherGetDataParam)return void(null===(n=this.getDataOnReject)||void 0===n||n.call(this,{code:40006,msg:"webRTC getData data param invalid",responseData:this.makeResponseData()}));const s=Object.assign(Object.assign({},e),{range:`${e.originRange.start}-${e.originRange.end}`,originRange:`${e.originRange.start}-${e.originRange.end}`,useRange:`${e.useRange.start}-${e.useRange.end}`,latency:this.leecherGetDataParam.latency,sStart:e.originRange.start+e.allocatedIndex*e.allocatedByteLength,flag:this.leecherGetDataParam.prefetch?2:void 0});a.default.getInstance().log(`[getDataSocketParams] ${this.path} index: ${this.index}`,s);const c=o.createMessage("getData",{data:JSON.stringify(s),rid:this.path,s:0});null===(i=this.socketController)||void 0===i||i.sendMessage(this.cPeerSocketID,c)})}onSocketMessage(e){var t,r,n;if(e&&e.fromSocketID&&e.fromSocketID===this.cPeerSocketID){if("offerRejected"===e.type)return a.default.getInstance().log(`${this.path} index: ${this.index} answer peer rejected offer -- cSid: ${this.cPeerSocketID}, ${e.msg}`),void this.trigger(s.default.WEBRTC_OFFER_REJECTED,this.cPeerSocketID,this.path,this.index,{code:e.code,msg:e.msg,responseData:this.makeResponseData()});if(e.data)if("changePeerV2"!==e.type){if(e.rid&&e.rid===this.path){if("candidate"!==e.type)return"answer"===e.type?(a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received answer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),void(null===(r=this.peerConnection)||void 0===r||r.setRemoteDescription(new RTCSessionDescription(JSON.parse(e.data))).then(()=>{this.hasRemoteDescription=!0,a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received answer setRemoteDescription success from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}).catch(e=>{a.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received answer setRemoteDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, errorMessage: ${""+e}`)}))):"getDataFail"===e.type||"getDataFromDBFail"===e.type?(a.default.getInstance().log(`${this.path} index: ${this.index} answer peer get data fail -- cSid: ${this.cPeerSocketID}, ${e.msg}`),null===(n=this.getDataOnReject)||void 0===n||n.call(this,{code:e.code,msg:e.msg,responseData:this.makeResponseData()}),void this.trigger(s.default.WEBRTC_GET_DATA_FAIL,this.cPeerSocketID,this.path,this.index)):void 0;"box"!==this.peerTarget&&1!==e.s||(a.default.getInstance().log("--------leecher onSocketMessage",this.cPeerSocketID,e),super.addIcecandidate(e))}}else(null===(t=e.rids)||void 0===t?void 0:t.length)&&e.rids.includes(this.path)&&this.changePeer()}}updateReceiveRtcStat(e){this.rtcStat.receivedByteTotal+=e,"browser"===this.peerTarget?this.rtcStat.receivedByteFromBrowser+=e:"box"===this.peerTarget&&(this.rtcStat.receivedByteFromBox+=e)}makeResponseData(){var e,t,r,n,i,o,s,a,c,u;return{range:(null===(e=this.leecherGetDataParam)||void 0===e?void 0:e.originRange.start)+"-"+(null===(t=this.leecherGetDataParam)||void 0===t?void 0:t.originRange.end),useRange:null===(r=this.leecherGetDataParam)||void 0===r?void 0:r.useRange,originRange:null===(n=this.leecherGetDataParam)||void 0===n?void 0:n.originRange,from:0,path:null!==(o=null===(i=this.leecherGetDataParam)||void 0===i?void 0:i.rid)&&void 0!==o?o:this.path,getDataTime:Date.now()-(null===(s=this.leecherGetDataParam)||void 0===s?void 0:s.startTime),startTime:null===(a=this.leecherGetDataParam)||void 0===a?void 0:a.startTime,uint8:this.receivedU8Buffer,gotDataByte:this.receivedDataByte,rtcDataChannelState:this.dataChannelState,cPeerSID:this.cPeerSocketID,latency:null===(c=this.leecherGetDataParam)||void 0===c?void 0:c.latency,retryCount:null===(u=this.leecherGetDataParam)||void 0===u?void 0:u.retryCount,rtcIndex:this.index}}destroy(){var e;a.default.getInstance().log(`${this.path} index: ${this.index} webRTCController destroy -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),this.leecherGetDataParam=null,null===(e=this.socketController)||void 0===e||e.off(s.default.SOCKET_MESSAGE,this.onSocketMessage),super.destroy(),this.needDataByte=0,this.receivedDataByte=0,this.receivedU8Buffer=null,this.getDataOnResolve=this.getDataOnReject=null,this.dataChannelOpenTimer&&window.clearTimeout(this.dataChannelOpenTimer),this.dataChannelMessageTimeoutTimer&&window.clearTimeout(this.dataChannelMessageTimeoutTimer),clearTimeout(this.heartbeatTimer),delete this.heartbeatTimer}}n.__decorate([i.default],u.prototype,"onSocketMessage",null),t.WebRTCLeecher=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.metadata=void 0,t.metadata={name:"browser-client",version:"2.6.7",hash:"e22a9b6",branch:"Detached: e22a9b63af7e7aa05e1f2ae6bfed02143b40fd9c",lastModified:"Fri May 20 2022 18:03:38 GMT+0800 (China Standard Time)",mode:"production"}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DISTRIBUTION_LASTPUSH_KEY=t.DISTRIBUTION_BASEURL=t.CODE_RATIO_MAP=t.CLEAR_MAP=t.RATIO_MAP=t.RTC_LOAD_TYPE=t.RUNTIME_MODE=t.OPERATION=t.HOT_PUSH_FROM=t.DEVICE_TYPE=t.REDIS_KEY=t.STRING=void 0,t.STRING={BOX:"box",BROWSER:"browser",AUTO_HOT_PUSH:"autoHotPush",CLIENT:"client",RESOURCE:"resource",RESOURCES:"resources",HOT_RESOURCES:"hotResources",NO_RESOURCES:"noResources",SIDS:"sids",PRID:"prid",PRIDS:"prids",BP_NC_TRACKER:"bpNcTracker",CLIENT_NUM:"clientNum",LAST_ACTIVE_TIME:"lastActiveTime",URLS:"urls",DISPATCH:"dispatch",SEARCHINFO:"searchInfo",MD5S:"md5s"},t.REDIS_KEY={SIDS_BOX:"sids:box",PRIDS_QUIT:"prids:quit",PRIDS_CONNECT:"prids:connect",PRIDS_LAST_ACTIVE_TIME:"prids:lastActiveTime",CONNECT_NUM_BOX:"connect:num:box",TOP_CID_LIST_SET_NAME:"topCIDListKey",TOP_AID_LIST_SET_NAME:"topAIDListKey",ENABLED_CID_LIST_SET_NAME:"enabledCIDListKey",MD5_RESOURCES:"md5:resources",MD5_INVALID:"md5:invalid"},t.DEVICE_TYPE={BROWSER:0,BOX:1,AUTO_HOT_PUSH:2,RESOURCE_MD5_VOTE:3},t.HOT_PUSH_FROM={HAND_HOT_PUSH:1,AUTO_HOT_PUSH:2,EM_HOT_PUSH:3,EXTRA_HOT_PUSH:4,BOX_HOT_PUSH:5},t.OPERATION={UPDATE:1,ADD:2,REMOVE:3},t.RUNTIME_MODE={PROD:"production",DEV:"development",PRE:"preliminary"},t.RTC_LOAD_TYPE={SEND:1,GET:2},t.RATIO_MAP={H264:.75,H265:.25,STANDARD:.75,UNSTANDARD:.25},t.CLEAR_MAP={V_1080P:2656,V_720P:1200,V_480P:500,V_1080PP:652,V_360P:200,V_1080P60:322},t.CODE_RATIO_MAP=[{code:"30011",msg:"360P-h265",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H265},{code:"30015",msg:"360P-h264-非标准",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H264*t.RATIO_MAP.UNSTANDARD},{code:"30016",msg:"360P-h264-标准",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H264*t.RATIO_MAP.STANDARD},{code:"30033",msg:"480P-h265",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H265},{code:"30029",msg:"480P-h264-非标准",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H264*t.RATIO_MAP.UNSTANDARD},{code:"30032",msg:"480P-h264-标准",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H264*t.RATIO_MAP.STANDARD},{code:"30066",msg:"720P-h265",ratio:t.CLEAR_MAP.V_720P*t.RATIO_MAP.H265},{code:"30064",msg:"720P-h264",ratio:t.CLEAR_MAP.V_720P*t.RATIO_MAP.H264},{code:"30077",msg:"1080P-h265",ratio:t.CLEAR_MAP.V_1080P*t.RATIO_MAP.H265},{code:"30080",msg:"1080P-h264",ratio:t.CLEAR_MAP.V_1080P*t.RATIO_MAP.H264},{code:"30102",msg:"1080PP-h265",ratio:t.CLEAR_MAP.V_1080PP*t.RATIO_MAP.H265},{code:"30112",msg:"1080PP-h264",ratio:t.CLEAR_MAP.V_1080PP*t.RATIO_MAP.H264},{code:"30106",msg:"1080P60-h265",ratio:t.CLEAR_MAP.V_1080P60*t.RATIO_MAP.H265},{code:"30116",msg:"1080P60-h264",ratio:t.CLEAR_MAP.V_1080P60*t.RATIO_MAP.H264}],t.DISTRIBUTION_BASEURL="/data/distribution/",t.DISTRIBUTION_LASTPUSH_KEY="distribution:lastpush:count"},function(e,t){var r=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,n=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];e.exports=function(e){var t,i,o=e,s=e.indexOf("["),a=e.indexOf("]");-1!=s&&-1!=a&&(e=e.substring(0,s)+e.substring(s,a).replace(/:/g,";")+e.substring(a,e.length));for(var c,u,l=r.exec(e||""),d={},h=14;h--;)d[n[h]]=l[h]||"";return-1!=s&&-1!=a&&(d.source=o,d.host=d.host.substring(1,d.host.length-1).replace(/;/g,":"),d.authority=d.authority.replace("[","").replace("]","").replace(/;/g,":"),d.ipv6uri=!0),d.pathNames=(t=d.path,i=t.replace(/\/{2,9}/g,"/").split("/"),"/"!=t.substr(0,1)&&0!==t.length||i.splice(0,1),"/"==t.substr(t.length-1,1)&&i.splice(i.length-1,1),i),d.queryKey=(c=d.query,u={},c.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,r){t&&(u[t]=r)})),u),d}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Manager=void 0;const n=r(46),i=r(31),o=r(5),s=r(18),a=r(33),c=r(57),u=r(4)("socket.io-client:manager");t.Manager=class extends o{constructor(e,t){super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new c({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const r=t.parser||s;this.encoder=new r.Encoder,this.decoder=new r.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(u("readyState %s",this._readyState),~this._readyState.indexOf("open"))return this;u("opening %s",this.uri),this.engine=n(this.uri,this.opts);const t=this.engine,r=this;this._readyState="opening",this.skipReconnect=!1;const i=a.on(t,"open",(function(){r.onopen(),e&&e()})),o=a.on(t,"error",t=>{u("error"),r.cleanup(),r._readyState="closed",super.emit("error",t),e?e(t):r.maybeReconnectOnOpen()});if(!1!==this._timeout){const e=this._timeout;u("connect attempt will timeout after %d",e),0===e&&i();const r=setTimeout(()=>{u("connect attempt timed out after %d",e),i(),t.close(),t.emit("error",new Error("timeout"))},e);this.subs.push((function(){clearTimeout(r)}))}return this.subs.push(i),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){u("open"),this.cleanup(),this._readyState="open",super.emit("open");const e=this.engine;this.subs.push(a.on(e,"ping",this.onping.bind(this)),a.on(e,"data",this.ondata.bind(this)),a.on(e,"error",this.onerror.bind(this)),a.on(e,"close",this.onclose.bind(this)),a.on(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){super.emit("ping")}ondata(e){this.decoder.add(e)}ondecoded(e){super.emit("packet",e)}onerror(e){u("error",e),super.emit("error",e)}socket(e,t){let r=this.nsps[e];return r||(r=new i.Socket(this,e,t),this.nsps[e]=r),r}_destroy(e){const t=Object.keys(this.nsps);for(const e of t)if(this.nsps[e].active)return void u("socket %s is still active, skipping close",e);this._close()}_packet(e){u("writing packet %j",e);const t=this.encoder.encode(e);for(let r=0;r<t.length;r++)this.engine.write(t[r],e.options)}cleanup(){u("cleanup"),this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){u("disconnect"),this.skipReconnect=!0,this._reconnecting=!1,"opening"===this._readyState&&this.cleanup(),this.backoff.reset(),this._readyState="closed",this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e){u("onclose"),this.cleanup(),this.backoff.reset(),this._readyState="closed",super.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)u("reconnect failed"),this.backoff.reset(),super.emit("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();u("will wait %dms before reconnect attempt",t),this._reconnecting=!0;const r=setTimeout(()=>{e.skipReconnect||(u("attempting reconnect"),super.emit("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open(t=>{t?(u("reconnect attempt error"),e._reconnecting=!1,e.reconnect(),super.emit("reconnect_error",t)):(u("reconnect success"),e.onreconnect())}))},t);this.subs.push((function(){clearTimeout(r)}))}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),super.emit("reconnect",e)}}},function(e,t,r){const n=r(26),i=r(49),o=r(53),s=r(54);t.polling=function(e){let t,r=!1,s=!1;const a=!1!==e.jsonp;if("undefined"!=typeof location){const t="https:"===location.protocol;let n=location.port;n||(n=t?443:80),r=e.hostname!==location.hostname||n!==e.port,s=e.secure!==t}if(e.xdomain=r,e.xscheme=s,t=new n(e),"open"in t&&!e.forceJSONP)return new i(e);if(!a)throw new Error("JSONP disabled");return new o(e)},t.websocket=s},function(e,t,r){const n=r(48),i=r(14);e.exports=function(e){const t=e.xdomain,r=e.xscheme,o=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||n))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!r&&o)return new XDomainRequest}catch(e){}if(!t)try{return new(i[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}},function(e,t,r){const n=r(16),i=r(17),o=r(11),s=r(29),a=r(4)("engine.io-client:polling");e.exports=class extends n{get name(){return"polling"}doOpen(){this.poll()}pause(e){const t=this;function r(){a("paused"),t.readyState="paused",e()}if(this.readyState="pausing",this.polling||!this.writable){let e=0;this.polling&&(a("we are currently polling - waiting to pause"),e++,this.once("pollComplete",(function(){a("pre-pause polling complete"),--e||r()}))),this.writable||(a("we are currently writing - waiting to pause"),e++,this.once("drain",(function(){a("pre-pause writing complete"),--e||r()})))}else r()}poll(){a("polling"),this.polling=!0,this.doPoll(),this.emit("poll")}onData(e){const t=this;a("polling got data %s",e),o.decodePayload(e,this.socket.binaryType).forEach((function(e,r,n){if("opening"===t.readyState&&"open"===e.type&&t.onOpen(),"close"===e.type)return t.onClose(),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():a('ignoring poll - transport state "%s"',this.readyState))}doClose(){const e=this;function t(){a("writing close packet"),e.write([{type:"close"}])}"open"===this.readyState?(a("transport open - closing"),t()):(a("transport not open - deferring close"),this.once("open",t))}write(e){this.writable=!1,o.encodePayload(e,e=>{this.doWrite(e,()=>{this.writable=!0,this.emit("drain")})})}uri(){let e=this.query||{};const t=this.opts.secure?"https":"http";let r="";return!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=s()),this.supportsBinary||e.sid||(e.b64=1),e=i.encode(e),this.opts.port&&("https"===t&&443!==Number(this.opts.port)||"http"===t&&80!==Number(this.opts.port))&&(r=":"+this.opts.port),e.length&&(e="?"+e),t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+r+this.opts.path+e}}},function(e,t){const r=Object.create(null);r.open="0",r.close="1",r.ping="2",r.pong="3",r.message="4",r.upgrade="5",r.noop="6";const n=Object.create(null);Object.keys(r).forEach(e=>{n[r[e]]=e}),e.exports={PACKET_TYPES:r,PACKET_TYPES_REVERSE:n,ERROR_PACKET:{type:"error",data:"parser error"}}},function(e,t,r){"use strict";var n,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),o={},s=0,a=0;function c(e){var t="";do{t=i[e%64]+t,e=Math.floor(e/64)}while(e>0);return t}function u(){var e=c(+new Date);return e!==n?(s=0,n=e):e+"."+c(s++)}for(;a<64;a++)o[i[a]]=a;u.encode=c,u.decode=function(e){var t=0;for(a=0;a<e.length;a++)t=64*t+o[e.charAt(a)];return t},e.exports=u},function(e,t){e.exports.pick=(e,...t)=>t.reduce((t,r)=>(e.hasOwnProperty(r)&&(t[r]=e[r]),t),{})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=void 0;const n=r(18),i=r(5),o=r(33),s=r(4)("socket.io-client:socket"),a=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});t.Socket=class extends i{constructor(e,t,r){super(),this.receiveBuffer=[],this.sendBuffer=[],this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},r&&r.auth&&(this.auth=r.auth),this.io._autoConnect&&this.open()}subEvents(){if(this.subs)return;const e=this.io;this.subs=[o.on(e,"open",this.onopen.bind(this)),o.on(e,"packet",this.onpacket.bind(this)),o.on(e,"error",this.onerror.bind(this)),o.on(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(a.hasOwnProperty(e))throw new Error('"'+e+'" is a reserved event name');t.unshift(e);const r={type:n.PacketType.EVENT,data:t,options:{}};r.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(s("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),r.id=this.ids++);const i=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return!this.flags.volatile||i&&this.connected?this.connected?this.packet(r):this.sendBuffer.push(r):s("discard packet as the transport is not currently writable"),this.flags={},this}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){s("transport is open - connecting"),"function"==typeof this.auth?this.auth(e=>{this.packet({type:n.PacketType.CONNECT,data:e})}):this.packet({type:n.PacketType.CONNECT,data:this.auth})}onerror(e){this.connected||super.emit("connect_error",e)}onclose(e){s("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,super.emit("disconnect",e)}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case n.PacketType.CONNECT:if(e.data&&e.data.sid){const t=e.data.sid;this.onconnect(t)}else super.emit("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case n.PacketType.EVENT:case n.PacketType.BINARY_EVENT:this.onevent(e);break;case n.PacketType.ACK:case n.PacketType.BINARY_ACK:this.onack(e);break;case n.PacketType.DISCONNECT:this.ondisconnect();break;case n.PacketType.CONNECT_ERROR:const t=new Error(e.data.message);t.data=e.data.data,super.emit("connect_error",t)}}onevent(e){const t=e.data||[];s("emitting event %j",t),null!=e.id&&(s("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const r of t)r.apply(this,e)}super.emit.apply(this,e)}ack(e){const t=this;let r=!1;return function(...i){r||(r=!0,s("sending ack %j",i),t.packet({type:n.PacketType.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];"function"==typeof t?(s("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):s("bad ack %s",e.id)}onconnect(e){s("socket connected with id %s",e),this.id=e,this.connected=!0,this.disconnected=!1,super.emit("connect"),this.emitBuffered()}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>this.packet(e)),this.sendBuffer=[]}ondisconnect(){s("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&(s("performing disconnect (%s)",this.nsp),this.packet({type:n.PacketType.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let r=0;r<t.length;r++)if(e===t[r])return t.splice(r,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasBinary=t.isBinary=void 0;const n="function"==typeof ArrayBuffer,i=Object.prototype.toString,o="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===i.call(Blob),s="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===i.call(File);function a(e){return n&&(e instanceof ArrayBuffer||(e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer)(e))||o&&e instanceof Blob||s&&e instanceof File}t.isBinary=a,t.hasBinary=function e(t,r){if(!t||"object"!=typeof t)return!1;if(Array.isArray(t)){for(let r=0,n=t.length;r<n;r++)if(e(t[r]))return!0;return!1}if(a(t))return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return e(t.toJSON(),!0);for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)&&e(t[r]))return!0;return!1}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.on=void 0,t.on=function(e,t,r){return e.on(t,r),function(){e.off(t,r)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBController=void 0;const n=r(0),i=n.__importDefault(r(6)),o=n.__importDefault(r(62)),s=n.__importDefault(r(8)),a=n.__importDefault(r(15)),c=n.__importDefault(r(3)),u=n.__importDefault(r(12)),l=n.__importDefault(r(13)),d=n.__importDefault(r(2)),h=r(19),f=r(63),p=r(7),m=r(35);class g extends o.default{constructor(e,t,r){super("BP_CD_V3"),this.promiseQueue=r,this.enableEncryption=!0,this.events=new l.default,this.intervalCheckTotalSizeTimer=0,this.reportTimerList=[],this.maxReportSlices=500,this.needDeleteDBNames=["bilibiliPlayerCacheData","BP_CD_V2"],this.updateLocalStorageTimer=null,this.enableReport=!1,this.hasSavedResources=[],this.DFARes={state:"ready"},this.needDeleteDBNames.forEach(e=>g.deleteDB(e).catch(()=>p.DBUtils.warn(`老数据库${e}删除失败`))),this.socketController=t,this.dbStat=e.state.dbStat,this.sdk=e}initSaving(){if(this.judgeEnableEncryption(),!this.isOpen()){try{this.version(3).stores({resource:"id, [rid+id+rangeArr+lastUpdatedTime+priority], lastUpdatedTime, priority, rangeArr"})}catch(e){"Cannot add version when database is open"===e.message&&(this.close(),this.version(3).stores({resource:"id, [rid+id+rangeArr+lastUpdatedTime+priority], lastUpdatedTime, priority, rangeArr"}))}Object.defineProperties(this,{resourceTable:{value:this.resource,enumerable:!1,writable:!1}}),this.resourceTable.mapToClass(m.ResourceDocument),this.promiseQueue.enqueue(()=>this.refreshDBState(!0).then(()=>this.forceCheckTotalSize()).catch(()=>this.sdk.disableSaveDataByDB=!0),!0),this.intervalRefreshDBState(),d.default.onBeforeUnload(this.beforeUnload.bind(this,this.sdk.saveDataToken))}}initDFA(){this.stateHandlerMap=[["ready",this.dbState.checkExceedDBMax.bind(this.dbState)],["overDBMax",this.delAndSave.bind(this)],["lessThanDBMax",this.dbState.checkRidExistence.bind(this.dbState)],["hasRid",this.dbState.checkIDExistence.bind(this.dbState)],["hasRidAndID",this.dbState.checkSliceExistence.bind(this.dbState)],["hasRidAndIDNotSlice",this.saveSlice.bind(this)],["hasRidAndIDAndSlice",e=>({code:43005,rid:e.rid,rangeArr:[e.range],byteLength:0,state:"finished"})],["hasRidNotID",this.saveIDAndSlice.bind(this)],["notHavingRid",this.dbState.checkExceedRidMax.bind(this.dbState)],["overRidMax",this.delAndSave.bind(this)],["lessThanRidMax",this.saveRidAndSlice.bind(this)]].reduce((e,[t,r])=>e.set(t,r),new Map)}interpretDFA(e,t){return n.__awaiter(this,void 0,void 0,(function*(){this.DFARes={state:t};let r=0;for(;"finished"!==this.DFARes.state;)if(p.DBUtils.log(this.DFARes),this.DFARes=yield this.stateHandlerMap.get(this.DFARes.state)(e),r++>50)throw new h.DBError(43020,"DFA 死循环了");return this.DFARes}))}initReport(){this.promiseQueue.enqueue(()=>this.report(2).then(({resources:e,totalSize:t,savedRidNum:r})=>{const n={type:a.default.TRACK_TYPE.REPORT_RESOURCE,version:s.default.getInstance().version,savedBytes:t||0,savedRids:r||0,savedSlices:(null==e?void 0:e.reduce((e,t)=>{var r;return e+(null===(r=t.rangeArr)||void 0===r?void 0:r.length)},0))||0};u.default.getInstance().trigger(c.default.TRACK,n),p.DBUtils.sLog("让存又让报, 上报所有资源信息给track埋点",n)}).catch(()=>this.sdk.state.dbStat.reportFailure++)),this.intervalReport(),this.NCOn(c.default.SOCKET_DISCONNECT,this.removeReportTimer)}saveResource(e){return n.__awaiter(this,void 0,void 0,(function*(){switch(!0){case!e:throw new h.DBError(43018,"没传saving resource");case!this.sdk.saveDataEnabled:throw new h.DBError(43019,"存储功能被禁了");case!this.dbState:case!this.stateHandlerMap:throw new h.DBError(43017,"数据库还没初始化好")}return this.enableEncryption&&".nc"!==e.rid.slice(-3)&&(e.rid=p.DBUtils.encode(e.rid)),this.timestamp=Date.now(),p.DBUtils.log("start saving resource"),this.interpretDFA(e,"ready")}))}intervalReport(){this.enableReport&&(void 0!==this.intervalReportTimer&&window.clearInterval(this.intervalReportTimer),this.intervalReportTimer=window.setInterval(()=>{this.promiseQueue.enqueue(()=>this.report(2,this.hasSavedResources),!0)},3e4))}delAndSave(e){return n.__awaiter(this,void 0,void 0,(function*(){const t=this.dbState.findCanDeleteRids();if(p.DBUtils.log("canDeletedRidsOrMs","number"==typeof t?"关闭sdk存储"+p.DBUtils.formatMs(t):"可以删除的rid: "+t),"number"==typeof t)throw this.sdk.disableSaveDataByDB=!0,this.disableTimer&&window.clearTimeout(this.disableTimer),this.disableTimer=window.setTimeout(()=>{this.sdk.disableSaveDataByDB=!1},t),this.dbStat.deleteFailureForAllBelow24h++,new h.DBError(43004,"所有rid最近更新时间都小于24h, 关闭sdk存储"+p.DBUtils.formatMs(t));const r=this.dbState.getPriorityArr(t),n=yield this.del(r);return p.DBUtils.happyLog("删除成功!",n),this.promiseQueue.enqueue(()=>this.report(3,n),!0),this.saveResource(e)}))}del(e){return n.__awaiter(this,void 0,void 0,(function*(){for(const t of e){const e=this.resourceTable.where({rid:t.rid}),r=this.dbState.selectByRid(t.rid);try{return yield e.delete(),this.dbState.delete("rid",t.rid),r.map(e=>Object.assign({code:43013,byteLength:p.DBUtils.getSizeFromRangeArr(e.rangeArr)},e))}catch(e){continue}}throw new h.DBError(43014,"删除可删除资源失败")}))}saveSlice(e){return n.__awaiter(this,void 0,void 0,(function*(){const{rid:t,range:r,data:n}=e,i=p.DBUtils.getRangeMB(r).rangeMB,o=n.byteLength,s=`${t}:${i}`;if(0===(yield this.resourceTable.where({id:s}).modify(e=>{e.slices=Object.assign(Object.assign({},e.slices),{[r]:n}),e.rangeArr=[...e.rangeArr||[],r],e.lastUpdatedTime=this.timestamp})))throw new h.DBError(43021,"indexedDB Modified Num equals zero");return this.dbState.updateState(s,e=>{e.rangeArr.push(r),e.lastUpdatedTime=this.timestamp}),{rid:p.DBUtils.decode(t),byteLength:o,rangeArr:[r],code:43012,state:"finished"}}))}saveNewDocument(e,t){return n.__awaiter(this,void 0,void 0,(function*(){const{rid:r,range:n,data:i}=e,o=p.DBUtils.getRangeMB(n).rangeMB,s=`${r}:${o}`;if(this.dbState.selectById(s))return this.saveSlice(e);const a=new m.ResourceDocument(s,r,this.timestamp).addSlice(n,i);return yield this.resourceTable.add(a),this.dbState.updateState(s,e=>{e.id=s,e.lastUpdatedTime=this.timestamp,e.priority=-1,e.rangeArr=[n],e.rid=r}),Object.assign(Object.assign({code:"lessThanRidMax"===t?43011:43022},a.slice()),{state:"finished"})}))}saveRidAndSlice(e){return this.saveNewDocument(e,"lessThanRidMax")}saveIDAndSlice(e){return this.saveNewDocument(e,"hasRidNotID")}refreshDBState(e=!1){return n.__awaiter(this,void 0,void 0,(function*(){const t=yield this.getSavedResource(["id","rid","rangeArr","priority","lastUpdatedTime"]);this.dbState=new f.DBState(t),e&&this.initDFA()}))}intervalRefreshDBState(){window.setInterval(()=>{this.promiseQueue.enqueue(()=>this.refreshDBState().then(()=>this.forceCheckTotalSize()).catch(()=>this.sdk.disableSaveDataByDB=!0),!0)},3e5)}forceCheckTotalSize(){return n.__awaiter(this,void 0,void 0,(function*(){if(!this.dbState)return void(this.sdk.disableSaveDataByDB=!0);const e=this.dbState.getAllSize();if(!(e<=p.DBUtils.dbMaxSize)){this.hasSavedResources.length=0;try{yield this.forceDel(e)}catch(e){p.DBUtils.warn("强制删除出错",e),this.sdk.disableSaveDataByDB=!0}}}))}forceDel(e){return n.__awaiter(this,void 0,void 0,(function*(){const t=this.dbState.getPriorityArr();if(p.DBUtils.log("强制删除获取优先级数组成功",t),!t.length)return e;const r=[];for(const n of t)if(r.push(n),(e-=p.DBUtils.getSizeFromRangeArr(n.rangeArr))<=p.DBUtils.dbMaxSize)break;const n=r.map(e=>e.id);return yield this.resourceTable.bulkDelete(n),this.dbState.delete("id",n),p.DBUtils.happyLog("强制删除成功",r),this.promiseQueue.enqueue(()=>this.report(3,r),!0),e<0?0:e}))}report(e,t){var r,i,o;return n.__awaiter(this,void 0,void 0,(function*(){if(!this.enableReport||!this.sdk.saveDataEnabled)return;if(3===e){const[e,n]=[p.DBUtils.transformResource,p.DBUtils.getSizeFromResources].map(e=>e(t));return null===(r=this.socketController)||void 0===r||r.reportResource(3,e,n),void p.DBUtils.happyLog("删除的资源上报成功了",e)}if(!t){const e=(null===(i=this.dbState)||void 0===i?void 0:i.selectAll(["id","rangeArr"]))||(yield this.getSavedResource(["id","rangeArr"])),t=[],r=new Set;for(const{id:n,rangeArr:i}of e){const[e,o]=n.split(":"),s=p.DBUtils.decode(e);t.push({id:s+":"+o,rangeArr:i}),r.add(s)}return this.splitReport(t),{resources:t,savedRidNum:r.size,totalSize:p.DBUtils.getSizeFromResources(e)}}const[n,s]=[p.DBUtils.transformResource,p.DBUtils.getSizeFromResources].map(e=>e(t));null===(o=this.socketController)||void 0===o||o.reportResource(2,n,s),n.length&&p.DBUtils.happyLog("30s之期已到, 定时上报成功!",n),this.hasSavedResources=[]}))}splitReport(e,t=!0){var r;this.reportTimerList.delayTime=0;for(let n=0;n<e.length;++n){if(e[n].rangeArr.length>this.maxReportSlices){this.handleBigResources(e,e[n],t),t=!1;continue}let i=e[n].rangeArr.length,o=n;for(let t=n+1;t<e.length&&e[t].rangeArr.length+i<=this.maxReportSlices;++t)i+=e[t].rangeArr.length,o=t;const s=e.slice(n,o+1);if(t)null===(r=this.socketController)||void 0===r||r.reportResource(2,s,p.DBUtils.getSizeFromResources(s)),p.DBUtils.sLog("第一批上报给tracker的资源",s);else{const e=this.getReportRandomTime()+this.reportTimerList.delayTime;this.reportTimerList.delayTime=e,this.reportTimerList.push(window.setTimeout(()=>{var e;null===(e=this.socketController)||void 0===e||e.reportResource(2,s,p.DBUtils.getSizeFromResources(s)),p.DBUtils.sLog("分批次上报成功",s)},e))}t=!1,n=o}}handleBigResources(e,t,r){var n;if(r){const r=t.rangeArr,i=[{id:t.id,rangeArr:r.slice(0,this.maxReportSlices)}];return null===(n=this.socketController)||void 0===n||n.reportResource(2,i,p.DBUtils.getSizeFromRangeArr(i[0].rangeArr)),e.push({id:t.id,rangeArr:r.slice(this.maxReportSlices,r.length)}),void p.DBUtils.sLog("第一批上报给tracker的资源",i)}const i=this.getReportRandomTime()+this.reportTimerList.delayTime;this.reportTimerList.delayTime=i;const o=t.rangeArr,s=[{id:t.id,rangeArr:o.slice(0,this.maxReportSlices)}];this.reportTimerList.push(window.setTimeout(()=>{var e;null===(e=this.socketController)||void 0===e||e.reportResource(2,s,p.DBUtils.getSizeFromRangeArr(s[0].rangeArr)),p.DBUtils.sLog("分批次上报成功!",s)},i)),e.push({id:t.id,rangeArr:o.slice(this.maxReportSlices,o.length)})}getReportRandomTime(){return Math.floor(3e3*Math.random()+2e3)}removeReportTimer(){var e;null===(e=this.reportTimerList)||void 0===e||e.forEach(e=>e&&window.clearTimeout(e)),this.reportTimerList=[]}getResource(e,t,r){return n.__awaiter(this,void 0,void 0,(function*(){const n=Date.now(),{rangeMB:i,rangeStart:o,rangeEnd:s}=p.DBUtils.getRangeMB(t);this.enableEncryption&&(e=p.DBUtils.encode(e));const a=e+":"+i,c=yield this.resourceTable.get(a);if(!c)throw new h.DBError(43007,"获取资源时没有该资源");if(r)return{getResourceTime:(Date.now()-n)/1e3,responseData:c.slices};let u;if(u=Object.keys(c.slices).find(e=>p.DBUtils.isContainRange(e,o,s))){if(u===t)return{getResourceTime:(Date.now()-n)/1e3,responseData:c.slices[u]};const e=p.DBUtils.parseRange(u)[0];return{getResourceTime:(Date.now()-n)/1e3,responseData:c.slices[u].slice(o-e,s-e+1)}}throw new h.DBError(43007,"获取资源时没有该资源")}))}destroy(){var e,t;this.sdk.saveDataEnabled&&this.beforeUnload(this.sdk.saveDataToken),void 0!==this.intervalReportTimer&&window.clearInterval(this.intervalReportTimer),void 0!==this.disableTimer&&window.clearTimeout(this.disableTimer),null!==this.updateLocalStorageTimer&&window.clearTimeout(this.updateLocalStorageTimer),this.intervalCheckTotalSizeTimer&&window.clearInterval(this.intervalCheckTotalSizeTimer),(null===(e=this.reportTimerList)||void 0===e?void 0:e.length)&&(this.reportTimerList.forEach(e=>window.clearTimeout(e)),this.reportTimerList=[]),this.off(c.default.SOCKET_DISCONNECT,this.removeReportTimer),this.events&&(this.events.destroy(),this.events=null),null===(t=this.dbState)||void 0===t||t.destroy()}beforeUnload(e){const t=p.DBUtils.getSaveRestriction(),r=Object.keys(t).find(r=>{var n;return t[r].token===((null===(n=this.sdk)||void 0===n?void 0:n.saveDataToken)||e)});delete t[r],d.default.setLocalStorage(p.DBUtils.SAVE_RESTRICTION,t)}judgeEnableEncryption(){const{enableEncryption:e}=p.DBUtils.getBPNCConfig();this.enableEncryption=!!e}getSavedResource(e,t){return n.__awaiter(this,void 0,void 0,(function*(){const r={rid:0,id:1,rangeArr:2,lastUpdatedTime:3,priority:4},n=[];t||(t=yield this.resourceTable.orderBy("rid").uniqueKeys());for(const i of t){const t=yield this.resourceTable.where("[rid+id+rangeArr+lastUpdatedTime+priority]").between([i,o.default.minKey,o.default.minKey,o.default.minKey,o.default.minKey],[i,o.default.maxKey,o.default.maxKey,o.default.maxKey,o.default.maxKey]).keys(t=>t.map(t=>e.reduce((e,n)=>Object.assign(Object.assign({},e),{[n]:t[r[n]]}),{})));n.push(...t)}return n}))}getSavedStats(){return n.__awaiter(this,void 0,void 0,(function*(){const e=yield this.getSavedResource(["rid","rangeArr"]);return{savedSlices:e.reduce((e,t)=>e+t.rangeArr.length,0),savedBytes:e.reduce((e,t)=>e+p.DBUtils.getSizeFromRangeArr(t.rangeArr),0),savedRids:e.reduce((e,t)=>e.add(t.rid),new Set).size}}))}NCOn(e,t){var r;null===(r=this.events)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.events)||void 0===r||r.off(e,t)}trigger(e,...t){var r;null===(r=this.events)||void 0===r||r.trigger(e,...t)}static deleteDB(e){return super.delete(e)}static isWriteResourceRes(e,t=!1){return Array.isArray(e)?t?e.every(e=>void 0!==e.byteLength):void 0!==e[0].byteLength:void 0!==e.byteLength}}n.__decorate([p.DBUtils.trackComplete({failure:["deleteFailure"],success:["deleteRids","deleteSuccess",["deleteBytes",e=>p.DBUtils.getSizeFromResources(e)],["deleteSlices",e=>e.reduce((e,t)=>e+t.rangeArr.length,0)]]}),p.DBUtils.transaction("rw",["resource"],"删除某个rid的所有分片")],g.prototype,"del",null),n.__decorate([p.DBUtils.waitingForReport,p.DBUtils.updateLocalStorage,p.DBUtils.trackComplete({failure:["saveSliceFailure"],success:["saveSlices",["saveBytes",e=>e.byteLength]]}),p.DBUtils.transaction("rw",["resource"],"存储分片")],g.prototype,"saveSlice",null),n.__decorate([p.DBUtils.waitingForReport,p.DBUtils.updateLocalStorage,p.DBUtils.trackComplete({failure:["saveRidAndSliceFailure"],success:["saveRids","saveSlices",["saveBytes",e=>e.byteLength]]})],g.prototype,"saveRidAndSlice",null),n.__decorate([p.DBUtils.waitingForReport,p.DBUtils.updateLocalStorage,p.DBUtils.trackComplete({failure:["saveIDAndSliceFailure"],success:["saveSlices",["saveBytes",e=>e.byteLength]]})],g.prototype,"saveIDAndSlice",null),n.__decorate([p.DBUtils.transaction("r",["resource"],"初始化dbState")],g.prototype,"refreshDBState",null),n.__decorate([p.DBUtils.transaction("rw",["resource"],"强制删除")],g.prototype,"forceDel",null),n.__decorate([i.default],g.prototype,"removeReportTimer",null),n.__decorate([p.DBUtils.trackComplete({failure:["getResourceFailure"],success:["getResourceSuccess"]}),p.DBUtils.timeout(1e3),p.DBUtils.transaction("r",["resource"],"从resourceTable中获取指定rid和range的资源",43008)],g.prototype,"getResource",null),n.__decorate([i.default],g.prototype,"destroy",null),n.__decorate([i.default],g.prototype,"beforeUnload",null),n.__decorate([p.DBUtils.transaction("r",["resource"],"获取已存储数据")],g.prototype,"getSavedStats",null),t.DBController=g},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AllDocument=t.ResourceDocument=t.BaseDocument=void 0;const n=r(7);class i{constructor(e,t,r){this.id=e,this.rid=t,this.lastUpdatedTime=r}setLastUpdatedTime(e){return this.lastUpdatedTime=e,this}setID(e){return this.id=e,this}}t.BaseDocument=i,t.ResourceDocument=class extends i{constructor(e,t,r){super(e,t,r),this.priority=-1,this.slices={},this.rangeArr=[]}getSize(){return Object.keys(this.slices).reduce((e,t)=>e+this.slices[t].byteLength,0)}slice(){return{id:n.DBUtils.decode(this.rid)+":"+this.id.split(":")[1],rid:n.DBUtils.decode(this.rid),rangeArr:this.rangeArr,byteLength:this.getSize()}}addSlice(e,t){return this.slices[e]=t,this.rangeArr.push(e),this}static isResourceDocument(e,t=!1){return Array.isArray(e)?!0===t?e.every(e=>e.id&&e.rid&&e.rangeArr&&e.slices):e[0].id&&e[0].rid&&e[0].rangeArr&&e[0].slices:e.id&&e.rid&&e.rangeArr&&e.slices}},t.AllDocument=class extends i{constructor(e,t,r,n){super(e,t,r),void 0!==n&&(this.dbTotalSize=n)}setDbTotalSize(e){return this.dbTotalSize=e,this}getSize(){return this.dbTotalSize}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.track=void 0,t.track=new class{constructor(){this.getData={useP2P:0,useP2PSuccess:0},this.reset()}reset(){this.getDataStat={useP2P:0,useP2PSuccess:0,useP2PFileReaderError:0,useP2PWebRTCOpenTimeout:0,useP2PWebRTCOpenTimeoutByNoLDP:0,useP2PWebRTCOpenTimeoutByNoRDP:0,useP2PWebRTCOpenTimeoutByNoRC:0,useP2PWebRTCOpenTimeoutByNoACS:0,useP2PWebRTCFail:0,useP2PNoSCFail:0,useP2PFromBrowser:0,useP2PFromBox:0},this.rtcStat={offerInitToBrowser:0,getSuccessFromBrowser:0,offerDataChannelOpenToBrowser:0,answerInit:0,answerDataChannelOpen:0,sendSuccess:0,getDataFromDBSuccess:0,getDataFromDBFail:0,sendBytes:0,sendSuccessBytes:0,receivedByteTotal:0,receivedByteFromBrowser:0,receivedByteFromBox:0,receivedOffer:0,receivedGetData:0,sendFinished:0,offerAccepted:0,receivedCandidate3:0,receivedCandidate2:0,receivedCandidate1:0,addCandidateTooEarly:0,setRemoteDescErr:0,setLocalDescErr:0,createAnswerErr:0,noDonationPeer:0,successiveBrowserPeerNotOpen:0},this.dbStat={saveSuccess:0,saveFailure:0,saveRidAndSliceFailure:0,saveIDAndSliceFailure:0,saveSliceFailure:0,reportTotalSize:0,reportFailure:0,reportSuccess:0,deleteFailureForAllBelow24h:0,deleteFailure:0,deleteRids:0,deleteBytes:0,deleteSlices:0,deleteSuccess:0,saveRids:0,savedRids:0,saveSlices:0,savedSlices:0,saveBytes:0,savedBytes:0,saveCount:0,exceedingDBTotalSize:0,exceedingRidMax:0,getResourceFailure:0,getResourceSuccess:0,havingRidNotSlice:0,havingRidAndSlice:0,notHavingRid:0,saveAllDocFailure:0}}destroy(){this.getData={useP2P:0,useP2PSuccess:0}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCBase=void 0;const n=r(0),i=n.__importDefault(r(6)),o=r(9),s=n.__importDefault(r(13)),a=n.__importDefault(r(1)),c=n.__importDefault(r(2));class u{constructor(e,t,r,n,i){this.isSameIP=!1,this.maxMessageSize=64e3,this.isDestroyed=!1,this.isOpen=!1,this.hasLocalDescription=!1,this.hasRemoteDescription=!1,this.hasReceivedRemoteCandidate=!1,this.hasAddCandidateSuccess=!1,this.hasReceivedLocalCandidate=!1,this.storedCandidates=[],this.events=new s.default,this.sdk=e,this.socketController=t,this.cPeerSocketID=r,this.isSameIP=n,this.path=i,this.peerTarget=c.default.getPeerTarget(r),this.rtcStat=this.sdk.state.rtcStat}init(){let e=["stun:web-player-tracker.biliapi.net:3478"];"hw"===this.sdk.fawkesConfig.vendor&&(e=["stun:hw-web-player-tracker.biliapi.net:3478"]);let t=Object.assign({iceServers:[{urls:e}]},"seeder"===this.identity?{iceCandidatePoolSize:1}:void 0);this.peerConnection=new RTCPeerConnection(t),this.peerConnection.onicecandidate=e=>{var t,r;if(!this.dataChannel||"connecting"===(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState))if(e.candidate){if("seeder"===this.identity&&(this.hasReceivedLocalCandidate=!0),this.filterIceCandidate(e.candidate))return;const t=o.createMessage("candidate",Object.assign({data:JSON.stringify(e.candidate),rid:this.path,s:Number("seeder"===this.identity)},"box"===this.peerTarget?void 0:{_test:1}));null===(r=this.socketController)||void 0===r||r.sendMessage(this.cPeerSocketID,t),a.default.getInstance().log("--------onicecandidate",this.cPeerSocketID,t)}else a.default.getInstance().log(`End of candidates, cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}}onSetRemoteDescription(){var e;"seeder"===this.identity&&(null===(e=this.socketController)||void 0===e||e.reportStatToTracker("addCandidateAfterRD")),this.storedCandidates.forEach(e=>this.addIcecandidate(e))}filterIceCandidate(e){if(this.isSameIP)return!1;try{if("host"===(null==e?void 0:e.type))return!0}catch(e){a.default.getInstance().warn(this.path+" filterIceCandidate filter error: "+e)}return!1}dataChannelRemoveEvent(){this.dataChannel&&(this.dataChannel.onmessage=null,this.dataChannel.onopen=null,this.dataChannel.onclose=null)}on(e,t){var r;null===(r=this.events)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.events)||void 0===r||r.off(e,t)}trigger(e,...t){var r;null===(r=this.events)||void 0===r||r.trigger(e,...t)}destroy(){var e;"seeder"!==this.identity||this.hasReceivedLocalCandidate||null===(e=this.socketController)||void 0===e||e.reportStatToTracker("destroyedTooEarly"),a.default.getInstance().log(`${this.path} webRTCController destroy -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),this.isDestroyed=!0,this.maxMessageSize=64e3,this.hasLocalDescription=!1,this.hasRemoteDescription=!1,this.hasReceivedRemoteCandidate=!1,this.hasReceivedLocalCandidate=!1,this.hasAddCandidateSuccess=!1,this.storedCandidates=[],this.cPeerSocketID="",this.socketController=null,this.sdk=null,this.dataChannel&&(this.dataChannelRemoveEvent(),this.dataChannel.close(),this.dataChannel=null),this.peerConnection&&(this.peerConnection.ondatachannel=null,this.peerConnection.onicecandidate=null,this.peerConnection.close(),this.peerConnection=null),this.events&&(this.events.destroy(),this.events=null)}get dataChannelState(){var e;return null===(e=this.dataChannel)||void 0===e?void 0:e.readyState}addIcecandidate(e){var t,r;if("open"===(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState))return;this.hasReceivedRemoteCandidate=!0;let n=JSON.parse(e.data),i=new RTCIceCandidate(n);null===(r=this.peerConnection)||void 0===r||r.addIceCandidate(i).then(()=>{this.isDestroyed||(this.hasAddCandidateSuccess=!0)},e=>{this.isDestroyed||a.default.getInstance().warn(`${this.path} webRTCController addIceCandidate error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, error: `+e.toString())}).catch(e=>{this.isDestroyed||a.default.getInstance().warn(`${this.path} webRTCController addIceCandidate error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, error: `+e)})}}n.__decorate([i.default],u.prototype,"onSetRemoteDescription",null),t.WebRTCBase=u},function(e,t,r){"use strict";var n=r(10);function i(e,t,r,i,o){var s=n.writeRtpDescription(e.kind,t);if(s+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":o||"active"),s+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var c="msid:"+(i?i.id:"-")+" "+a+"\r\n";s+="a="+c,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),s}function o(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},i=function(e,t,r,i){var o=n(e.parameters.apt,r),s=n(t.parameters.apt,i);return o&&s&&o.name.toLowerCase()===s.name.toLowerCase()};return e.codecs.forEach((function(n){for(var o=0;o<t.codecs.length;o++){var s=t.codecs[o];if(n.name.toLowerCase()===s.name.toLowerCase()&&n.clockRate===s.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&s.parameters.apt&&!i(n,s,e.codecs,t.codecs))continue;(s=JSON.parse(JSON.stringify(s))).numChannels=Math.min(n.numChannels,s.numChannels),r.codecs.push(s),s.rtcpFeedback=s.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var i=t.headerExtensions[n];if(e.uri===i.uri){r.headerExtensions.push(i);break}}})),r}function s(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function a(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function c(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}e.exports=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function u(t,r,n,i){var o=new Event("track");o.track=r,o.receiver=n,o.transceiver={receiver:n},o.streams=i,e.setTimeout((function(){t._dispatchEvent("track",o)}))}var l=function(r){var i=this,o=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){i[e]=o[e].bind(o)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all"}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced"}if(r.iceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var i="string"==typeof n;return i&&(n=[n]),n=n.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=i?n[0]:n,!!n.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var s=r.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=n.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this._createIceAndDtlsTransports();n.iceTransport=i.iceTransport,n.dtlsTransport=i.dtlsTransport}return t||this.transceivers.push(n),n},l.prototype.addTrack=function(t,r){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(n=this.transceivers[i]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),n.track=t,n.stream=r,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},l.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e)}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled}))})),n.getTracks().forEach((function(e){r.addTrack(e,n)}))}},l.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw c("InvalidAccessError","Sender was not created by this connection.");var n=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r)}))},l.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},l.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},l.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;i.state=r?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},l.prototype._gather=function(t,r){var i=this,o=this.transceivers[r].iceGatherer;if(!o.onlocalcandidate){var s=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,o.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),o.onlocalcandidate=function(e){if(!(i.usingBundle&&r>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:r};var a=e.candidate,c=!a||0===Object.keys(a).length;if(c)"new"!==o.state&&"gathering"!==o.state||(o.state="completed");else{"new"===o.state&&(o.state="gathering"),a.component=1,a.ufrag=o.getLocalParameters().usernameFragment;var u=n.writeCandidate(a);s.candidate=Object.assign(s.candidate,n.parseCandidate(u)),s.candidate.candidate=u,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var l=n.getMediaSections(i._localDescription.sdp);l[s.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",i._localDescription.sdp=n.getDescription(i._localDescription.sdp)+l.join("");var d=i.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),c||i._dispatchEvent("icecandidate",s),d&&(i._dispatchEvent("icecandidate",new Event("icecandidate")),i.iceGatheringState="complete",i._emitGatheringStateChange())}},e.setTimeout((function(){s.forEach((function(e){o.onlocalcandidate(e)}))}),0)}},l.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var n=new e.RTCDtlsTransport(r);return n.ondtlsstatechange=function(){t._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:n}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport)},l.prototype._transceive=function(e,r,i){var s=o(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:n.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),i&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s))},l.prototype.setLocalDescription=function(e){var t,r,i=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!s("setLocalDescription",e.type,i.signalingState)||i._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+i.signalingState));if("offer"===e.type)t=n.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=n.parseRtpParameters(e);i.transceivers[t].localCapabilities=r})),i.transceivers.forEach((function(e,t){i._gather(e.mid,t)}));else if("answer"===e.type){t=n.splitSections(i._remoteDescription.sdp),r=t.shift();var a=n.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var s=i.transceivers[t],c=s.iceGatherer,u=s.iceTransport,l=s.dtlsTransport,d=s.localCapabilities,h=s.remoteCapabilities;if(!(n.isRejected(e)&&0===n.matchPrefix(e,"a=bundle-only").length||s.rejected)){var f=n.getIceParameters(e,r),p=n.getDtlsParameters(e,r);a&&(p.role="server"),i.usingBundle&&0!==t||(i._gather(s.mid,t),"new"===u.state&&u.start(c,f,a?"controlling":"controlled"),"new"===l.state&&l.start(p));var m=o(d,h);i._transceive(s,m.codecs.length>0,!1)}}))}return i._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(i){var l=this;if(-1===["offer","answer"].indexOf(i.type))return Promise.reject(c("TypeError",'Unsupported type "'+i.type+'"'));if(!s("setRemoteDescription",i.type,l.signalingState)||l._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+i.type+" in state "+l.signalingState));var d={};l.remoteStreams.forEach((function(e){d[e.id]=e}));var h=[],f=n.splitSections(i.sdp),p=f.shift(),m=n.matchPrefix(p,"a=ice-lite").length>0,g=n.matchPrefix(p,"a=group:BUNDLE ").length>0;l.usingBundle=g;var v=n.matchPrefix(p,"a=ice-options:")[0];return l.canTrickleIceCandidates=!!v&&v.substr(14).split(" ").indexOf("trickle")>=0,f.forEach((function(s,c){var u=n.splitLines(s),f=n.getKind(s),v=n.isRejected(s)&&0===n.matchPrefix(s,"a=bundle-only").length,y=u[0].substr(2).split(" ")[2],b=n.getDirection(s,p),R=n.parseMsid(s),_=n.getMid(s)||n.generateIdentifier();if(v||"application"===f&&("DTLS/SCTP"===y||"UDP/DTLS/SCTP"===y))l.transceivers[c]={mid:_,kind:f,protocol:y,rejected:!0};else{var C,S,T,w,D,P,k,E,I;!v&&l.transceivers[c]&&l.transceivers[c].rejected&&(l.transceivers[c]=l._createTransceiver(f,!0));var O,B,x=n.parseRtpParameters(s);v||(O=n.getIceParameters(s,p),(B=n.getDtlsParameters(s,p)).role="client"),k=n.parseRtpEncodingParameters(s);var A=n.parseRtcpParameters(s),L=n.matchPrefix(s,"a=end-of-candidates",p).length>0,N=n.matchPrefix(s,"a=candidate:").map((function(e){return n.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===i.type||"answer"===i.type)&&!v&&g&&c>0&&l.transceivers[c]&&(l._disposeIceAndDtlsTransports(c),l.transceivers[c].iceGatherer=l.transceivers[0].iceGatherer,l.transceivers[c].iceTransport=l.transceivers[0].iceTransport,l.transceivers[c].dtlsTransport=l.transceivers[0].dtlsTransport,l.transceivers[c].rtpSender&&l.transceivers[c].rtpSender.setTransport(l.transceivers[0].dtlsTransport),l.transceivers[c].rtpReceiver&&l.transceivers[c].rtpReceiver.setTransport(l.transceivers[0].dtlsTransport)),"offer"!==i.type||v)"answer"!==i.type||v||(S=(C=l.transceivers[c]).iceGatherer,T=C.iceTransport,w=C.dtlsTransport,D=C.rtpReceiver,P=C.sendEncodingParameters,E=C.localCapabilities,l.transceivers[c].recvEncodingParameters=k,l.transceivers[c].remoteCapabilities=x,l.transceivers[c].rtcpParameters=A,N.length&&"new"===T.state&&(!m&&!L||g&&0!==c?N.forEach((function(e){a(C.iceTransport,e)})):T.setRemoteCandidates(N)),g&&0!==c||("new"===T.state&&T.start(S,O,"controlling"),"new"===w.state&&w.start(B)),!o(C.localCapabilities,C.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,l._transceive(C,"sendrecv"===b||"recvonly"===b,"sendrecv"===b||"sendonly"===b),!D||"sendrecv"!==b&&"sendonly"!==b?delete C.rtpReceiver:(I=D.track,R?(d[R.stream]||(d[R.stream]=new e.MediaStream),r(I,d[R.stream]),h.push([I,D,d[R.stream]])):(d.default||(d.default=new e.MediaStream),r(I,d.default),h.push([I,D,d.default]))));else{(C=l.transceivers[c]||l._createTransceiver(f)).mid=_,C.iceGatherer||(C.iceGatherer=l._createIceGatherer(c,g)),N.length&&"new"===C.iceTransport.state&&(!L||g&&0!==c?N.forEach((function(e){a(C.iceTransport,e)})):C.iceTransport.setRemoteCandidates(N)),E=e.RTCRtpReceiver.getCapabilities(f),t<15019&&(E.codecs=E.codecs.filter((function(e){return"rtx"!==e.name}))),P=C.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var M,j=!1;"sendrecv"===b||"sendonly"===b?(j=!C.rtpReceiver,D=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,f),j&&(I=D.track,R&&"-"===R.stream||(R?(d[R.stream]||(d[R.stream]=new e.MediaStream,Object.defineProperty(d[R.stream],"id",{get:function(){return R.stream}})),Object.defineProperty(I,"id",{get:function(){return R.track}}),M=d[R.stream]):(d.default||(d.default=new e.MediaStream),M=d.default)),M&&(r(I,M),C.associatedRemoteMediaStreams.push(M)),h.push([I,D,M]))):C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===C.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(r,t)})),C.associatedRemoteMediaStreams=[]),C.localCapabilities=E,C.remoteCapabilities=x,C.rtpReceiver=D,C.rtcpParameters=A,C.sendEncodingParameters=P,C.recvEncodingParameters=k,l._transceive(l.transceivers[c],!1,j)}}})),void 0===l._dtlsRole&&(l._dtlsRole="offer"===i.type?"active":"passive"),l._remoteDescription={type:i.type,sdp:i.sdp},"offer"===i.type?l._updateSignalingState("have-remote-offer"):l._updateSignalingState("stable"),Object.keys(d).forEach((function(t){var r=d[t];if(r.getTracks().length){if(-1===l.remoteStreams.indexOf(r)){l.remoteStreams.push(r);var n=new Event("addstream");n.stream=r,e.setTimeout((function(){l._dispatchEvent("addstream",n)}))}h.forEach((function(e){var t=e[0],n=e[1];r.id===e[2].id&&u(l,t,n,[r])}))}})),h.forEach((function(e){e[2]||u(l,e[0],e[1],[])})),e.setTimeout((function(){l&&l.transceivers&&l.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},l.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},l.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var o=r.transceivers.filter((function(e){return"audio"===e.kind})).length,s=r.transceivers.filter((function(e){return"video"===e.kind})).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(o=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(s=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(r.transceivers.forEach((function(e){"audio"===e.kind?--o<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1)}));o>0||s>0;)o>0&&(r._createTransceiver("audio"),o--),s>0&&(r._createTransceiver("video"),s--);var u=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(i,o){var s=i.track,a=i.kind,c=i.mid||n.generateIdentifier();i.mid=c,i.iceGatherer||(i.iceGatherer=r._createIceGatherer(o,r.usingBundle));var u=e.RTCRtpSender.getCapabilities(a);t<15019&&(u.codecs=u.codecs.filter((function(e){return"rtx"!==e.name}))),u.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),i.remoteCapabilities&&i.remoteCapabilities.codecs&&i.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),u.headerExtensions.forEach((function(e){(i.remoteCapabilities&&i.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var l=i.sendEncodingParameters||[{ssrc:1001*(2*o+1)}];s&&t>=15019&&"video"===a&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),i.wantReceive&&(i.rtpReceiver=new e.RTCRtpReceiver(i.dtlsTransport,a)),i.localCapabilities=u,i.sendEncodingParameters=l})),"max-compat"!==r._config.bundlePolicy&&(u+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),u+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){u+=i(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),u+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,u+="a="+n.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(u+="a=end-of-candidates\r\n"))}));var l=new e.RTCSessionDescription({type:"offer",sdp:u});return Promise.resolve(l)},l.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var s=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(s+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n";var a=n.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,n){if(!(n+1>a)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?s+="m=application 0 DTLS/SCTP 5000\r\n":s+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var u=o(e.localCapabilities,e.remoteCapabilities);!u.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=i(e,u,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n")}}));var u=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(u)},l.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(i,o){if(!r._remoteDescription)return o(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var u=0;u<r.transceivers.length;u++)if(r.transceivers[u].mid===e.sdpMid){s=u;break}var l=r.transceivers[s];if(!l)return o(c("OperationError","Can not add ICE candidate"));if(l.rejected)return i();var d=Object.keys(e.candidate).length>0?n.parseCandidate(e.candidate):{};if("tcp"===d.protocol&&(0===d.port||9===d.port))return i();if(d.component&&1!==d.component)return i();if((0===s||s>0&&l.iceTransport!==r.transceivers[0].iceTransport)&&!a(l.iceTransport,d))return o(c("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=n.getMediaSections(r._remoteDescription.sdp))[s]+="a="+(d.type?h:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=n.getDescription(r._remoteDescription.sdp)+t.join("")}else for(var f=0;f<r.transceivers.length&&(r.transceivers[f].rejected||(r.transceivers[f].iceTransport.addRemoteCandidate({}),(t=n.getMediaSections(r._remoteDescription.sdp))[f]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=n.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));f++);i()}))},l.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)})),!r)throw c("InvalidAccessError","Invalid selector.");return r.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats())}))})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var n;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[r]).type]||n.type,t.set(r,e[r])})),t}))}}}));var d=["createOffer","createAnswer"];return d.forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(d=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),l}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0);r(74),r(73);const i=n.__importDefault(r(40)),o=n.__importDefault(r(2)),s=n.__importDefault(r(8)),a=n.__importDefault(r(12)),c=n.__importDefault(r(3)),u=n.__importDefault(r(15)),l=n.__importStar(r(1)),d=r(36),h=r(72);class f{constructor(e){this.enterReportTimer=0,this.saveDataToken=o.default.randomString(10),this.saveDataBuvidSwitch=!1,this.disableSaveDataByDB=!1,this.disableGetData=!0,this.saveAndGetDataSwitch=!1,this.enableSuckBrowser=!1,this.reportToTrackerEnabled=!1,this.trackerVersion="",this.state=d.track,this.fawkesConfig=new h.Config(this,e),this.init(e)}get version(){return"bp-nc-sdk "+s.default.getInstance().version}get saveDataEnabled(){return this.saveAndGetDataSwitch&&this.saveDataBuvidSwitch&&!this.disableSaveDataByDB&&o.default.isChrome()&&o.default.isChromeAboveCertainVersion(46)&&["www.bilibili.com","pre-www.bilibili.com","player.bilibili.com"].includes(window.location.host)&&o.default.canUseRealP2P({aid:this.config.aid})&&!this.isAdminBanSeeder().banned}get getDataEnabled(){return this.saveAndGetDataSwitch&&!this.disableGetData}init(e){this.config={aid:0,cid:0,bvid:""},e&&(this.config.aid=Math.floor(e.aid),this.config.cid=Math.floor(e.cid),this.config.bvid=e.bvid?""+e.bvid:"",e.buvid?this.config.buvid=""+e.buvid:this.config.buvid=o.default.getCookie("buvid3"),!0===e.isAdmin&&(this.config.isAdmin=!0),e.debugKey&&(this.config.debugKey=""+e.debugKey),this.config.duration=Math.floor(e.duration)),l.default.getInstance().log(`init -- version: ${s.default.getInstance().version}, isSupportNC: ${o.default.isSupportP2P()}`),this.eventBus=a.default.getInstance(),o.default.isSupportP2P()&&(this.main=new i.default(this)),this.enterReportTimer=window.setTimeout(()=>{let e={type:u.default.TRACK_TYPE.ENTER,version:s.default.getInstance().version,isSupportP2P:o.default.isSupportP2P()};this.trigger(c.default.TRACK,e)})}updateConfig(e){e&&(this.config={aid:0,cid:0,bvid:""},this.config.aid=Math.floor(e.aid),this.config.cid=Math.floor(e.cid),this.config.bvid=e.bvid?""+e.bvid:"",e.buvid&&(this.config.buvid=""+e.buvid),!0===e.isAdmin&&(this.config.isAdmin=!0),e.debugKey&&(this.config.debugKey=""+e.debugKey),this.config.duration=Math.floor(e.duration))}quit(){const{getDataStat:e,rtcStat:t,dbStat:r}=this.state;let n={type:u.default.TRACK_TYPE.QUIT,version:s.default.getInstance().version,getDataStat:e,rtcStat:t,dbStat:r};this.trigger(c.default.TRACK,n)}destroy(){l.default.getInstance().log("destroy"),window.clearTimeout(this.enterReportTimer),this.main&&(this.main.destroy(),this.main=null),this.eventBus&&(this.eventBus.destroy(),this.eventBus=null),this.saveAndGetDataSwitch=!1,this.saveDataBuvidSwitch=!1,this.disableSaveDataByDB=!1,l.default.getInstance().reset(),this.state.destroy()}getData(e){if(o.default.isSupportP2P()&&this.main&&e&&this.getDataEnabled){let t=`\n            ----\n            getData -- url: ${e.url}, range: ${e.range}`;return l.default.getInstance().log(t),e.startTime=Date.now(),this.main.getData(e)}return Promise.reject({code:-1,msg:"basic error"})}saveData(e){var t;if(o.default.isSupportP2P()&&this.main&&e&&this.saveDataEnabled){let r=`saveData -- url: ${e.url}, range: ${e.range}, totalSize: ${e.totalSize}, `;r+="dataSize: "+(null===(t=e.data)||void 0===t?void 0:t.byteLength),l.default.getInstance().log(r);try{this.main.saveData(e)}catch(e){this.state.dbStat.saveFailure++}}}abortGetData(e){o.default.isSupportP2P()&&this.main&&e&&"string"==typeof e&&this.main.abortGetData(e)}getToken(){return o.default.randomString(16)}allowDPGetDataByNC(e){if(!this.getDataEnabled)return!1;if(!e)return!1;const t=+e.rangeStart,r=Math.floor(e.qn),n=+e.originBufferLevel,i=Math.floor(e.bitrate);if(isNaN(t)||t<100)return!1;if(isNaN(r)||r<=0)return!1;if(!(r>3e4&&r<=30126||r>30200&&r<=30280||r>=100022&&r<=100032))return!1;if(i>12582912)return!1;let o=n;const s=Math.floor(i/1024/1024);if(s>1){const e=1.5;o-=Math.min(8,s*e)}return!(isNaN(o)||o<12)}allowDPSaveDataByNC(e){return!!this.saveDataEnabled&&!!e&&o.default.canUseRealP2P({qn:Math.floor(e.qn)})}getLogHistory(e=l.LOG_LEVEL.INFO){return l.default.getInstance().getHistory(e)}on(e,t){var r;null===(r=this.eventBus)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.eventBus)||void 0===r||r.off(e,t)}trigger(e,...t){var r;null===(r=this.eventBus)||void 0===r||r.trigger(e,...t)}isAdminBanSeeder(){const e=o.default.getLocalStorage("bp_nc_admin"),[t,r]=o.default.tryCatchSync(JSON.parse,e);return t?{banned:!1}:(null==r?void 0:r.ban_save_and_seeder)?{banned:!0,msg:"user banned browser p2p",code:40010}:{banned:!1}}getSdkStats(){const e=o.default.getAttrsOfObj(this.state.dbStat,["saveCount","saveSuccess","saveFailure","saveSlices","savedSlices","saveRids","savedRids","saveBytes","savedBytes","deleteFailureForAllBelow24h","exceedingDBTotalSize","exceedingRidMax","reportTotalSize","reportSuccess","reportFailure"]),t=o.default.getAttrsOfObj(this.state.rtcStat,["getDataFromDBSuccess","getDataFromDBFail","sendBytes","sendSuccessBytes","sendSuccess","receivedByteTotal","receivedByteFromBrowser","receivedByteFromBox","offerInitToBrowser","offerDataChannelOpenToBrowser","receivedOffer","answerDataChannelOpen","getSuccessFromBrowser","sendFinished","receivedGetData","offerAccepted","receivedCandidate3","receivedCandidate2","receivedCandidate1","noDonationPeer","successiveBrowserPeerNotOpen"]);return this.state.reset(),Object.assign(Object.assign({},e),t)}}f.LOG_LEVEL=l.LOG_LEVEL,f.BPP2PEvent=c.default,f.isSupport=o.default.isSupportP2P,t.default=f},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importDefault(r(2)),o=n.__importDefault(r(8)),s=n.__importDefault(r(12)),a=n.__importDefault(r(3)),c=n.__importDefault(r(15)),u=n.__importDefault(r(1)),l=n.__importDefault(r(41)),d=r(34),h=r(7),f=r(65),p=r(71);t.default=class{constructor(e){this.needSaveResources={},this.onceSaveDataSizeMax=52428800,this.useP2PGetDataObj={},this.refreshTimeout=5e4,this.enableRepeatLog=!0,this.failureRecord={},this.sdk=e,this.getDataStat=this.sdk.state.getDataStat,this.getDataContinuousStat=this.sdk.state.getData,this.dbStat=this.sdk.state.dbStat,this.socketController=new l.default(this.sdk),this.promiseQueue=new p.PromiseQueue,this.dbController=new d.DBController(this.sdk,this.socketController,this.promiseQueue),this.webrtcFactory=new f.WebRTCFactory(this.sdk,this.socketController,this.dbController,this.promiseQueue)}destroy(){var e,t,r,n,i;clearTimeout(this.refreshTimer),null===(e=this.socketController)||void 0===e||e.off(a.default.SOCKET_MESSAGE),null===(t=this.webrtcFactory)||void 0===t||t.destroy(),null===(r=this.dbController)||void 0===r||r.destroy(),null===(n=this.socketController)||void 0===n||n.destroy(),null===(i=this.promiseQueue)||void 0===i||i.destroy(),delete this.needSaveResources,delete this.dbController,delete this.socketController,delete this.webrtcFactory,delete this.refreshTimer;for(const e in this.useP2PGetDataObj)for(let t=0;t<this.useP2PGetDataObj[e].length;t++)this.clearGetDataObj(this.useP2PGetDataObj[e][t]);this.useP2PGetDataObj={},Object.values(this.failureRecord).forEach(({disableNCTimer:e})=>e&&window.clearTimeout(e)),this.failureRecord={}}saveData(e){const{path:t,data:r}=this.handleDataParam("save",e)||{},[n,o]=i.default.tryCatchSync(i.default.getQnAndCid,t),{cid:s}=o||{};if(!r||!t||n)return;if(r.byteLength>this.onceSaveDataSizeMax)return void u.default.getInstance().warn("more than onceSaveDataSizeMax -- dataSize: "+r.byteLength);const a=h.DBUtils.getSaveRestriction();if([()=>{var e;return!(null===(e=null==a?void 0:a[s])||void 0===e?void 0:e.timestamp)},()=>Date.now()-a[s].timestamp>18e4,()=>a[s].token===this.sdk.saveDataToken].every(e=>!e()))this.enableRepeatLog&&(h.DBUtils.warn("同一个 cid 在另外一个 tab 写数据, 你就别写了"),this.enableRepeatLog=!1);else{try{h.DBUtils.setSaveRestriction(s,{timestamp:Date.now(),token:this.sdk.saveDataToken})}catch(e){return void(this.dbStat.saveFailure=++this.dbStat.saveFailure)}h.DBUtils.log("main.ts调用saveData了, 开始存了"),this.enableRepeatLog=!0,this.promiseQueue.enqueue(()=>{var n;return null===(n=this.dbController)||void 0===n?void 0:n.saveResource({range:e.range,data:r,rid:t}).then(e=>{var t;this.dbStat.saveSuccess=++this.dbStat.saveSuccess||1;const r={43005:()=>h.DBUtils.happyLog("存储成功! 相同的rid和id和range已经存过",e),43012:()=>h.DBUtils.happyLog("存储成功! rid和id已经有了, 只存了分片",e),43011:()=>h.DBUtils.happyLog("存储成功! 存储了新的rid和range",e),43022:()=>h.DBUtils.happyLog("存储成功! 存储了新的id和range",e)};null===(t=r[e.code])||void 0===t||t.call(r)}).catch(e=>{h.DBUtils.handleError(e,!1,"save Resource失败",43010),this.dbStat.saveFailure=++this.dbStat.saveFailure||1}).finally(()=>this.dbStat.saveCount++)})}}abortGetData(e){for(const t in this.useP2PGetDataObj)for(let r=0;r<this.useP2PGetDataObj[t].length;r++){const n=this.useP2PGetDataObj[t][r];if(n&&n.token&&n.token===e){const e=0===r;u.default.getInstance().log("abortGetData i:",r,n.internalParam),this.webrtcFactory.abortGetData(n.internalParam),this.removeGetDataObj(n,e);break}}}getData(e){var t;let r=this.handleDataParam("get",e);if(!r)return Promise.reject({code:4e4,msg:"data param invalid",responseData:{path:null==r?void 0:r.path,range:(null==r?void 0:r.rangeStart)+"-"+(null==r?void 0:r.rangeEnd)}});const{path:n}=r;if(this.socketController){let e=0,t="",n=!1;if(this.socketController.disableAllRNCTimer&&(n=!0,e=40017,t="search peer limit, disable getData"),this.socketController.noPeerRecord){const i=this.socketController.noPeerRecord[r.path];(null==i?void 0:i.disableNCTimer)&&(n=!0,e=40007,t="current resource has no peer for several times, disable getData")}if(n)return Promise.reject({code:e,msg:t,responseData:{path:r.path,range:(null==r?void 0:r.rangeStart)+"-"+(null==r?void 0:r.rangeEnd)}})}if(null===(t=this.failureRecord[n])||void 0===t?void 0:t.disableNCTimer)return Promise.reject({code:40011,msg:"browser seeder fail too many times, disable getData",responseData:{path:r.path,range:(null==r?void 0:r.rangeStart)+"-"+(null==r?void 0:r.rangeEnd)}});const i=this.createGetDataObj(e,r);return this.useP2PGetDataObj[n].length>1?(u.default.getInstance().log("wait for getting video data, getDataObjArr.length:",this.useP2PGetDataObj[n].length),i.promise):(this.internalGetData(this.useP2PGetDataObj[n][0]),i.promise)}internalGetData(e){var t,r,i;return n.__awaiter(this,void 0,void 0,(function*(){const{path:n}=e.internalParam;if(u.default.getInstance().log(n+" internalGetData",e),clearTimeout(this.refreshTimer),this.createRefreshTimer(e),!this.socketController)return null===(t=e.onReject)||void 0===t||t.call(e,{code:40002,msg:"no socketController"}),this.removeGetDataObj(e,!0),void(this.getDataStat.useP2PNoSCFail=++this.getDataStat.useP2PNoSCFail||1);try{const t=yield this.webrtcFactory.getData(e.internalParam);null===(r=e.onResolve)||void 0===r||r.call(e,t),this.getDataContinuousStat.useP2PSuccess=++this.getDataContinuousStat.useP2PSuccess||1}catch(t){u.default.getInstance().log(n+" rtcRejectRes",t),null===(i=e.onReject)||void 0===i||i.call(e,t),this.handleGetDataErrorStatistics(t),this.handleFailureRecord(n,t)}}))}handleFailureRecord(e,t){var r,n;if(!(null===(r=t.responseData)||void 0===r?void 0:r.cPeerSID))return;if("box"===i.default.getPeerTarget(t.responseData.cPeerSID))return;const o=(n=this.failureRecord)[e]||(n[e]={failureCount:0});o.failureCount++,o.failureCount>Number.MAX_SAFE_INTEGER&&(o.disableNCTimer=window.setTimeout(()=>{o.disableNCTimer=0,this.failureRecord[e].failureCount=0},3e4))}clearGetDataObj(e){e&&(e.onResolve=null,e.onReject=null,e.promise=null)}removeGetDataObj(e,t=!1){if(!e)return;this.clearGetDataObj(e);const r=this.useP2PGetDataObj[e.internalParam.path]||[],n=r.findIndex(t=>t===e);r.splice(n,1),r.length&&(0===n&&t?this.internalGetData(r[0]):u.default.getInstance().warn("removeGetDataObj is not first and need getNextData -- removeI: ' + "+n))}handleDataParam(e,t){if(!t||!t.url)return null;let r=""+t.url,n=r.split("?")[0].split("/"),i=n[n.length-1];if(!i)return null;let o=(""+t.range).split("-");if(o.length<2)return null;let s=parseInt(o[0],10),a=parseInt(o[1],10);if(isNaN(s)||isNaN(a)||s<0||a<s)return null;if(!t.token||"string"!=typeof t.token)return u.default.getInstance().log("no valid token"),null;if(t.totalSize&&a>=t.totalSize)return u.default.getInstance().log("要获取的数据范围超出资源最大字节范围"),null;let c=t.data;return"save"!==e||c&&c.byteLength&&c.byteLength===a-s+1?{type:e,url:r,path:i,rangeStart:s,rangeEnd:a,token:t.token,startTime:t.startTime,data:c,totalSize:t.totalSize,bitrate:t.bitrate,latency:t.latency}:null}getNodeVar(e,t){this.socketController&&this.socketController.getNodeVar(e,t)}hotPushToTracker(e,t){var r;e&&t?null===(r=this.socketController)||void 0===r||r.hotPushToTracker(e,t):u.default.getInstance().log("hotPushToTracker -- param invalid")}handleGetDataErrorStatistics(e){const t={43e3:"useP2PFileReaderError",41e3:"useP2PWebRTCOpenTimeout",41001:"useP2PWebRTCOpenTimeoutByNoLDP",41002:"useP2PWebRTCOpenTimeoutByNoRDP",41003:"useP2PWebRTCOpenTimeoutByNoRC",41004:"useP2PWebRTCOpenTimeoutByNoACS",__default__:"useP2PWebRTCFail"},r=t[null==e?void 0:e.code]||t.__default__;this.getDataStat[r]=++this.getDataStat[r]||1}createRefreshTimer(e){this.refreshTimer=window.setTimeout(()=>{var t,r,n,i,o;const s={range:(null===(t=e.internalParam)||void 0===t?void 0:t.rangeStart)+"-"+(null===(r=e.internalParam)||void 0===r?void 0:r.rangeEnd),from:0,path:null===(n=e.internalParam)||void 0===n?void 0:n.path,getDataTime:Date.now()-(null===(i=e.internalParam)||void 0===i?void 0:i.startTime),data:void 0,gotDataByte:0,rtcDataChannelState:void 0,cPeerSID:""};null===(o=e.onReject)||void 0===o||o.call(e,{code:40005,msg:`current ${e.internalParam.path} peer lose`,responseData:s},!1)},this.refreshTimeout)}createGetDataObj(e,t){const r={token:e.token,dataParam:e,internalParam:t};return r.promise=new Promise((e,n)=>{const i=this;r.onResolve=function(n,l=!0){e(n),i.removeGetDataObj(this,l);const d=r.internalParam.rangeEnd-r.internalParam.rangeStart+1;if(d!==n.responseData.data.byteLength){let e={type:c.default.TRACK_TYPE.DEBUG_TOTAL_SIZE_NOT_EQUAL,version:o.default.getInstance().version,totalSize:d,byteLength:n.responseData.data.byteLength,rid:t.path,rangeStart:t.rangeStart,rangeEnd:t.rangeEnd};s.default.getInstance().trigger(a.default.TRACK,e),u.default.getInstance().log("------- totalSize !== response data byteLength")}},r.onReject=function(e,t=!0){n(e),i.removeGetDataObj(this,t)}}),this.getDataStat.useP2P=++this.getDataStat.useP2P||1,this.getDataContinuousStat.useP2P=++this.getDataContinuousStat.useP2P||1,this.useP2PGetDataObj[t.path]=[...this.useP2PGetDataObj[t.path]||[],r],r}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importDefault(r(2)),o=n.__importDefault(r(1)),s=n.__importDefault(r(13)),a=r(42),c=n.__importDefault(r(3)),u=n.__importDefault(r(8)),l=r(22),d=r(9),h=r(58);t.default=class{constructor(e){this.getPeerInfoTimeout=2e3,this.noPeerRecord={},this.donationRecord={},this.channelOpenFailRecord={browserPeer:0,boxPeer:0},this.goodHistoryPeers=[],this.badHistoryPeers={},this.disableAllRNCTimer=0,this.sdk=e,this.init()}init(){this.events=new s.default;let e=1e4;i.default.BROWSER_ENV===l.RUNTIME_MODE.DEV&&(e=3e3);let t={buvid:this.sdk.config.buvid?this.sdk.config.buvid:"",sdkVersion:u.default.getInstance().version,aid:""+this.sdk.config.aid,cid:""+this.sdk.config.cid};this.sdk.config.isAdmin&&(t.isAdmin="1"),this.sdk.config.debugKey&&(t.debugKey=this.sdk.config.debugKey),i.default.isChrome()||(t.bkt="1");const r=this.sdk.config.duration>0?this.sdk.config.duration:0;t.duration=""+r,this.socket=a.io(this.setSocketURL(),{autoConnect:!1,reconnectionAttempts:3,reconnectionDelay:e,reconnectionDelayMax:6e4,transports:["websocket"],secure:!0,parser:h,query:t}),this.createSocket("connect").on(()=>{o.default.getInstance().log(this.socket.id+" connect success"),this.socketID=this.socket.id,this.sdk.saveAndGetDataSwitch=!0,this.sdk.saveDataBuvidSwitch=!1,this.trigger(c.default.SOCKET_CONNECT)});const n=()=>{this.trigger(c.default.SOCKET_DISCONNECT),this.socketID="",this.sdk.saveAndGetDataSwitch=!1,this.sdk.saveDataBuvidSwitch=!1,this.sdk.disableGetData=!0};this.createSocket("disconnect").on(e=>{o.default.getInstance().log("socket disconnect",e),n()}),this.createSocket("connect_error").on(e=>{o.default.getInstance().log("connection is refused",e.message),n()}),this.createSocket("error").on(e=>{o.default.getInstance().log("connection error",e.message),n()}),this.createSocket("message").on(e=>{e&&e.fromSocketID&&("trackerVersion"===e.type?(this.sdk.trackerVersion=e.version,o.default.getInstance().log("tracker version is: "+this.sdk.trackerVersion)):"enableGetData"===e.type?(this.sdk.disableGetData=!1,o.default.getInstance().log(`tracker enable getData, aid is ${this.sdk.config.aid}, cid is ${this.sdk.config.cid}`)):"activePeerV3"===e.type&&(1===e.save&&(this.sdk.saveDataBuvidSwitch=!0),1===e.suck&&(this.sdk.enableSuckBrowser=!0)),this.trigger(c.default.SOCKET_MESSAGE,e))}),this.socket.connect()}setSocketURL(){let e="wss://web-player-tracker.biliapi.net";"hw"===this.sdk.fawkesConfig.vendor&&(e="wss://hw-web-player-tracker.biliapi.net"),i.default.BROWSER_ENV===l.RUNTIME_MODE.PRE&&(e="wss://pre-web-player-tracker.biliapi.net");try{const t=JSON.parse(i.default.getLocalSettings("bp_nc_config"));(null==t?void 0:t.socketURL)&&"string"==typeof t.socketURL&&(e=t.socketURL)}catch(e){}return e}on(e,t){var r;null===(r=this.events)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.events)||void 0===r||r.off(e,t)}trigger(e,...t){var r;null===(r=this.events)||void 0===r||r.trigger(e,...t)}getPeerInfo(e,t,r){return new Promise((n,i)=>{var s,a,c;if(!e||!t||!(null===(s=this.socket)||void 0===s?void 0:s.connected))return i({code:40001,msg:"no valid peer, getPeerInfo sdk internal error"}),void o.default.getInstance().warn(`[getPeerInfo] rid: ${e}, sliceRange: ${t}, connected: ${null===(a=this.socket)||void 0===a?void 0:a.connected}`);let u,l=window.setTimeout(()=>{l=0,i({code:40004,msg:"no valid peer, getPeerInfo timeout"}),this.handleNoPeerRecord(e)},this.getPeerInfoTimeout);switch(!0){case"rejected"===this.channelOpenFailRecord.browserPeer:case!!(null===(c=this.donationRecord[e])||void 0===c?void 0:c.disableDonationTimer):u=1;break;case this.sdk.enableSuckBrowser:u=5;break;default:u=1}this.createSocket("getPeerInfoV4").emit(e,t,"",r,u,t=>{if(l){if(o.default.getInstance().log(`[getPeerInfo] rid: ${e} res:`,t),window.clearTimeout(l),l=0,[25e3,25001,2e3].includes(t.code))n(t);else{if(51003===t.code&&!this.disableAllRNCTimer){const e=6e4+30*Math.random()*1e3;this.disableAllRNCTimer=window.setTimeout(()=>{this.disableAllRNCTimer=0},e)}i(t)}this.handleDonationRecord(e,u,t),this.handleNoPeerRecord(e,null==t?void 0:t.peers)}else{const r=null==t?void 0:t.peers;if(null==r?void 0:r.length)for(let t=0;t<r.length;t++){const n=r[t];(null==n?void 0:n.id)&&this.releasePeerInfo(n.id,e)}}})})}handleNoPeerRecord(e,t){if(!e)return;let r=this.noPeerRecord[e];if(null==t?void 0:t.length)r&&(r.noPeerCount=0,r.disableNCTimer&&(window.clearTimeout(r.disableNCTimer),r.disableNCTimer=0),delete this.noPeerRecord[e]);else{r||(this.noPeerRecord[e]=r={rid:e,noPeerCount:0,disableNCTimer:0}),r.noPeerCount++;const t=3;if(!r.disableNCTimer&&r.noPeerCount%t==0){const e=60*Math.floor(r.noPeerCount/t)*1e3+30*Math.random()*1e3;r.disableNCTimer=window.setTimeout(()=>{r.disableNCTimer=0},e)}}}handleDonationRecord(e,t,r){var n;if(e&&5===t&&r.donationShouldResPeerNum>0&&0===(null==r?void 0:r.peers.filter(e=>e.deviceType===l.DEVICE_TYPE.BROWSER).length)){const t=60*this.sdk.fawkesConfig.disableDonationTime*1e3+30*Math.random()*1e3,r=(n=this.donationRecord)[e]||(n[e]={rid:e,count:0,disableDonationTimer:0});++r.count%3==0&&(this.reportStatToTracker("noDonationPeer"),r.disableDonationTimer=window.setTimeout(()=>{r.disableDonationTimer=0},t))}}releasePeerInfo(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.createSocket("releasePeerInfo").emit(e,t)}sendMessage(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.createSocket("message").emit(e,t)}reportResource(e,t,r){var n;if(e&&(null==t?void 0:t.length)&&(null===(n=this.socket)||void 0===n?void 0:n.connected))return this.createSocket("report").emit(e,t,2,r),this.sdk.state.dbStat.reportTotalSize+=r,void this.sdk.state.dbStat.reportSuccess++;this.sdk.state.dbStat.reportFailure++}reportRTCState(e,t,r,n){var i;(null===(i=this.socket)||void 0===i?void 0:i.connected)&&this.createSocket("reportRTCState").emit(e,t,r,n)}reportBadCPeerSID(e){var t;(null===(t=this.socket)||void 0===t?void 0:t.connected)&&this.createSocket("RBCPS").emit(e)}getNodeVar(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.createSocket("getVar").emit(e,t)}hotPushToTracker(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.createSocket("hotPushToTracker").emit(e,t)}reportStatToTracker(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&("sendSuccessBytes"!==e?this.sdk.reportToTrackerEnabled&&this.createSocket("reportRealNC").emit(e):this.createSocket("reportRealNC").emit(e,t))}destroy(){this.socket&&(this.socket.off("connect"),this.socket.off("disconnect"),this.socket.off("message"),this.socketID="",this.socket.disconnect(),this.socket=null),this.events&&(this.events.destroy(),this.events=null);for(let e in this.noPeerRecord){const t=this.noPeerRecord[e];(null==t?void 0:t.disableNCTimer)&&(window.clearTimeout(t.disableNCTimer),t.disableNCTimer=0)}this.noPeerRecord={},Object.keys(this.donationRecord||{}).forEach(e=>{var t,r;(null===(r=null===(t=this.donationRecord)||void 0===t?void 0:t[e])||void 0===r?void 0:r.disableDonationTimer)&&(window.clearTimeout(this.donationRecord[e].disableDonationTimer),this.donationRecord[e].disableDonationTimer=0)}),this.donationRecord={},this.channelOpenFailRecord={browserPeer:0,boxPeer:0},this.goodHistoryPeers=[],this.badHistoryPeers={},this.disableAllRNCTimer&&(window.clearTimeout(this.disableAllRNCTimer),this.disableAllRNCTimer=0)}disconnect(){this.socket.disconnect()}createSocket(e){return d.createSocket(e,this.socket)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=t.io=t.Manager=t.protocol=void 0;const n=r(43),i=r(24),o=r(31);Object.defineProperty(t,"Socket",{enumerable:!0,get:function(){return o.Socket}});const s=r(4)("socket.io-client");e.exports=t=c;const a=t.managers={};function c(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};const r=n.url(e,t.path),o=r.source,c=r.id,u=r.path,l=a[c]&&u in a[c].nsps;let d;return t.forceNew||t["force new connection"]||!1===t.multiplex||l?(s("ignoring socket cache for %s",o),d=new i.Manager(o,t)):(a[c]||(s("new io instance for %s",o),a[c]=new i.Manager(o,t)),d=a[c]),r.query&&!t.query&&(t.query=r.queryKey),d.socket(r.path,t)}t.io=c;var u=r(18);Object.defineProperty(t,"protocol",{enumerable:!0,get:function(){return u.protocol}}),t.connect=c;var l=r(24);Object.defineProperty(t,"Manager",{enumerable:!0,get:function(){return l.Manager}})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.url=void 0;const n=r(23),i=r(4)("socket.io-client:url");t.url=function(e,t="",r){let o=e;r=r||"undefined"!=typeof location&&location,null==e&&(e=r.protocol+"//"+r.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?r.protocol+e:r.host+e),/^(https?|wss?):\/\//.test(e)||(i("protocol-less url %s",e),e=void 0!==r?r.protocol+"//"+e:"https://"+e),i("parse %s",e),o=n(e)),o.port||(/^(http|ws)$/.test(o.protocol)?o.port="80":/^(http|ws)s$/.test(o.protocol)&&(o.port="443")),o.path=o.path||"/";const s=-1!==o.host.indexOf(":")?"["+o.host+"]":o.host;return o.id=o.protocol+"://"+s+":"+o.port+t,o.href=o.protocol+"://"+s+(r&&r.port===o.port?"":":"+o.port),o}},function(e,t,r){e.exports=function(e){function t(e){let r,i,o,s=null;function a(...e){if(!a.enabled)return;const n=a,i=Number(new Date),o=i-(r||i);n.diff=o,n.prev=r,n.curr=i,r=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(r,i)=>{if("%%"===r)return"%";s++;const o=t.formatters[i];if("function"==typeof o){const t=e[s];r=o.call(n,t),e.splice(s,1),s--}return r}),t.formatArgs.call(n,e),(n.log||t.log).apply(n,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==s?s:(i!==t.namespaces&&(i=t.namespaces,o=t.enabled(e)),o),set:e=>{s=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,r){const n=t(this.namespace+(void 0===r?":":r)+e);return n.log=this.log,n}function i(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names.map(i),...t.skips.map(i).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let r;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),i=n.length;for(r=0;r<i;r++)n[r]&&("-"===(e=n[r].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let r,n;for(r=0,n=t.skips.length;r<n;r++)if(t.skips[r].test(e))return!1;for(r=0,n=t.names.length;r<n;r++)if(t.names[r].test(e))return!0;return!1},t.humanize=r(45),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(r=>{t[r]=e[r]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t}},function(e,t){var r=1e3,n=6e4,i=60*n,o=24*i;function s(e,t,r,n){var i=t>=1.5*r;return Math.round(e/r)+" "+n+(i?"s":"")}e.exports=function(e,t){t=t||{};var a,c,u=typeof e;if("string"===u&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var s=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*s;case"weeks":case"week":case"w":return 6048e5*s;case"days":case"day":case"d":return s*o;case"hours":case"hour":case"hrs":case"hr":case"h":return s*i;case"minutes":case"minute":case"mins":case"min":case"m":return s*n;case"seconds":case"second":case"secs":case"sec":case"s":return s*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:return}}}}(e);if("number"===u&&isFinite(e))return t.long?(a=e,(c=Math.abs(a))>=o?s(a,c,o,"day"):c>=i?s(a,c,i,"hour"):c>=n?s(a,c,n,"minute"):c>=r?s(a,c,r,"second"):a+" ms"):function(e){var t=Math.abs(e);return t>=o?Math.round(e/o)+"d":t>=i?Math.round(e/i)+"h":t>=n?Math.round(e/n)+"m":t>=r?Math.round(e/r)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,r){const n=r(47);e.exports=(e,t)=>new n(e,t),e.exports.Socket=n,e.exports.protocol=n.protocol,e.exports.Transport=r(16),e.exports.transports=r(25),e.exports.parser=r(11)},function(e,t,r){const n=r(25),i=r(5),o=r(4)("engine.io-client:socket"),s=r(11),a=r(23),c=r(17);class u extends i{constructor(e,t={}){super(),e&&"object"==typeof e&&(t=e,e=null),e?(e=a(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=a(t.host).host),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?443:80),this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,jsonp:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{}},t),this.opts.path=this.opts.path.replace(/\/$/,"")+"/","string"==typeof this.opts.query&&(this.opts.query=c.decode(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"==typeof addEventListener&&addEventListener("beforeunload",()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},!1),this.open()}createTransport(e){o('creating transport "%s"',e);const t=function(e){const t={};for(let r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}(this.opts.query);t.EIO=s.protocol,t.transport=e,this.id&&(t.sid=this.id);const r=Object.assign({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return o("options: %j",r),new n[e](r)}open(){let e;if(this.opts.rememberUpgrade&&u.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){const e=this;return void setTimeout((function(){e.emit("error","No transports available")}),0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return o("error while creating transport: %s",e),this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}setTransport(e){o("setting transport %s",e.name);const t=this;this.transport&&(o("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=e,e.on("drain",(function(){t.onDrain()})).on("packet",(function(e){t.onPacket(e)})).on("error",(function(e){t.onError(e)})).on("close",(function(){t.onClose("transport close")}))}probe(e){o('probing transport "%s"',e);let t=this.createTransport(e,{probe:1}),r=!1;const n=this;function i(){if(n.onlyBinaryUpgrades){const e=!this.supportsBinary&&n.transport.supportsBinary;r=r||e}r||(o('probe transport "%s" opened',e),t.send([{type:"ping",data:"probe"}]),t.once("packet",(function(i){if(!r)if("pong"===i.type&&"probe"===i.data){if(o('probe transport "%s" pong',e),n.upgrading=!0,n.emit("upgrading",t),!t)return;u.priorWebsocketSuccess="websocket"===t.name,o('pausing current transport "%s"',n.transport.name),n.transport.pause((function(){r||"closed"!==n.readyState&&(o("changing transport and sending upgrade packet"),h(),n.setTransport(t),t.send([{type:"upgrade"}]),n.emit("upgrade",t),t=null,n.upgrading=!1,n.flush())}))}else{o('probe transport "%s" failed',e);const r=new Error("probe error");r.transport=t.name,n.emit("upgradeError",r)}})))}function s(){r||(r=!0,h(),t.close(),t=null)}function a(r){const i=new Error("probe error: "+r);i.transport=t.name,s(),o('probe transport "%s" failed because of error: %s',e,r),n.emit("upgradeError",i)}function c(){a("transport closed")}function l(){a("socket closed")}function d(e){t&&e.name!==t.name&&(o('"%s" works - aborting "%s"',e.name,t.name),s())}function h(){t.removeListener("open",i),t.removeListener("error",a),t.removeListener("close",c),n.removeListener("close",l),n.removeListener("upgrading",d)}u.priorWebsocketSuccess=!1,t.once("open",i),t.once("error",a),t.once("close",c),this.once("close",l),this.once("upgrading",d),t.open()}onOpen(){if(o("socket open"),this.readyState="open",u.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade&&this.transport.pause){o("starting upgrade probes");let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(o('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emit("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else o('packet received with socket readyState "%s"',this.readyState)}onHandshake(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){clearTimeout(this.pingTimeoutTimer),this.pingTimeoutTimer=setTimeout(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout)}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()}flush(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(o("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))}write(e,t,r){return this.sendPacket("message",e,t,r),this}send(e,t,r){return this.sendPacket("message",e,t,r),this}sendPacket(e,t,r,n){if("function"==typeof t&&(n=t,t=void 0),"function"==typeof r&&(n=r,r=null),"closing"===this.readyState||"closed"===this.readyState)return;(r=r||{}).compress=!1!==r.compress;const i={type:e,data:t,options:r};this.emit("packetCreate",i),this.writeBuffer.push(i),n&&this.once("flush",n),this.flush()}close(){const e=this;function t(){e.onClose("forced close"),o("socket closing - telling transport to close"),e.transport.close()}function r(){e.removeListener("upgrade",r),e.removeListener("upgradeError",r),t()}function n(){e.once("upgrade",r),e.once("upgradeError",r)}return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(function(){this.upgrading?n():t()})):this.upgrading?n():t()),this}onError(e){o("socket error %j",e),u.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)}onClose(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){o('socket close with reason: "%s"',e);const r=this;clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),r.writeBuffer=[],r.prevBufferLen=0}}filterUpgrades(e){const t=[];let r=0;const n=e.length;for(;r<n;r++)~this.transports.indexOf(e[r])&&t.push(e[r]);return t}}u.priorWebsocketSuccess=!1,u.protocol=s.protocol,e.exports=u},function(e,t){try{e.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(t){e.exports=!1}},function(e,t,r){const n=r(26),i=r(27),o=r(5),{pick:s}=r(30),a=r(14),c=r(4)("engine.io-client:polling-xhr");function u(){}const l=null!=new n({xdomain:!1}).responseType;class d extends o{constructor(e,t){super(),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.create()}create(){const e=s(this.opts,"agent","enablesXDR","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new n(e),r=this;try{c("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let e in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(e)&&t.setRequestHeader(e,this.opts.extraHeaders[e])}}catch(e){}if("POST"===this.method)try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),this.hasXDR()?(t.onload=function(){r.onLoad()},t.onerror=function(){r.onError(t.responseText)}):t.onreadystatechange=function(){4===t.readyState&&(200===t.status||1223===t.status?r.onLoad():setTimeout((function(){r.onError("number"==typeof t.status?t.status:0)}),0))},c("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout((function(){r.onError(e)}),0)}"undefined"!=typeof document&&(this.index=d.requestsCount++,d.requests[this.index]=this)}onSuccess(){this.emit("success"),this.cleanup()}onData(e){this.emit("data",e),this.onSuccess()}onError(e){this.emit("error",e),this.cleanup(!0)}cleanup(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=u:this.xhr.onreadystatechange=u,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete d.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;null!==e&&this.onData(e)}hasXDR(){return"undefined"!=typeof XDomainRequest&&!this.xs&&this.enablesXDR}abort(){this.cleanup()}}function h(){for(let e in d.requests)d.requests.hasOwnProperty(e)&&d.requests[e].abort()}d.requestsCount=0,d.requests={},"undefined"!=typeof document&&("function"==typeof attachEvent?attachEvent("onunload",h):"function"==typeof addEventListener&&addEventListener("onpagehide"in a?"pagehide":"unload",h,!1)),e.exports=class extends i{constructor(e){if(super(e),"undefined"!=typeof location){const t="https:"===location.protocol;let r=location.port;r||(r=t?443:80),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||r!==e.port,this.xs=e.secure!==t}const t=e&&e.forceBase64;this.supportsBinary=l&&!t}request(e={}){return Object.assign(e,{xd:this.xd,xs:this.xs},this.opts),new d(this.uri(),e)}doWrite(e,t){const r=this.request({method:"POST",data:e}),n=this;r.on("success",t),r.on("error",(function(e){n.onError("xhr post error",e)}))}doPoll(){c("xhr poll");const e=this.request(),t=this;e.on("data",(function(e){t.onData(e)})),e.on("error",(function(e){t.onError("xhr poll error",e)})),this.pollXhr=e}},e.exports.Request=d},function(e,t,r){const{PACKET_TYPES:n}=r(28),i="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),o="function"==typeof ArrayBuffer,s=(e,t)=>{const r=new FileReader;return r.onload=function(){const e=r.result.split(",")[1];t("b"+e)},r.readAsDataURL(e)};e.exports=({type:e,data:t},r,a)=>{return i&&t instanceof Blob?r?a(t):s(t,a):o&&(t instanceof ArrayBuffer||(c=t,"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(c):c&&c.buffer instanceof ArrayBuffer))?r?a(t):s(new Blob([t]),a):a(n[e]+(t||""));var c}},function(e,t,r){const{PACKET_TYPES_REVERSE:n,ERROR_PACKET:i}=r(28);let o;"function"==typeof ArrayBuffer&&(o=r(52));const s=(e,t)=>{if(o){const r=o.decode(e);return a(r,t)}return{base64:!0,data:e}},a=(e,t)=>{switch(t){case"blob":return e instanceof ArrayBuffer?new Blob([e]):e;case"arraybuffer":default:return e}};e.exports=(e,t)=>{if("string"!=typeof e)return{type:"message",data:a(e,t)};const r=e.charAt(0);return"b"===r?{type:"message",data:s(e.substring(1),t)}:n[r]?e.length>1?{type:n[r],data:e.substring(1)}:{type:n[r]}:i}},function(e,t){!function(e){"use strict";t.encode=function(t){var r,n=new Uint8Array(t),i=n.length,o="";for(r=0;r<i;r+=3)o+=e[n[r]>>2],o+=e[(3&n[r])<<4|n[r+1]>>4],o+=e[(15&n[r+1])<<2|n[r+2]>>6],o+=e[63&n[r+2]];return i%3==2?o=o.substring(0,o.length-1)+"=":i%3==1&&(o=o.substring(0,o.length-2)+"=="),o},t.decode=function(t){var r,n,i,o,s,a=.75*t.length,c=t.length,u=0;"="===t[t.length-1]&&(a--,"="===t[t.length-2]&&a--);var l=new ArrayBuffer(a),d=new Uint8Array(l);for(r=0;r<c;r+=4)n=e.indexOf(t[r]),i=e.indexOf(t[r+1]),o=e.indexOf(t[r+2]),s=e.indexOf(t[r+3]),d[u++]=n<<2|i>>4,d[u++]=(15&i)<<4|o>>2,d[u++]=(3&o)<<6|63&s;return l}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")},function(e,t,r){const n=r(27),i=r(14),o=/\n/g,s=/\\n/g;let a;e.exports=class extends n{constructor(e){super(e),this.query=this.query||{},a||(a=i.___eio=i.___eio||[]),this.index=a.length;const t=this;a.push((function(e){t.onData(e)})),this.query.j=this.index}get supportsBinary(){return!1}doClose(){this.script&&(this.script.onerror=()=>{},this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),super.doClose()}doPoll(){const e=this,t=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.uri(),t.onerror=function(t){e.onError("jsonp poll error",t)};const r=document.getElementsByTagName("script")[0];r?r.parentNode.insertBefore(t,r):(document.head||document.body).appendChild(t),this.script=t,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout((function(){const e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)}),100)}doWrite(e,t){const r=this;let n;if(!this.form){const e=document.createElement("form"),t=document.createElement("textarea"),r=this.iframeId="eio_iframe_"+this.index;e.className="socketio",e.style.position="absolute",e.style.top="-1000px",e.style.left="-1000px",e.target=r,e.method="POST",e.setAttribute("accept-charset","utf-8"),t.name="d",e.appendChild(t),document.body.appendChild(e),this.form=e,this.area=t}function i(){a(),t()}function a(){if(r.iframe)try{r.form.removeChild(r.iframe)}catch(e){r.onError("jsonp polling iframe removal error",e)}try{const e='<iframe src="javascript:0" name="'+r.iframeId+'">';n=document.createElement(e)}catch(e){n=document.createElement("iframe"),n.name=r.iframeId,n.src="javascript:0"}n.id=r.iframeId,r.form.appendChild(n),r.iframe=n}this.form.action=this.uri(),a(),e=e.replace(s,"\\\n"),this.area.value=e.replace(o,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===r.iframe.readyState&&i()}:this.iframe.onload=i}}},function(e,t,r){const n=r(16),i=r(11),o=r(17),s=r(29),{pick:a}=r(30),{WebSocket:c,usingBrowserWebSocket:u,defaultBinaryType:l}=r(55),d=r(4)("engine.io-client:websocket"),h="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class f extends n{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,r=h?{}:a(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(r.headers=this.opts.extraHeaders);try{this.ws=u&&!h?t?new c(e,t):new c(e):new c(e,t,r)}catch(e){return this.emit("error",e)}this.ws.binaryType=this.socket.binaryType||l,this.addEventListeners()}addEventListeners(){const e=this;this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(){e.onClose()},this.ws.onmessage=function(t){e.onData(t.data)},this.ws.onerror=function(t){e.onError("websocket error",t)}}write(e){const t=this;this.writable=!1;let r=e.length,n=0;const o=r;for(;n<o;n++)!function(e){i.encodePacket(e,t.supportsBinary,(function(n){const i={};!u&&(e.options&&(i.compress=e.options.compress),t.opts.perMessageDeflate)&&("string"==typeof n?Buffer.byteLength(n):n.length)<t.opts.perMessageDeflate.threshold&&(i.compress=!1);try{u?t.ws.send(n):t.ws.send(n,i)}catch(e){d("websocket closed before onclose event")}--r||(t.emit("flush"),setTimeout((function(){t.writable=!0,t.emit("drain")}),0))}))}(e[n])}onClose(){n.prototype.onClose.call(this)}doClose(){void 0!==this.ws&&(this.ws.close(),this.ws=null)}uri(){let e=this.query||{};const t=this.opts.secure?"wss":"ws";let r="";return this.opts.port&&("wss"===t&&443!==Number(this.opts.port)||"ws"===t&&80!==Number(this.opts.port))&&(r=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=s()),this.supportsBinary||(e.b64=1),e=o.encode(e),e.length&&(e="?"+e),t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+r+this.opts.path+e}check(){return!(!c||"__initialize"in c&&this.name===f.prototype.name)}}e.exports=f},function(e,t,r){const n=r(14);e.exports={WebSocket:n.WebSocket||n.MozWebSocket,usingBrowserWebSocket:!0,defaultBinaryType:"arraybuffer"}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reconstructPacket=t.deconstructPacket=void 0;const n=r(32);t.deconstructPacket=function(e){const t=[],r=e.data,i=e;return i.data=function e(t,r){if(!t)return t;if(n.isBinary(t)){const e={_placeholder:!0,num:r.length};return r.push(t),e}if(Array.isArray(t)){const n=new Array(t.length);for(let i=0;i<t.length;i++)n[i]=e(t[i],r);return n}if("object"==typeof t&&!(t instanceof Date)){const n={};for(const i in t)t.hasOwnProperty(i)&&(n[i]=e(t[i],r));return n}return t}(r,t),i.attachments=t.length,{packet:i,buffers:t}},t.reconstructPacket=function(e,t){return e.data=function e(t,r){if(!t)return t;if(t&&t._placeholder)return r[t.num];if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]=e(t[n],r);else if("object"==typeof t)for(const n in t)t.hasOwnProperty(n)&&(t[n]=e(t[n],r));return t}(e.data,t),e.attachments=void 0,e}},function(e,t){function r(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}e.exports=r,r.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),r=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-r:e+r}return 0|Math.min(e,this.max)},r.prototype.reset=function(){this.attempts=0},r.prototype.setMin=function(e){this.ms=e},r.prototype.setMax=function(e){this.max=e},r.prototype.setJitter=function(e){this.jitter=e}},function(e,t,r){var n=r(59),i=r(5);t.protocol=5;var o=t.PacketType={CONNECT:0,DISCONNECT:1,EVENT:2,ACK:3,CONNECT_ERROR:4},s=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},a=function(e){return"string"==typeof e},c=function(e){return"[object Object]"===Object.prototype.toString.call(e)};function u(){}function l(){}u.prototype.encode=function(e){return[n.encode(e)]},i(l.prototype),l.prototype.add=function(e){var t=n.decode(e);this.checkPacket(t),this.emit("decoded",t)},l.prototype.checkPacket=function(e){if(!(s(e.type)&&e.type>=o.CONNECT&&e.type<=o.CONNECT_ERROR))throw new Error("invalid packet type");if(!a(e.nsp))throw new Error("invalid namespace");if(!function(e){switch(e.type){case o.CONNECT:return void 0===e.data||c(e.data);case o.DISCONNECT:return void 0===e.data;case o.CONNECT_ERROR:return a(e.data)||c(e.data);default:return Array.isArray(e.data)}}(e))throw new Error("invalid payload");if(void 0!==e.id&&!s(e.id))throw new Error("invalid packet id")},l.prototype.destroy=function(){},t.Encoder=u,t.Decoder=l},function(e,t,r){t.encode=r(60),t.decode=r(61)},function(e,t,r){"use strict";function n(e,t,r){for(var n=0,i=0,o=r.length;i<o;i++)(n=r.charCodeAt(i))<128?e.setUint8(t++,n):n<2048?(e.setUint8(t++,192|n>>6),e.setUint8(t++,128|63&n)):n<55296||n>=57344?(e.setUint8(t++,224|n>>12),e.setUint8(t++,128|n>>6&63),e.setUint8(t++,128|63&n)):(i++,n=65536+((1023&n)<<10|1023&r.charCodeAt(i)),e.setUint8(t++,240|n>>18),e.setUint8(t++,128|n>>12&63),e.setUint8(t++,128|n>>6&63),e.setUint8(t++,128|63&n))}e.exports=function(e){var t=[],r=[],i=function e(t,r,n){var i=typeof n,o=0,s=0,a=0,c=0,u=0,l=0;if("string"===i){if((u=function(e){for(var t=0,r=0,n=0,i=e.length;n<i;n++)(t=e.charCodeAt(n))<128?r+=1:t<2048?r+=2:t<55296||t>=57344?r+=3:(n++,r+=4);return r}(n))<32)t.push(160|u),l=1;else if(u<256)t.push(217,u),l=2;else if(u<65536)t.push(218,u>>8,u),l=3;else{if(!(u<4294967296))throw new Error("String too long");t.push(219,u>>24,u>>16,u>>8,u),l=5}return r.push({_str:n,_length:u,_offset:t.length}),l+u}if("number"===i)return Math.floor(n)===n&&isFinite(n)?n>=0?n<128?(t.push(n),1):n<256?(t.push(204,n),2):n<65536?(t.push(205,n>>8,n),3):n<4294967296?(t.push(206,n>>24,n>>16,n>>8,n),5):(a=n/Math.pow(2,32)>>0,c=n>>>0,t.push(207,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),9):n>=-32?(t.push(n),1):n>=-128?(t.push(208,n),2):n>=-32768?(t.push(209,n>>8,n),3):n>=-2147483648?(t.push(210,n>>24,n>>16,n>>8,n),5):(a=Math.floor(n/Math.pow(2,32)),c=n>>>0,t.push(211,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),9):(t.push(203),r.push({_float:n,_length:8,_offset:t.length}),9);if("object"===i){if(null===n)return t.push(192),1;if(Array.isArray(n)){if((u=n.length)<16)t.push(144|u),l=1;else if(u<65536)t.push(220,u>>8,u),l=3;else{if(!(u<4294967296))throw new Error("Array too large");t.push(221,u>>24,u>>16,u>>8,u),l=5}for(o=0;o<u;o++)l+=e(t,r,n[o]);return l}if(n instanceof Date){var d=n.getTime();return a=Math.floor(d/Math.pow(2,32)),c=d>>>0,t.push(215,0,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),10}if(n instanceof ArrayBuffer){if((u=n.byteLength)<256)t.push(196,u),l=2;else if(u<65536)t.push(197,u>>8,u),l=3;else{if(!(u<4294967296))throw new Error("Buffer too large");t.push(198,u>>24,u>>16,u>>8,u),l=5}return r.push({_bin:n,_length:u,_offset:t.length}),l+u}if("function"==typeof n.toJSON)return e(t,r,n.toJSON());var h=[],f="",p=Object.keys(n);for(o=0,s=p.length;o<s;o++)"function"!=typeof n[f=p[o]]&&h.push(f);if((u=h.length)<16)t.push(128|u),l=1;else if(u<65536)t.push(222,u>>8,u),l=3;else{if(!(u<4294967296))throw new Error("Object too large");t.push(223,u>>24,u>>16,u>>8,u),l=5}for(o=0;o<u;o++)l+=e(t,r,f=h[o]),l+=e(t,r,n[f]);return l}if("boolean"===i)return t.push(n?195:194),1;if("undefined"===i)return t.push(212,0,0),3;throw new Error("Could not encode")}(t,r,e),o=new ArrayBuffer(i),s=new DataView(o),a=0,c=0,u=-1;r.length>0&&(u=r[0]._offset);for(var l,d=0,h=0,f=0,p=t.length;f<p;f++)if(s.setUint8(c+f,t[f]),f+1===u){if(d=(l=r[a])._length,h=c+u,l._bin)for(var m=new Uint8Array(l._bin),g=0;g<d;g++)s.setUint8(h+g,m[g]);else l._str?n(s,h,l._str):void 0!==l._float&&s.setFloat64(h,l._float);c+=d,r[++a]&&(u=r[a]._offset)}return o}},function(e,t,r){"use strict";function n(e){if(this._offset=0,e instanceof ArrayBuffer)this._buffer=e,this._view=new DataView(this._buffer);else{if(!ArrayBuffer.isView(e))throw new Error("Invalid argument");this._buffer=e.buffer,this._view=new DataView(this._buffer,e.byteOffset,e.byteLength)}}n.prototype._array=function(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=this._parse();return t},n.prototype._map=function(e){for(var t={},r=0;r<e;r++)t[this._parse()]=this._parse();return t},n.prototype._str=function(e){var t=function(e,t,r){for(var n="",i=0,o=t,s=t+r;o<s;o++){var a=e.getUint8(o);if(0!=(128&a))if(192!=(224&a))if(224!=(240&a)){if(240!=(248&a))throw new Error("Invalid byte "+a.toString(16));(i=(7&a)<<18|(63&e.getUint8(++o))<<12|(63&e.getUint8(++o))<<6|(63&e.getUint8(++o))<<0)>=65536?(i-=65536,n+=String.fromCharCode(55296+(i>>>10),56320+(1023&i))):n+=String.fromCharCode(i)}else n+=String.fromCharCode((15&a)<<12|(63&e.getUint8(++o))<<6|(63&e.getUint8(++o))<<0);else n+=String.fromCharCode((31&a)<<6|63&e.getUint8(++o));else n+=String.fromCharCode(a)}return n}(this._view,this._offset,e);return this._offset+=e,t},n.prototype._bin=function(e){var t=this._buffer.slice(this._offset,this._offset+e);return this._offset+=e,t},n.prototype._parse=function(){var e,t=this._view.getUint8(this._offset++),r=0,n=0,i=0,o=0;if(t<192)return t<128?t:t<144?this._map(15&t):t<160?this._array(15&t):this._str(31&t);if(t>223)return-1*(255-t+1);switch(t){case 192:return null;case 194:return!1;case 195:return!0;case 196:return r=this._view.getUint8(this._offset),this._offset+=1,this._bin(r);case 197:return r=this._view.getUint16(this._offset),this._offset+=2,this._bin(r);case 198:return r=this._view.getUint32(this._offset),this._offset+=4,this._bin(r);case 199:return r=this._view.getUint8(this._offset),n=this._view.getInt8(this._offset+1),this._offset+=2,[n,this._bin(r)];case 200:return r=this._view.getUint16(this._offset),n=this._view.getInt8(this._offset+2),this._offset+=3,[n,this._bin(r)];case 201:return r=this._view.getUint32(this._offset),n=this._view.getInt8(this._offset+4),this._offset+=5,[n,this._bin(r)];case 202:return e=this._view.getFloat32(this._offset),this._offset+=4,e;case 203:return e=this._view.getFloat64(this._offset),this._offset+=8,e;case 204:return e=this._view.getUint8(this._offset),this._offset+=1,e;case 205:return e=this._view.getUint16(this._offset),this._offset+=2,e;case 206:return e=this._view.getUint32(this._offset),this._offset+=4,e;case 207:return i=this._view.getUint32(this._offset)*Math.pow(2,32),o=this._view.getUint32(this._offset+4),this._offset+=8,i+o;case 208:return e=this._view.getInt8(this._offset),this._offset+=1,e;case 209:return e=this._view.getInt16(this._offset),this._offset+=2,e;case 210:return e=this._view.getInt32(this._offset),this._offset+=4,e;case 211:return i=this._view.getInt32(this._offset)*Math.pow(2,32),o=this._view.getUint32(this._offset+4),this._offset+=8,i+o;case 212:return n=this._view.getInt8(this._offset),this._offset+=1,0===n?void(this._offset+=1):[n,this._bin(1)];case 213:return n=this._view.getInt8(this._offset),this._offset+=1,[n,this._bin(2)];case 214:return n=this._view.getInt8(this._offset),this._offset+=1,[n,this._bin(4)];case 215:return n=this._view.getInt8(this._offset),this._offset+=1,0===n?(i=this._view.getInt32(this._offset)*Math.pow(2,32),o=this._view.getUint32(this._offset+4),this._offset+=8,new Date(i+o)):[n,this._bin(8)];case 216:return n=this._view.getInt8(this._offset),this._offset+=1,[n,this._bin(16)];case 217:return r=this._view.getUint8(this._offset),this._offset+=1,this._str(r);case 218:return r=this._view.getUint16(this._offset),this._offset+=2,this._str(r);case 219:return r=this._view.getUint32(this._offset),this._offset+=4,this._str(r);case 220:return r=this._view.getUint16(this._offset),this._offset+=2,this._array(r);case 221:return r=this._view.getUint32(this._offset),this._offset+=4,this._array(r);case 222:return r=this._view.getUint16(this._offset),this._offset+=2,this._map(r);case 223:return r=this._view.getUint32(this._offset),this._offset+=4,this._map(r)}throw new Error("Could not parse")},e.exports=function(e){var t=new n(e),r=t._parse();if(t._offset!==e.byteLength)throw new Error(e.byteLength-t._offset+" trailing bytes");return r}},function(e,t,r){"use strict";r.r(t),r.d(t,"Dexie",(function(){return Vr})),r.d(t,"RangeSet",(function(){return jr})),r.d(t,"default",(function(){return Vr})),r.d(t,"liveQuery",(function(){return Qr})),r.d(t,"mergeRanges",(function(){return Ur})),r.d(t,"rangesOverlap",(function(){return $r}));var n=function(){return(n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function i(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}var o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:global,s=Object.keys,a=Array.isArray;function c(e,t){return"object"!=typeof t||s(t).forEach((function(r){e[r]=t[r]})),e}"undefined"==typeof Promise||o.Promise||(o.Promise=Promise);var u=Object.getPrototypeOf,l={}.hasOwnProperty;function d(e,t){return l.call(e,t)}function h(e,t){"function"==typeof t&&(t=t(u(e))),("undefined"==typeof Reflect?s:Reflect.ownKeys)(t).forEach((function(r){p(e,r,t[r])}))}var f=Object.defineProperty;function p(e,t,r,n){f(e,t,c(r&&d(r,"get")&&"function"==typeof r.get?{get:r.get,set:r.set,configurable:!0}:{value:r,configurable:!0,writable:!0},n))}function m(e){return{from:function(t){return e.prototype=Object.create(t.prototype),p(e.prototype,"constructor",e),{extend:h.bind(null,e.prototype)}}}}var g=Object.getOwnPropertyDescriptor;function v(e,t){var r;return g(e,t)||(r=u(e))&&v(r,t)}var y=[].slice;function b(e,t,r){return y.call(e,t,r)}function R(e,t){return t(e)}function _(e){if(!e)throw new Error("Assertion Failed")}function C(e){o.setImmediate?setImmediate(e):setTimeout(e,0)}function S(e,t){return e.reduce((function(e,r,n){var i=t(r,n);return i&&(e[i[0]]=i[1]),e}),{})}function T(e,t){if(d(e,t))return e[t];if(!t)return e;if("string"!=typeof t){for(var r=[],n=0,i=t.length;n<i;++n){var o=T(e,t[n]);r.push(o)}return r}var s=t.indexOf(".");if(-1!==s){var a=e[t.substr(0,s)];return void 0===a?void 0:T(a,t.substr(s+1))}}function w(e,t,r){if(e&&void 0!==t&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if("string"!=typeof t&&"length"in t){_("string"!=typeof r&&"length"in r);for(var n=0,i=t.length;n<i;++n)w(e,t[n],r[n])}else{var o=t.indexOf(".");if(-1!==o){var s=t.substr(0,o),c=t.substr(o+1);if(""===c)void 0===r?a(e)&&!isNaN(parseInt(s))?e.splice(s,1):delete e[s]:e[s]=r;else{var u=e[s];u||(u=e[s]={}),w(u,c,r)}}else void 0===r?a(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=r}}function D(e){var t={};for(var r in e)d(e,r)&&(t[r]=e[r]);return t}var P=[].concat;function k(e){return P.apply([],e)}var E="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(k([8,16,32,64].map((function(e){return["Int","Uint","Float"].map((function(t){return t+e+"Array"}))})))).filter((function(e){return o[e]})),I=E.map((function(e){return o[e]}));S(E,(function(e){return[e,!0]}));var O=null;function B(e){O="undefined"!=typeof WeakMap&&new WeakMap;var t=function e(t){if(!t||"object"!=typeof t)return t;var r=O&&O.get(t);if(r)return r;if(a(t)){r=[],O&&O.set(t,r);for(var n=0,i=t.length;n<i;++n)r.push(e(t[n]))}else if(I.indexOf(t.constructor)>=0)r=t;else{var o=u(t);for(var s in r=o===Object.prototype?{}:Object.create(o),O&&O.set(t,r),t)d(t,s)&&(r[s]=e(t[s]))}return r}(e);return O=null,t}var x={}.toString;function A(e){return x.call(e).slice(8,-1)}var L="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator",N="symbol"==typeof L?function(e){var t;return null!=e&&(t=e[L])&&t.apply(e)}:function(){return null},M={};function j(e){var t,r,n,i;if(1===arguments.length){if(a(e))return e.slice();if(this===M&&"string"==typeof e)return[e];if(i=N(e)){for(r=[];!(n=i.next()).done;)r.push(n.value);return r}if(null==e)return[e];if("number"==typeof(t=e.length)){for(r=new Array(t);t--;)r[t]=e[t];return r}return[e]}for(t=arguments.length,r=new Array(t);t--;)r[t]=arguments[t];return r}var F="undefined"!=typeof Symbol?function(e){return"AsyncFunction"===e[Symbol.toStringTag]}:function(){return!1},U="undefined"!=typeof location&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function $(e,t){U=e,W=t}var W=function(){return!0},G=!new Error("").stack;function K(){if(G)try{throw K.arguments,new Error}catch(e){return e}return new Error}function z(e,t){var r=e.stack;return r?(t=t||0,0===r.indexOf(e.name)&&(t+=(e.name+e.message).split("\n").length),r.split("\n").slice(t).filter(W).map((function(e){return"\n"+e})).join("")):""}var q=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],V=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(q),H={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function J(e,t){this._e=K(),this.name=e,this.message=t}function Y(e,t){return e+". Errors: "+Object.keys(t).map((function(e){return t[e].toString()})).filter((function(e,t,r){return r.indexOf(e)===t})).join("\n")}function Q(e,t,r,n){this._e=K(),this.failures=t,this.failedKeys=n,this.successCount=r,this.message=Y(e,t)}function X(e,t){this._e=K(),this.name="BulkError",this.failures=Object.keys(t).map((function(e){return t[e]})),this.failuresByPos=t,this.message=Y(e,t)}m(J).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+z(this._e,2))}},toString:function(){return this.name+": "+this.message}}),m(Q).from(J),m(X).from(J);var Z=V.reduce((function(e,t){return e[t]=t+"Error",e}),{}),ee=J,te=V.reduce((function(e,t){var r=t+"Error";function n(e,n){this._e=K(),this.name=r,e?"string"==typeof e?(this.message=e+(n?"\n "+n:""),this.inner=n||null):"object"==typeof e&&(this.message=e.name+" "+e.message,this.inner=e):(this.message=H[t]||r,this.inner=null)}return m(n).from(ee),e[t]=n,e}),{});te.Syntax=SyntaxError,te.Type=TypeError,te.Range=RangeError;var re=q.reduce((function(e,t){return e[t+"Error"]=te[t],e}),{}),ne=V.reduce((function(e,t){return-1===["Syntax","Type","Range"].indexOf(t)&&(e[t+"Error"]=te[t]),e}),{});function ie(){}function oe(e){return e}function se(e,t){return null==e||e===oe?t:function(r){return t(e(r))}}function ae(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function ce(e,t){return e===ie?t:function(){var r=e.apply(this,arguments);void 0!==r&&(arguments[0]=r);var n=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var o=t.apply(this,arguments);return n&&(this.onsuccess=this.onsuccess?ae(n,this.onsuccess):n),i&&(this.onerror=this.onerror?ae(i,this.onerror):i),void 0!==o?o:r}}function ue(e,t){return e===ie?t:function(){e.apply(this,arguments);var r=this.onsuccess,n=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),r&&(this.onsuccess=this.onsuccess?ae(r,this.onsuccess):r),n&&(this.onerror=this.onerror?ae(n,this.onerror):n)}}function le(e,t){return e===ie?t:function(r){var n=e.apply(this,arguments);c(r,n);var i=this.onsuccess,o=this.onerror;this.onsuccess=null,this.onerror=null;var s=t.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?ae(i,this.onsuccess):i),o&&(this.onerror=this.onerror?ae(o,this.onerror):o),void 0===n?void 0===s?void 0:s:c(n,s)}}function de(e,t){return e===ie?t:function(){return!1!==t.apply(this,arguments)&&e.apply(this,arguments)}}function he(e,t){return e===ie?t:function(){var r=e.apply(this,arguments);if(r&&"function"==typeof r.then){for(var n=this,i=arguments.length,o=new Array(i);i--;)o[i]=arguments[i];return r.then((function(){return t.apply(n,o)}))}return t.apply(this,arguments)}}ne.ModifyError=Q,ne.DexieError=J,ne.BulkError=X;var fe={},pe="undefined"==typeof Promise?[]:function(){var e=Promise.resolve();if("undefined"==typeof crypto||!crypto.subtle)return[e,u(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,u(t),e]}(),me=pe[0],ge=pe[1],ve=pe[2],ye=ge&&ge.then,be=me&&me.constructor,Re=!!ve,_e=!1,Ce=ve?function(){ve.then(Ke)}:o.setImmediate?setImmediate.bind(null,Ke):o.MutationObserver?function(){var e=document.createElement("div");new MutationObserver((function(){Ke(),e=null})).observe(e,{attributes:!0}),e.setAttribute("i","1")}:function(){setTimeout(Ke,0)},Se=function(e,t){Be.push([e,t]),we&&(Ce(),we=!1)},Te=!0,we=!0,De=[],Pe=[],ke=null,Ee=oe,Ie={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:pt,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach((function(e){try{pt(e[0],e[1])}catch(e){}}))}},Oe=Ie,Be=[],xe=0,Ae=[];function Le(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=ie,this._lib=!1;var t=this._PSD=Oe;if(U&&(this._stackHolder=K(),this._prev=null,this._numPrev=0),"function"!=typeof e){if(e!==fe)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(!1===this._state&&Fe(this,this._value))}this._state=null,this._value=null,++t.ref,je(this,e)}var Ne={get:function(){var e=Oe,t=et;function r(r,n){var i=this,o=!e.global&&(e!==Oe||t!==et),s=o&&!it(),a=new Le((function(t,a){$e(i,new Me(ht(r,e,o,s),ht(n,e,o,s),t,a,e))}));return U&&Ge(a,this),a}return r.prototype=fe,r},set:function(e){p(this,"then",e&&e.prototype===fe?Ne:{get:function(){return e},set:Ne.set})}};function Me(e,t,r,n,i){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.resolve=r,this.reject=n,this.psd=i}function je(e,t){try{t((function(t){if(null===e._state){if(t===e)throw new TypeError("A promise cannot be resolved with itself.");var r=e._lib&&ze();t&&"function"==typeof t.then?je(e,(function(e,r){t instanceof Le?t._then(e,r):t.then(e,r)})):(e._state=!0,e._value=t,Ue(e)),r&&qe()}}),Fe.bind(null,e))}catch(t){Fe(e,t)}}function Fe(e,t){if(Pe.push(t),null===e._state){var r=e._lib&&ze();t=Ee(t),e._state=!1,e._value=t,U&&null!==t&&"object"==typeof t&&!t._promise&&function(e,t,r){try{e.apply(null,r)}catch(e){t&&t(e)}}((function(){var r=v(t,"stack");t._promise=e,p(t,"stack",{get:function(){return _e?r&&(r.get?r.get.apply(t):r.value):e.stack}})})),function(e){De.some((function(t){return t._value===e._value}))||De.push(e)}(e),Ue(e),r&&qe()}}function Ue(e){var t=e._listeners;e._listeners=[];for(var r=0,n=t.length;r<n;++r)$e(e,t[r]);var i=e._PSD;--i.ref||i.finalize(),0===xe&&(++xe,Se((function(){0==--xe&&Ve()}),[]))}function $e(e,t){if(null!==e._state){var r=e._state?t.onFulfilled:t.onRejected;if(null===r)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++xe,Se(We,[r,e,t])}else e._listeners.push(t)}function We(e,t,r){try{ke=t;var n,i=t._value;t._state?n=e(i):(Pe.length&&(Pe=[]),n=e(i),-1===Pe.indexOf(i)&&function(e){for(var t=De.length;t;)if(De[--t]._value===e._value)return void De.splice(t,1)}(t)),r.resolve(n)}catch(e){r.reject(e)}finally{ke=null,0==--xe&&Ve(),--r.psd.ref||r.psd.finalize()}}function Ge(e,t){var r=t?t._numPrev+1:0;r<100&&(e._prev=t,e._numPrev=r)}function Ke(){ze()&&qe()}function ze(){var e=Te;return Te=!1,we=!1,e}function qe(){var e,t,r;do{for(;Be.length>0;)for(e=Be,Be=[],r=e.length,t=0;t<r;++t){var n=e[t];n[0].apply(null,n[1])}}while(Be.length>0);Te=!0,we=!0}function Ve(){var e=De;De=[],e.forEach((function(e){e._PSD.onunhandled.call(null,e._value,e)}));for(var t=Ae.slice(0),r=t.length;r;)t[--r]()}function He(e){return new Le(fe,!1,e)}function Je(e,t){var r=Oe;return function(){var n=ze(),i=Oe;try{return ct(r,!0),e.apply(this,arguments)}catch(e){t&&t(e)}finally{ct(i,!1),n&&qe()}}}h(Le.prototype,{then:Ne,_then:function(e,t){$e(this,new Me(null,null,e,t,Oe))},catch:function(e){if(1===arguments.length)return this.then(null,e);var t=arguments[0],r=arguments[1];return"function"==typeof t?this.then(null,(function(e){return e instanceof t?r(e):He(e)})):this.then(null,(function(e){return e&&e.name===t?r(e):He(e)}))},finally:function(e){return this.then((function(t){return e(),t}),(function(t){return e(),He(t)}))},stack:{get:function(){if(this._stack)return this._stack;try{_e=!0;var e=function e(t,r,n){if(r.length===n)return r;var i="";if(!1===t._state){var o,s,a=t._value;null!=a?(o=a.name||"Error",s=a.message||a,i=z(a,0)):(o=a,s=""),r.push(o+(s?": "+s:"")+i)}return U&&((i=z(t._stackHolder,2))&&-1===r.indexOf(i)&&r.push(i),t._prev&&e(t._prev,r,n)),r}(this,[],20).join("\nFrom previous: ");return null!==this._state&&(this._stack=e),e}finally{_e=!1}}},timeout:function(e,t){var r=this;return e<1/0?new Le((function(n,i){var o=setTimeout((function(){return i(new te.Timeout(t))}),e);r.then(n,i).finally(clearTimeout.bind(null,o))})):this}}),"undefined"!=typeof Symbol&&Symbol.toStringTag&&p(Le.prototype,Symbol.toStringTag,"Dexie.Promise"),Ie.env=ut(),h(Le,{all:function(){var e=j.apply(null,arguments).map(ot);return new Le((function(t,r){0===e.length&&t([]);var n=e.length;e.forEach((function(i,o){return Le.resolve(i).then((function(r){e[o]=r,--n||t(e)}),r)}))}))},resolve:function(e){if(e instanceof Le)return e;if(e&&"function"==typeof e.then)return new Le((function(t,r){e.then(t,r)}));var t=new Le(fe,!0,e);return Ge(t,ke),t},reject:He,race:function(){var e=j.apply(null,arguments).map(ot);return new Le((function(t,r){e.map((function(e){return Le.resolve(e).then(t,r)}))}))},PSD:{get:function(){return Oe},set:function(e){return Oe=e}},totalEchoes:{get:function(){return et}},newPSD:rt,usePSD:lt,scheduler:{get:function(){return Se},set:function(e){Se=e}},rejectionMapper:{get:function(){return Ee},set:function(e){Ee=e}},follow:function(e,t){return new Le((function(r,n){return rt((function(t,r){var n=Oe;n.unhandleds=[],n.onunhandled=r,n.finalize=ae((function(){var e=this;!function(e){Ae.push((function t(){e(),Ae.splice(Ae.indexOf(t),1)})),++xe,Se((function(){0==--xe&&Ve()}),[])}((function(){0===e.unhandleds.length?t():r(e.unhandleds[0])}))}),n.finalize),e()}),t,r,n)}))}}),be&&(be.allSettled&&p(Le,"allSettled",(function(){var e=j.apply(null,arguments).map(ot);return new Le((function(t){0===e.length&&t([]);var r=e.length,n=new Array(r);e.forEach((function(e,i){return Le.resolve(e).then((function(e){return n[i]={status:"fulfilled",value:e}}),(function(e){return n[i]={status:"rejected",reason:e}})).then((function(){return--r||t(n)}))}))}))})),be.any&&"undefined"!=typeof AggregateError&&p(Le,"any",(function(){var e=j.apply(null,arguments).map(ot);return new Le((function(t,r){0===e.length&&r(new AggregateError([]));var n=e.length,i=new Array(n);e.forEach((function(e,o){return Le.resolve(e).then((function(e){return t(e)}),(function(e){i[o]=e,--n||r(new AggregateError(i))}))}))}))})));var Ye={awaits:0,echoes:0,id:0},Qe=0,Xe=[],Ze=0,et=0,tt=0;function rt(e,t,r,n){var i=Oe,o=Object.create(i);o.parent=i,o.ref=0,o.global=!1,o.id=++tt;var s=Ie.env;o.env=Re?{Promise:Le,PromiseProp:{value:Le,configurable:!0,writable:!0},all:Le.all,race:Le.race,allSettled:Le.allSettled,any:Le.any,resolve:Le.resolve,reject:Le.reject,nthen:ft(s.nthen,o),gthen:ft(s.gthen,o)}:{},t&&c(o,t),++i.ref,o.finalize=function(){--this.parent.ref||this.parent.finalize()};var a=lt(o,e,r,n);return 0===o.ref&&o.finalize(),a}function nt(){return Ye.id||(Ye.id=++Qe),++Ye.awaits,Ye.echoes+=100,Ye.id}function it(){return!!Ye.awaits&&(0==--Ye.awaits&&(Ye.id=0),Ye.echoes=100*Ye.awaits,!0)}function ot(e){return Ye.echoes&&e&&e.constructor===be?(nt(),e.then((function(e){return it(),e}),(function(e){return it(),mt(e)}))):e}function st(e){++et,Ye.echoes&&0!=--Ye.echoes||(Ye.echoes=Ye.id=0),Xe.push(Oe),ct(e,!0)}function at(){var e=Xe[Xe.length-1];Xe.pop(),ct(e,!1)}function ct(e,t){var r=Oe;if((t?!Ye.echoes||Ze++&&e===Oe:!Ze||--Ze&&e===Oe)||dt(t?st.bind(null,e):at),e!==Oe&&(Oe=e,r===Ie&&(Ie.env=ut()),Re)){var n=Ie.env.Promise,i=e.env;ge.then=i.nthen,n.prototype.then=i.gthen,(r.global||e.global)&&(Object.defineProperty(o,"Promise",i.PromiseProp),n.all=i.all,n.race=i.race,n.resolve=i.resolve,n.reject=i.reject,i.allSettled&&(n.allSettled=i.allSettled),i.any&&(n.any=i.any))}}function ut(){var e=o.Promise;return Re?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(o,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject,nthen:ge.then,gthen:e.prototype.then}:{}}function lt(e,t,r,n,i){var o=Oe;try{return ct(e,!0),t(r,n,i)}finally{ct(o,!1)}}function dt(e){ye.call(me,e)}function ht(e,t,r,n){return"function"!=typeof e?e:function(){var i=Oe;r&&nt(),ct(t,!0);try{return e.apply(this,arguments)}finally{ct(i,!1),n&&dt(it)}}}function ft(e,t){return function(r,n){return e.call(this,ht(r,t),ht(n,t))}}function pt(e,t){var r;try{r=t.onuncatched(e)}catch(e){}if(!1!==r)try{var n,i={promise:t,reason:e};if(o.document&&document.createEvent?((n=document.createEvent("Event")).initEvent("unhandledrejection",!0,!0),c(n,i)):o.CustomEvent&&c(n=new CustomEvent("unhandledrejection",{detail:i}),i),n&&o.dispatchEvent&&(dispatchEvent(n),!o.PromiseRejectionEvent&&o.onunhandledrejection))try{o.onunhandledrejection(n)}catch(e){}U&&n&&!n.defaultPrevented&&console.warn("Unhandled rejection: "+(e.stack||e))}catch(e){}}-1===(""+ye).indexOf("[native code]")&&(nt=it=ie);var mt=Le.reject,gt=String.fromCharCode(65535),vt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",yt=[],bt="undefined"!=typeof navigator&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),Rt=bt,_t=bt,Ct=function(e){return!/(dexie\.js|dexie\.min\.js)/.test(e)};function St(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var Tt={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function wt(e){return"string"!=typeof e||/\./.test(e)?function(e){return e}:function(t){return void 0===t[e]&&e in t&&delete(t=B(t))[e],t}}var Dt=function(){function e(){}return e.prototype._trans=function(e,t,r){var n=this._tx||Oe.trans,i=this.name;function o(e,r,n){if(!n.schema[i])throw new te.NotFound("Table "+i+" not part of transaction");return t(n.idbtrans,n)}var s=ze();try{return n&&n.db===this.db?n===Oe.trans?n._promise(e,o,r):rt((function(){return n._promise(e,o,r)}),{trans:n,transless:Oe.transless||Oe}):function e(t,r,n,i){if(t.idbdb&&(t._state.openComplete||Oe.letThrough||t._vip)){var o=t._createTransaction(r,n,t._dbSchema);try{o.create(),t._state.PR1398_maxLoop=3}catch(o){return o.name===Z.InvalidState&&t.isOpen()&&--t._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),t._close(),t.open().then((function(){return e(t,r,n,i)}))):mt(o)}return o._promise(r,(function(e,t){return rt((function(){return Oe.trans=o,i(e,t,o)}))})).then((function(e){return o._completion.then((function(){return e}))}))}if(t._state.openComplete)return mt(new te.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._options.autoOpen)return mt(new te.DatabaseClosed);t.open().catch(ie)}return t._state.dbReadyPromise.then((function(){return e(t,r,n,i)}))}(this.db,e,[this.name],o)}finally{s&&qe()}},e.prototype.get=function(e,t){var r=this;return e&&e.constructor===Object?this.where(e).first(t):this._trans("readonly",(function(t){return r.core.get({trans:t,key:e}).then((function(e){return r.hook.reading.fire(e)}))})).then(t)},e.prototype.where=function(e){if("string"==typeof e)return new this.db.WhereClause(this,e);if(a(e))return new this.db.WhereClause(this,"["+e.join("+")+"]");var t=s(e);if(1===t.length)return this.where(t[0]).equals(e[t[0]]);var r=this.schema.indexes.concat(this.schema.primKey).filter((function(e){return e.compound&&t.every((function(t){return e.keyPath.indexOf(t)>=0}))&&e.keyPath.every((function(e){return t.indexOf(e)>=0}))}))[0];if(r&&this.db._maxKey!==gt)return this.where(r.name).equals(r.keyPath.map((function(t){return e[t]})));!r&&U&&console.warn("The query "+JSON.stringify(e)+" on "+this.name+" would benefit of a compound index ["+t.join("+")+"]");var n=this.schema.idxByName,i=this.db._deps.indexedDB;function o(e,t){try{return 0===i.cmp(e,t)}catch(e){return!1}}var c=t.reduce((function(t,r){var i=t[0],s=t[1],c=n[r],u=e[r];return[i||c,i||!c?St(s,c&&c.multi?function(e){var t=T(e,r);return a(t)&&t.some((function(e){return o(u,e)}))}:function(e){return o(u,T(e,r))}):s]}),[null,null]),u=c[0],l=c[1];return u?this.where(u.name).equals(e[u.keyPath]).filter(l):r?this.filter(l):this.where(t).equals("")},e.prototype.filter=function(e){return this.toCollection().and(e)},e.prototype.count=function(e){return this.toCollection().count(e)},e.prototype.offset=function(e){return this.toCollection().offset(e)},e.prototype.limit=function(e){return this.toCollection().limit(e)},e.prototype.each=function(e){return this.toCollection().each(e)},e.prototype.toArray=function(e){return this.toCollection().toArray(e)},e.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},e.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,a(e)?"["+e.join("+")+"]":e))},e.prototype.reverse=function(){return this.toCollection().reverse()},e.prototype.mapToClass=function(e){this.schema.mappedClass=e;var t=function(t){if(!t)return t;var r=Object.create(e.prototype);for(var n in t)if(d(t,n))try{r[n]=t[n]}catch(e){}return r};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=t,this.hook("reading",t),e},e.prototype.defineClass=function(){return this.mapToClass((function(e){c(this,e)}))},e.prototype.add=function(e,t){var r=this,n=this.schema.primKey,i=n.auto,o=n.keyPath,s=e;return o&&i&&(s=wt(o)(e)),this._trans("readwrite",(function(e){return r.core.mutate({trans:e,type:"add",keys:null!=t?[t]:null,values:[s]})})).then((function(e){return e.numFailures?Le.reject(e.failures[0]):e.lastResult})).then((function(t){if(o)try{w(e,o,t)}catch(e){}return t}))},e.prototype.update=function(e,t){if("object"!=typeof e||a(e))return this.where(":id").equals(e).modify(t);var r=T(e,this.schema.primKey.keyPath);if(void 0===r)return mt(new te.InvalidArgument("Given object does not contain its primary key"));try{"function"!=typeof t?s(t).forEach((function(r){w(e,r,t[r])})):t(e,{value:e,primKey:r})}catch(e){}return this.where(":id").equals(r).modify(t)},e.prototype.put=function(e,t){var r=this,n=this.schema.primKey,i=n.auto,o=n.keyPath,s=e;return o&&i&&(s=wt(o)(e)),this._trans("readwrite",(function(e){return r.core.mutate({trans:e,type:"put",values:[s],keys:null!=t?[t]:null})})).then((function(e){return e.numFailures?Le.reject(e.failures[0]):e.lastResult})).then((function(t){if(o)try{w(e,o,t)}catch(e){}return t}))},e.prototype.delete=function(e){var t=this;return this._trans("readwrite",(function(r){return t.core.mutate({trans:r,type:"delete",keys:[e]})})).then((function(e){return e.numFailures?Le.reject(e.failures[0]):void 0}))},e.prototype.clear=function(){var e=this;return this._trans("readwrite",(function(t){return e.core.mutate({trans:t,type:"deleteRange",range:Tt})})).then((function(e){return e.numFailures?Le.reject(e.failures[0]):void 0}))},e.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",(function(r){return t.core.getMany({keys:e,trans:r}).then((function(e){return e.map((function(e){return t.hook.reading.fire(e)}))}))}))},e.prototype.bulkAdd=function(e,t,r){var n=this,i=Array.isArray(t)?t:void 0,o=(r=r||(i?void 0:t))?r.allKeys:void 0;return this._trans("readwrite",(function(t){var r=n.schema.primKey,s=r.auto,a=r.keyPath;if(a&&i)throw new te.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(i&&i.length!==e.length)throw new te.InvalidArgument("Arguments objects and keys must have the same length");var c=e.length,u=a&&s?e.map(wt(a)):e;return n.core.mutate({trans:t,type:"add",keys:i,values:u,wantResults:o}).then((function(e){var t=e.numFailures,r=e.results,i=e.lastResult,s=e.failures;if(0===t)return o?r:i;throw new X(n.name+".bulkAdd(): "+t+" of "+c+" operations failed",s)}))}))},e.prototype.bulkPut=function(e,t,r){var n=this,i=Array.isArray(t)?t:void 0,o=(r=r||(i?void 0:t))?r.allKeys:void 0;return this._trans("readwrite",(function(t){var r=n.schema.primKey,s=r.auto,a=r.keyPath;if(a&&i)throw new te.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(i&&i.length!==e.length)throw new te.InvalidArgument("Arguments objects and keys must have the same length");var c=e.length,u=a&&s?e.map(wt(a)):e;return n.core.mutate({trans:t,type:"put",keys:i,values:u,wantResults:o}).then((function(e){var t=e.numFailures,r=e.results,i=e.lastResult,s=e.failures;if(0===t)return o?r:i;throw new X(n.name+".bulkPut(): "+t+" of "+c+" operations failed",s)}))}))},e.prototype.bulkDelete=function(e){var t=this,r=e.length;return this._trans("readwrite",(function(r){return t.core.mutate({trans:r,type:"delete",keys:e})})).then((function(e){var n=e.numFailures,i=e.lastResult,o=e.failures;if(0===n)return i;throw new X(t.name+".bulkDelete(): "+n+" of "+r+" operations failed",o)}))},e}();function Pt(e){var t={},r=function(r,n){if(n){for(var i=arguments.length,o=new Array(i-1);--i;)o[i-1]=arguments[i];return t[r].subscribe.apply(null,o),e}if("string"==typeof r)return t[r]};r.addEventType=o;for(var n=1,i=arguments.length;n<i;++n)o(arguments[n]);return r;function o(e,n,i){if("object"==typeof e)return c(e);n||(n=de),i||(i=ie);var o={subscribers:[],fire:i,subscribe:function(e){-1===o.subscribers.indexOf(e)&&(o.subscribers.push(e),o.fire=n(o.fire,e))},unsubscribe:function(e){o.subscribers=o.subscribers.filter((function(t){return t!==e})),o.fire=o.subscribers.reduce(n,i)}};return t[e]=r[e]=o,o}function c(e){s(e).forEach((function(t){var r=e[t];if(a(r))o(t,e[t][0],e[t][1]);else{if("asap"!==r)throw new te.InvalidArgument("Invalid event config");var n=o(t,oe,(function(){for(var e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];n.subscribers.forEach((function(e){C((function(){e.apply(null,t)}))}))}))}}))}}function kt(e,t){return m(t).from({prototype:e}),t}function Et(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function It(e,t){e.filter=St(e.filter,t)}function Ot(e,t,r){var n=e.replayFilter;e.replayFilter=n?function(){return St(n(),t())}:t,e.justLimit=r&&!n}function Bt(e,t){if(e.isPrimKey)return t.primaryKey;var r=t.getIndexByKeyPath(e.index);if(!r)throw new te.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return r}function xt(e,t,r){var n=Bt(e,t.schema);return t.openCursor({trans:r,values:!e.keysOnly,reverse:"prev"===e.dir,unique:!!e.unique,query:{index:n,range:e.range}})}function At(e,t,r,n){var i=e.replayFilter?St(e.filter,e.replayFilter()):e.filter;if(e.or){var o={},s=function(e,r,n){if(!i||i(r,n,(function(e){return r.stop(e)}),(function(e){return r.fail(e)}))){var s=r.primaryKey,a=""+s;"[object ArrayBuffer]"===a&&(a=""+new Uint8Array(s)),d(o,a)||(o[a]=!0,t(e,r,n))}};return Promise.all([e.or._iterate(s,r),Lt(xt(e,n,r),e.algorithm,s,!e.keysOnly&&e.valueMapper)])}return Lt(xt(e,n,r),St(e.algorithm,i),t,!e.keysOnly&&e.valueMapper)}function Lt(e,t,r,n){var i=Je(n?function(e,t,i){return r(n(e),t,i)}:r);return e.then((function(e){if(e)return e.start((function(){var r=function(){return e.continue()};t&&!t(e,(function(e){return r=e}),(function(t){e.stop(t),r=ie}),(function(t){e.fail(t),r=ie}))||i(e.value,e,(function(e){return r=e})),r()}))}))}function Nt(e,t){try{var r=Mt(e),n=Mt(t);if(r!==n)return"Array"===r?1:"Array"===n?-1:"binary"===r?1:"binary"===n?-1:"string"===r?1:"string"===n?-1:"Date"===r?1:"Date"!==n?NaN:-1;switch(r){case"number":case"Date":case"string":return e>t?1:e<t?-1:0;case"binary":return function(e,t){for(var r=e.length,n=t.length,i=r<n?r:n,o=0;o<i;++o)if(e[o]!==t[o])return e[o]<t[o]?-1:1;return r===n?0:r<n?-1:1}(jt(e),jt(t));case"Array":return function(e,t){for(var r=e.length,n=t.length,i=r<n?r:n,o=0;o<i;++o){var s=Nt(e[o],t[o]);if(0!==s)return s}return r===n?0:r<n?-1:1}(e,t)}}catch(e){}return NaN}function Mt(e){var t=typeof e;if("object"!==t)return t;if(ArrayBuffer.isView(e))return"binary";var r=A(e);return"ArrayBuffer"===r?"binary":r}function jt(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var Ft=function(){function e(){}return e.prototype._read=function(e,t){var r=this._ctx;return r.error?r.table._trans(null,mt.bind(null,r.error)):r.table._trans("readonly",e).then(t)},e.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,mt.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},e.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=St(t.algorithm,e)},e.prototype._iterate=function(e,t){return At(this._ctx,e,t,this._ctx.table.core)},e.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return e&&c(r,e),t._ctx=r,t},e.prototype.raw=function(){return this._ctx.valueMapper=null,this},e.prototype.each=function(e){var t=this._ctx;return this._read((function(r){return At(t,e,r,t.table.core)}))},e.prototype.count=function(e){var t=this;return this._read((function(e){var r=t._ctx,n=r.table.core;if(Et(r,!0))return n.count({trans:e,query:{index:Bt(r,n.schema),range:r.range}}).then((function(e){return Math.min(e,r.limit)}));var i=0;return At(r,(function(){return++i,!1}),e,n).then((function(){return i}))})).then(e)},e.prototype.sortBy=function(e,t){var r=e.split(".").reverse(),n=r[0],i=r.length-1;function o(e,t){return t?o(e[r[t]],t-1):e[n]}var s="next"===this._ctx.dir?1:-1;function a(e,t){var r=o(e,i),n=o(t,i);return r<n?-s:r>n?s:0}return this.toArray((function(e){return e.sort(a)})).then(t)},e.prototype.toArray=function(e){var t=this;return this._read((function(e){var r=t._ctx;if("next"===r.dir&&Et(r,!0)&&r.limit>0){var n=r.valueMapper,i=Bt(r,r.table.core.schema);return r.table.core.query({trans:e,limit:r.limit,values:!0,query:{index:i,range:r.range}}).then((function(e){var t=e.result;return n?t.map(n):t}))}var o=[];return At(r,(function(e){return o.push(e)}),e,r.table.core).then((function(){return o}))}),e)},e.prototype.offset=function(e){var t=this._ctx;return e<=0||(t.offset+=e,Et(t)?Ot(t,(function(){var t=e;return function(e,r){return 0===t||(1===t?(--t,!1):(r((function(){e.advance(t),t=0})),!1))}})):Ot(t,(function(){var t=e;return function(){return--t<0}}))),this},e.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Ot(this._ctx,(function(){var t=e;return function(e,r,n){return--t<=0&&r(n),t>=0}}),!0),this},e.prototype.until=function(e,t){return It(this._ctx,(function(r,n,i){return!e(r.value)||(n(i),t)})),this},e.prototype.first=function(e){return this.limit(1).toArray((function(e){return e[0]})).then(e)},e.prototype.last=function(e){return this.reverse().first(e)},e.prototype.filter=function(e){var t,r;return It(this._ctx,(function(t){return e(t.value)})),t=this._ctx,r=e,t.isMatch=St(t.isMatch,r),this},e.prototype.and=function(e){return this.filter(e)},e.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},e.prototype.reverse=function(){return this._ctx.dir="prev"===this._ctx.dir?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},e.prototype.desc=function(){return this.reverse()},e.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each((function(t,r){e(r.key,r)}))},e.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},e.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each((function(t,r){e(r.primaryKey,r)}))},e.prototype.keys=function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var r=[];return this.each((function(e,t){r.push(t.key)})).then((function(){return r})).then(e)},e.prototype.primaryKeys=function(e){var t=this._ctx;if("next"===t.dir&&Et(t,!0)&&t.limit>0)return this._read((function(e){var r=Bt(t,t.table.core.schema);return t.table.core.query({trans:e,values:!1,limit:t.limit,query:{index:r,range:t.range}})})).then((function(e){return e.result})).then(e);t.keysOnly=!t.isMatch;var r=[];return this.each((function(e,t){r.push(t.primaryKey)})).then((function(){return r})).then(e)},e.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},e.prototype.firstKey=function(e){return this.limit(1).keys((function(e){return e[0]})).then(e)},e.prototype.lastKey=function(e){return this.reverse().firstKey(e)},e.prototype.distinct=function(){var e=this._ctx,t=e.index&&e.table.schema.idxByName[e.index];if(!t||!t.multi)return this;var r={};return It(this._ctx,(function(e){var t=e.primaryKey.toString(),n=d(r,t);return r[t]=!0,!n})),this},e.prototype.modify=function(e){var t=this,r=this._ctx;return this._write((function(n){var i;if("function"==typeof e)i=e;else{var o=s(e),a=o.length;i=function(t){for(var r=!1,n=0;n<a;++n){var i=o[n],s=e[i];T(t,i)!==s&&(w(t,i,s),r=!0)}return r}}var c=r.table.core,u=c.schema.primaryKey,l=u.outbound,d=u.extractKey,h=t.db._options.modifyChunkSize||200,f=[],p=0,m=[],g=function(e,t){var r=t.failures,n=t.numFailures;p+=e-n;for(var i=0,o=s(r);i<o.length;i++){var a=o[i];f.push(r[a])}};return t.clone().primaryKeys().then((function(t){var o=function(s){var a=Math.min(h,t.length-s);return c.getMany({trans:n,keys:t.slice(s,s+a),cache:"immutable"}).then((function(u){for(var f=[],p=[],m=l?[]:null,v=[],y=0;y<a;++y){var b=u[y],R={value:B(b),primKey:t[s+y]};!1!==i.call(R,R.value,R)&&(null==R.value?v.push(t[s+y]):l||0===Nt(d(b),d(R.value))?(p.push(R.value),l&&m.push(t[s+y])):(v.push(t[s+y]),f.push(R.value)))}var _=Et(r)&&r.limit===1/0&&("function"!=typeof e||e===Ut)&&{index:r.index,range:r.range};return Promise.resolve(f.length>0&&c.mutate({trans:n,type:"add",values:f}).then((function(e){for(var t in e.failures)v.splice(parseInt(t),1);g(f.length,e)}))).then((function(){return(p.length>0||_&&"object"==typeof e)&&c.mutate({trans:n,type:"put",keys:m,values:p,criteria:_,changeSpec:"function"!=typeof e&&e}).then((function(e){return g(p.length,e)}))})).then((function(){return(v.length>0||_&&e===Ut)&&c.mutate({trans:n,type:"delete",keys:v,criteria:_}).then((function(e){return g(v.length,e)}))})).then((function(){return t.length>s+a&&o(s+h)}))}))};return o(0).then((function(){if(f.length>0)throw new Q("Error modifying one or more objects",f,p,m);return t.length}))}))}))},e.prototype.delete=function(){var e=this._ctx,t=e.range;return Et(e)&&(e.isPrimKey&&!_t||3===t.type)?this._write((function(r){var n=e.table.core.schema.primaryKey,i=t;return e.table.core.count({trans:r,query:{index:n,range:i}}).then((function(t){return e.table.core.mutate({trans:r,type:"deleteRange",range:i}).then((function(e){var r=e.failures;e.lastResult,e.results;var n=e.numFailures;if(n)throw new Q("Could not delete some values",Object.keys(r).map((function(e){return r[e]})),t-n);return t-n}))}))})):this.modify(Ut)},e}(),Ut=function(e,t){return t.value=null};function $t(e,t){return e<t?-1:e===t?0:1}function Wt(e,t){return e>t?-1:e===t?0:1}function Gt(e,t,r){var n=e instanceof Jt?new e.Collection(e):e;return n._ctx.error=r?new r(t):new TypeError(t),n}function Kt(e){return new e.Collection(e,(function(){return Ht("")})).limit(0)}function zt(e,t,r,n,i,o){for(var s=Math.min(e.length,n.length),a=-1,c=0;c<s;++c){var u=t[c];if(u!==n[c])return i(e[c],r[c])<0?e.substr(0,c)+r[c]+r.substr(c+1):i(e[c],n[c])<0?e.substr(0,c)+n[c]+r.substr(c+1):a>=0?e.substr(0,a)+t[a]+r.substr(a+1):null;i(e[c],u)<0&&(a=c)}return s<n.length&&"next"===o?e+r.substr(e.length):s<e.length&&"prev"===o?e.substr(0,r.length):a<0?null:e.substr(0,a)+n[a]+r.substr(a+1)}function qt(e,t,r,n){var i,o,s,a,c,u,l,d=r.length;if(!r.every((function(e){return"string"==typeof e})))return Gt(e,"String expected.");function h(e){i=function(e){return"next"===e?function(e){return e.toUpperCase()}:function(e){return e.toLowerCase()}}(e),o=function(e){return"next"===e?function(e){return e.toLowerCase()}:function(e){return e.toUpperCase()}}(e),s="next"===e?$t:Wt;var t=r.map((function(e){return{lower:o(e),upper:i(e)}})).sort((function(e,t){return s(e.lower,t.lower)}));a=t.map((function(e){return e.upper})),c=t.map((function(e){return e.lower})),u=e,l="next"===e?"":n}h("next");var f=new e.Collection(e,(function(){return Vt(a[0],c[d-1]+n)}));f._ondirectionchange=function(e){h(e)};var p=0;return f._addAlgorithm((function(e,r,n){var i=e.key;if("string"!=typeof i)return!1;var h=o(i);if(t(h,c,p))return!0;for(var f=null,m=p;m<d;++m){var g=zt(i,h,a[m],c[m],s,u);null===g&&null===f?p=m+1:(null===f||s(f,g)>0)&&(f=g)}return r(null!==f?function(){e.continue(f+l)}:n),!1})),f}function Vt(e,t,r,n){return{type:2,lower:e,upper:t,lowerOpen:r,upperOpen:n}}function Ht(e){return{type:1,lower:e,upper:e}}var Jt=function(){function e(){}return Object.defineProperty(e.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),e.prototype.between=function(e,t,r,n){r=!1!==r,n=!0===n;try{return this._cmp(e,t)>0||0===this._cmp(e,t)&&(r||n)&&(!r||!n)?Kt(this):new this.Collection(this,(function(){return Vt(e,t,!r,!n)}))}catch(e){return Gt(this,vt)}},e.prototype.equals=function(e){return null==e?Gt(this,vt):new this.Collection(this,(function(){return Ht(e)}))},e.prototype.above=function(e){return null==e?Gt(this,vt):new this.Collection(this,(function(){return Vt(e,void 0,!0)}))},e.prototype.aboveOrEqual=function(e){return null==e?Gt(this,vt):new this.Collection(this,(function(){return Vt(e,void 0,!1)}))},e.prototype.below=function(e){return null==e?Gt(this,vt):new this.Collection(this,(function(){return Vt(void 0,e,!1,!0)}))},e.prototype.belowOrEqual=function(e){return null==e?Gt(this,vt):new this.Collection(this,(function(){return Vt(void 0,e)}))},e.prototype.startsWith=function(e){return"string"!=typeof e?Gt(this,"String expected."):this.between(e,e+gt,!0,!0)},e.prototype.startsWithIgnoreCase=function(e){return""===e?this.startsWith(e):qt(this,(function(e,t){return 0===e.indexOf(t[0])}),[e],gt)},e.prototype.equalsIgnoreCase=function(e){return qt(this,(function(e,t){return e===t[0]}),[e],"")},e.prototype.anyOfIgnoreCase=function(){var e=j.apply(M,arguments);return 0===e.length?Kt(this):qt(this,(function(e,t){return-1!==t.indexOf(e)}),e,"")},e.prototype.startsWithAnyOfIgnoreCase=function(){var e=j.apply(M,arguments);return 0===e.length?Kt(this):qt(this,(function(e,t){return t.some((function(t){return 0===e.indexOf(t)}))}),e,gt)},e.prototype.anyOf=function(){var e=this,t=j.apply(M,arguments),r=this._cmp;try{t.sort(r)}catch(e){return Gt(this,vt)}if(0===t.length)return Kt(this);var n=new this.Collection(this,(function(){return Vt(t[0],t[t.length-1])}));n._ondirectionchange=function(n){r="next"===n?e._ascending:e._descending,t.sort(r)};var i=0;return n._addAlgorithm((function(e,n,o){for(var s=e.key;r(s,t[i])>0;)if(++i===t.length)return n(o),!1;return 0===r(s,t[i])||(n((function(){e.continue(t[i])})),!1)})),n},e.prototype.notEqual=function(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},e.prototype.noneOf=function(){var e=j.apply(M,arguments);if(0===e.length)return new this.Collection(this);try{e.sort(this._ascending)}catch(e){return Gt(this,vt)}var t=e.reduce((function(e,t){return e?e.concat([[e[e.length-1][1],t]]):[[-1/0,t]]}),null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},e.prototype.inAnyRange=function(e,t){var r=this,n=this._cmp,i=this._ascending,o=this._descending,s=this._min,a=this._max;if(0===e.length)return Kt(this);if(!e.every((function(e){return void 0!==e[0]&&void 0!==e[1]&&i(e[0],e[1])<=0})))return Gt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",te.InvalidArgument);var c,u=!t||!1!==t.includeLowers,l=t&&!0===t.includeUppers,d=i;function h(e,t){return d(e[0],t[0])}try{(c=e.reduce((function(e,t){for(var r=0,i=e.length;r<i;++r){var o=e[r];if(n(t[0],o[1])<0&&n(t[1],o[0])>0){o[0]=s(o[0],t[0]),o[1]=a(o[1],t[1]);break}}return r===i&&e.push(t),e}),[])).sort(h)}catch(e){return Gt(this,vt)}var f=0,p=l?function(e){return i(e,c[f][1])>0}:function(e){return i(e,c[f][1])>=0},m=u?function(e){return o(e,c[f][0])>0}:function(e){return o(e,c[f][0])>=0},g=p,v=new this.Collection(this,(function(){return Vt(c[0][0],c[c.length-1][1],!u,!l)}));return v._ondirectionchange=function(e){"next"===e?(g=p,d=i):(g=m,d=o),c.sort(h)},v._addAlgorithm((function(e,t,n){for(var o=e.key;g(o);)if(++f===c.length)return t(n),!1;return!!function(e){return!p(e)&&!m(e)}(o)||(0===r._cmp(o,c[f][1])||0===r._cmp(o,c[f][0])||t((function(){d===i?e.continue(c[f][0]):e.continue(c[f][1])})),!1)})),v},e.prototype.startsWithAnyOf=function(){var e=j.apply(M,arguments);return e.every((function(e){return"string"==typeof e}))?0===e.length?Kt(this):this.inAnyRange(e.map((function(e){return[e,e+gt]}))):Gt(this,"startsWithAnyOf() only works with strings")},e}();function Yt(e){return Je((function(t){return Qt(t),e(t.target.error),!1}))}function Qt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var Xt=Pt(null,"storagemutated"),Zt=function(){function e(){}return e.prototype._lock=function(){return _(!Oe.global),++this._reculock,1!==this._reculock||Oe.global||(Oe.lockOwnerFor=this),this},e.prototype._unlock=function(){if(_(!Oe.global),0==--this._reculock)for(Oe.global||(Oe.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var e=this._blockedFuncs.shift();try{lt(e[1],e[0])}catch(e){}}return this},e.prototype._locked=function(){return this._reculock&&Oe.lockOwnerFor!==this},e.prototype.create=function(e){var t=this;if(!this.mode)return this;var r=this.db.idbdb,n=this.db._state.dbOpenError;if(_(!this.idbtrans),!e&&!r)switch(n&&n.name){case"DatabaseClosedError":throw new te.DatabaseClosed(n);case"MissingAPIError":throw new te.MissingAPI(n.message,n);default:throw new te.OpenFailed(n)}if(!this.active)throw new te.TransactionInactive;return _(null===this._completion._state),(e=this.idbtrans=e||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):r.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}))).onerror=Je((function(r){Qt(r),t._reject(e.error)})),e.onabort=Je((function(r){Qt(r),t.active&&t._reject(new te.Abort(e.error)),t.active=!1,t.on("abort").fire(r)})),e.oncomplete=Je((function(){t.active=!1,t._resolve(),"mutatedParts"in e&&Xt.storagemutated.fire(e.mutatedParts)})),this},e.prototype._promise=function(e,t,r){var n=this;if("readwrite"===e&&"readwrite"!==this.mode)return mt(new te.ReadOnly("Transaction is readonly"));if(!this.active)return mt(new te.TransactionInactive);if(this._locked())return new Le((function(i,o){n._blockedFuncs.push([function(){n._promise(e,t,r).then(i,o)},Oe])}));if(r)return rt((function(){var e=new Le((function(e,r){n._lock();var i=t(e,r,n);i&&i.then&&i.then(e,r)}));return e.finally((function(){return n._unlock()})),e._lib=!0,e}));var i=new Le((function(e,r){var i=t(e,r,n);i&&i.then&&i.then(e,r)}));return i._lib=!0,i},e.prototype._root=function(){return this.parent?this.parent._root():this},e.prototype.waitFor=function(e){var t=this._root(),r=Le.resolve(e);if(t._waitingFor)t._waitingFor=t._waitingFor.then((function(){return r}));else{t._waitingFor=r,t._waitingQueue=[];var n=t.idbtrans.objectStore(t.storeNames[0]);!function e(){for(++t._spinCount;t._waitingQueue.length;)t._waitingQueue.shift()();t._waitingFor&&(n.get(-1/0).onsuccess=e)}()}var i=t._waitingFor;return new Le((function(e,n){r.then((function(r){return t._waitingQueue.push(Je(e.bind(null,r)))}),(function(e){return t._waitingQueue.push(Je(n.bind(null,e)))})).finally((function(){t._waitingFor===i&&(t._waitingFor=null)}))}))},e.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new te.Abort))},e.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if(d(t,e))return t[e];var r=this.schema[e];if(!r)throw new te.NotFound("Table "+e+" not part of transaction");var n=new this.db.Table(e,r,this);return n.core=this.db.core.table(e),t[e]=n,n},e}();function er(e,t,r,n,i,o,s){return{name:e,keyPath:t,unique:r,multi:n,auto:i,compound:o,src:(r&&!s?"&":"")+(n?"*":"")+(i?"++":"")+tr(t)}}function tr(e){return"string"==typeof e?e:e?"["+[].join.call(e,"+")+"]":""}function rr(e,t,r){return{name:e,primKey:t,indexes:r,mappedClass:null,idxByName:S(r,(function(e){return[e.name,e]}))}}var nr=function(e){try{return e.only([[]]),nr=function(){return[[]]},[[]]}catch(e){return nr=function(){return gt},gt}};function ir(e){return null==e?function(){}:"string"==typeof e?function(e){return 1===e.split(".").length?function(t){return t[e]}:function(t){return T(t,e)}}(e):function(t){return T(t,e)}}function or(e){return[].slice.call(e)}var sr=0;function ar(e){return null==e?":id":"string"==typeof e?e:"["+e.join("+")+"]"}function cr(e,t,r){function n(e){if(3===e.type)return null;if(4===e.type)throw new Error("Cannot convert never type to IDBKeyRange");var r=e.lower,n=e.upper,i=e.lowerOpen,o=e.upperOpen;return void 0===r?void 0===n?null:t.upperBound(n,!!o):void 0===n?t.lowerBound(r,!!i):t.bound(r,n,!!i,!!o)}var i=function(e,t){var r=or(e.objectStoreNames);return{schema:{name:e.name,tables:r.map((function(e){return t.objectStore(e)})).map((function(e){var t=e.keyPath,r=e.autoIncrement,n=a(t),i=null==t,o={},s={name:e.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:i,compound:n,keyPath:t,autoIncrement:r,unique:!0,extractKey:ir(t)},indexes:or(e.indexNames).map((function(t){return e.index(t)})).map((function(e){var t=e.name,r=e.unique,n=e.multiEntry,i=e.keyPath,s={name:t,compound:a(i),keyPath:i,unique:r,multiEntry:n,extractKey:ir(i)};return o[ar(i)]=s,s})),getIndexByKeyPath:function(e){return o[ar(e)]}};return o[":id"]=s.primaryKey,null!=t&&(o[ar(t)]=s.primaryKey),s}))},hasGetAll:r.length>0&&"getAll"in t.objectStore(r[0])&&!("undefined"!=typeof navigator&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}(e,r),o=i.schema,s=i.hasGetAll,c=o.tables.map((function(e){return function(e){var t=e.name;return{name:t,schema:e,mutate:function(e){var r=e.trans,i=e.type,o=e.keys,s=e.values,a=e.range;return new Promise((function(e,c){e=Je(e);var u=r.objectStore(t),l=null==u.keyPath,d="put"===i||"add"===i;if(!d&&"delete"!==i&&"deleteRange"!==i)throw new Error("Invalid operation type: "+i);var h,f=(o||s||{length:1}).length;if(o&&s&&o.length!==s.length)throw new Error("Given keys array must have same length as given values array.");if(0===f)return e({numFailures:0,failures:{},results:[],lastResult:void 0});var p=[],m=[],g=0,v=function(e){++g,Qt(e)};if("deleteRange"===i){if(4===a.type)return e({numFailures:g,failures:m,results:[],lastResult:void 0});3===a.type?p.push(h=u.clear()):p.push(h=u.delete(n(a)))}else{var y=d?l?[s,o]:[s,null]:[o,null],b=y[0],R=y[1];if(d)for(var _=0;_<f;++_)p.push(h=R&&void 0!==R[_]?u[i](b[_],R[_]):u[i](b[_])),h.onerror=v;else for(_=0;_<f;++_)p.push(h=u[i](b[_])),h.onerror=v}var C=function(t){var r=t.target.result;p.forEach((function(e,t){return null!=e.error&&(m[t]=e.error)})),e({numFailures:g,failures:m,results:"delete"===i?o:p.map((function(e){return e.result})),lastResult:r})};h.onerror=function(e){v(e),C(e)},h.onsuccess=C}))},getMany:function(e){var r=e.trans,n=e.keys;return new Promise((function(e,i){e=Je(e);for(var o,s=r.objectStore(t),a=n.length,c=new Array(a),u=0,l=0,d=function(t){var r=t.target;c[r._pos]=r.result,++l===u&&e(c)},h=Yt(i),f=0;f<a;++f)null!=n[f]&&((o=s.get(n[f]))._pos=f,o.onsuccess=d,o.onerror=h,++u);0===u&&e(c)}))},get:function(e){var r=e.trans,n=e.key;return new Promise((function(e,i){e=Je(e);var o=r.objectStore(t).get(n);o.onsuccess=function(t){return e(t.target.result)},o.onerror=Yt(i)}))},query:function(e){return function(r){return new Promise((function(i,o){i=Je(i);var s=r.trans,a=r.values,c=r.limit,u=r.query,l=c===1/0?void 0:c,d=u.index,h=u.range,f=s.objectStore(t),p=d.isPrimaryKey?f:f.index(d.name),m=n(h);if(0===c)return i({result:[]});if(e){var g=a?p.getAll(m,l):p.getAllKeys(m,l);g.onsuccess=function(e){return i({result:e.target.result})},g.onerror=Yt(o)}else{var v=0,y=a||!("openKeyCursor"in p)?p.openCursor(m):p.openKeyCursor(m),b=[];y.onsuccess=function(e){var t=y.result;return t?(b.push(a?t.value:t.primaryKey),++v===c?i({result:b}):void t.continue()):i({result:b})},y.onerror=Yt(o)}}))}}(s),openCursor:function(e){var r=e.trans,i=e.values,o=e.query,s=e.reverse,a=e.unique;return new Promise((function(e,c){e=Je(e);var u=o.index,l=o.range,d=r.objectStore(t),h=u.isPrimaryKey?d:d.index(u.name),f=s?a?"prevunique":"prev":a?"nextunique":"next",p=i||!("openKeyCursor"in h)?h.openCursor(n(l),f):h.openKeyCursor(n(l),f);p.onerror=Yt(c),p.onsuccess=Je((function(t){var n=p.result;if(n){n.___id=++sr,n.done=!1;var i=n.continue.bind(n),o=n.continuePrimaryKey;o&&(o=o.bind(n));var s=n.advance.bind(n),a=function(){throw new Error("Cursor not stopped")};n.trans=r,n.stop=n.continue=n.continuePrimaryKey=n.advance=function(){throw new Error("Cursor not started")},n.fail=Je(c),n.next=function(){var e=this,t=1;return this.start((function(){return t--?e.continue():e.stop()})).then((function(){return e}))},n.start=function(e){var t=new Promise((function(e,t){e=Je(e),p.onerror=Yt(t),n.fail=t,n.stop=function(t){n.stop=n.continue=n.continuePrimaryKey=n.advance=a,e(t)}})),r=function(){if(p.result)try{e()}catch(e){n.fail(e)}else n.done=!0,n.start=function(){throw new Error("Cursor behind last entry")},n.stop()};return p.onsuccess=Je((function(e){p.onsuccess=r,r()})),n.continue=i,n.continuePrimaryKey=o,n.advance=s,r(),t},e(n)}else e(null)}),c)}))},count:function(e){var r=e.query,i=e.trans,o=r.index,s=r.range;return new Promise((function(e,r){var a=i.objectStore(t),c=o.isPrimaryKey?a:a.index(o.name),u=n(s),l=u?c.count(u):c.count();l.onsuccess=Je((function(t){return e(t.target.result)})),l.onerror=Yt(r)}))}}}(e)})),u={};return c.forEach((function(e){return u[e.name]=e})),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(e){if(!u[e])throw new Error("Table '"+e+"' not found");return u[e]},MIN_KEY:-1/0,MAX_KEY:nr(t),schema:o}}function ur(e,t,r,i){var o=r.IDBKeyRange;return r.indexedDB,{dbcore:function(e,t){return t.reduce((function(e,t){var r=t.create;return n(n({},e),r(e))}),e)}(cr(t,o,i),e.dbcore)}}function lr(e,t){var r=e._novip,n=t.db,i=ur(r._middlewares,n,r._deps,t);r.core=i.dbcore,r.tables.forEach((function(e){var t=e.name;r.core.schema.tables.some((function(e){return e.name===t}))&&(e.core=r.core.table(t),r[t]instanceof r.Table&&(r[t].core=e.core))}))}function dr(e,t,r,n){var i=e._novip;r.forEach((function(e){var r=n[e];t.forEach((function(t){var n=v(t,e);(!n||"value"in n&&void 0===n.value)&&(t===i.Transaction.prototype||t instanceof i.Transaction?p(t,e,{get:function(){return this.table(e)},set:function(t){f(this,e,{value:t,writable:!0,configurable:!0,enumerable:!0})}}):t[e]=new i.Table(e,r))}))}))}function hr(e,t){var r=e._novip;t.forEach((function(e){for(var t in e)e[t]instanceof r.Table&&delete e[t]}))}function fr(e,t){return e._cfg.version-t._cfg.version}function pr(e,t,r,n){var i=e._dbSchema,o=e._createTransaction("readwrite",e._storeNames,i);o.create(r),o._completion.catch(n);var a=o._reject.bind(o),c=Oe.transless||Oe;rt((function(){Oe.trans=o,Oe.transless=c,0===t?(s(i).forEach((function(e){gr(r,e,i[e].primKey,i[e].indexes)})),lr(e,r),Le.follow((function(){return e.on.populate.fire(o)})).catch(a)):function(e,t,r,n){var i=e._novip,o=[],a=i._versions,c=i._dbSchema=yr(0,i.idbdb,n),u=!1;return a.filter((function(e){return e._cfg.version>=t})).forEach((function(e){o.push((function(){var o=c,a=e._cfg.dbschema;br(i,o,n),br(i,a,n),c=i._dbSchema=a;var l=mr(o,a);l.add.forEach((function(e){gr(n,e[0],e[1].primKey,e[1].indexes)})),l.change.forEach((function(e){if(e.recreate)throw new te.Upgrade("Not yet support for changing primary key");var t=n.objectStore(e.name);e.add.forEach((function(e){return vr(t,e)})),e.change.forEach((function(e){t.deleteIndex(e.name),vr(t,e)})),e.del.forEach((function(e){return t.deleteIndex(e)}))}));var d=e._cfg.contentUpgrade;if(d&&e._cfg.version>t){lr(i,n),r._memoizedTables={},u=!0;var h=D(a);l.del.forEach((function(e){h[e]=o[e]})),hr(i,[i.Transaction.prototype]),dr(i,[i.Transaction.prototype],s(h),h),r.schema=h;var f,p=F(d);p&&nt();var m=Le.follow((function(){if((f=d(r))&&p){var e=it.bind(null,null);f.then(e,e)}}));return f&&"function"==typeof f.then?Le.resolve(f):m.then((function(){return f}))}})),o.push((function(t){u&&Rt||function(e,t){[].slice.call(t.db.objectStoreNames).forEach((function(r){return null==e[r]&&t.db.deleteObjectStore(r)}))}(e._cfg.dbschema,t),hr(i,[i.Transaction.prototype]),dr(i,[i.Transaction.prototype],i._storeNames,i._dbSchema),r.schema=i._dbSchema}))})),function e(){return o.length?Le.resolve(o.shift()(r.idbtrans)).then(e):Le.resolve()}().then((function(){var e,t;t=n,s(e=c).forEach((function(r){t.db.objectStoreNames.contains(r)||gr(t,r,e[r].primKey,e[r].indexes)}))}))}(e,t,o,r).catch(a)}))}function mr(e,t){var r,n={del:[],add:[],change:[]};for(r in e)t[r]||n.del.push(r);for(r in t){var i=e[r],o=t[r];if(i){var s={name:r,def:o,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(o.primKey.keyPath||"")||i.primKey.auto!==o.primKey.auto&&!bt)s.recreate=!0,n.change.push(s);else{var a=i.idxByName,c=o.idxByName,u=void 0;for(u in a)c[u]||s.del.push(u);for(u in c){var l=a[u],d=c[u];l?l.src!==d.src&&s.change.push(d):s.add.push(d)}(s.del.length>0||s.add.length>0||s.change.length>0)&&n.change.push(s)}}else n.add.push([r,o])}return n}function gr(e,t,r,n){var i=e.db.createObjectStore(t,r.keyPath?{keyPath:r.keyPath,autoIncrement:r.auto}:{autoIncrement:r.auto});return n.forEach((function(e){return vr(i,e)})),i}function vr(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function yr(e,t,r){var n={};return b(t.objectStoreNames,0).forEach((function(e){for(var t=r.objectStore(e),i=t.keyPath,o=er(tr(i),i||"",!1,!1,!!t.autoIncrement,i&&"string"!=typeof i,!0),s=[],a=0;a<t.indexNames.length;++a){var c=t.index(t.indexNames[a]);i=c.keyPath;var u=er(c.name,i,!!c.unique,!!c.multiEntry,!1,i&&"string"!=typeof i,!1);s.push(u)}n[e]=rr(e,o,s)})),n}function br(e,t,r){for(var n=e._novip,i=r.db.objectStoreNames,s=0;s<i.length;++s){var a=i[s],c=r.objectStore(a);n._hasGetAll="getAll"in c;for(var u=0;u<c.indexNames.length;++u){var l=c.indexNames[u],d=c.index(l).keyPath,h="string"==typeof d?d:"["+b(d).join("+")+"]";if(t[a]){var f=t[a].idxByName[h];f&&(f.name=l,delete t[a].idxByName[h],t[a].idxByName[l]=f)}}}"undefined"!=typeof navigator&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&o.WorkerGlobalScope&&o instanceof o.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(n._hasGetAll=!1)}var Rr=function(){function e(){}return e.prototype._parseStoresSpec=function(e,t){s(e).forEach((function(r){if(null!==e[r]){var n=e[r].split(",").map((function(e,t){var r=(e=e.trim()).replace(/([&*]|\+\+)/g,""),n=/^\[/.test(r)?r.match(/^\[(.*)\]$/)[1].split("+"):r;return er(r,n||null,/\&/.test(e),/\*/.test(e),/\+\+/.test(e),a(n),0===t)})),i=n.shift();if(i.multi)throw new te.Schema("Primary key cannot be multi-valued");n.forEach((function(e){if(e.auto)throw new te.Schema("Only primary key can be marked as autoIncrement (++)");if(!e.keyPath)throw new te.Schema("Index must have a name and cannot be an empty string")})),t[r]=rr(r,i,n)}}))},e.prototype.stores=function(e){var t=this.db;this._cfg.storesSource=this._cfg.storesSource?c(this._cfg.storesSource,e):e;var r=t._versions,n={},i={};return r.forEach((function(e){c(n,e._cfg.storesSource),i=e._cfg.dbschema={},e._parseStoresSpec(n,i)})),t._dbSchema=i,hr(t,[t._allTables,t,t.Transaction.prototype]),dr(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],s(i),i),t._storeNames=s(i),this},e.prototype.upgrade=function(e){return this._cfg.contentUpgrade=he(this._cfg.contentUpgrade||ie,e),this},e}();function _r(e,t){var r=e._dbNamesDB;return r||(r=e._dbNamesDB=new Vr("__dbnames",{addons:[],indexedDB:e,IDBKeyRange:t})).version(1).stores({dbnames:"name"}),r.table("dbnames")}function Cr(e){return e&&"function"==typeof e.databases}function Sr(e,t){var r=e.indexedDB,n=e.IDBKeyRange;!Cr(r)&&"__dbnames"!==t&&_r(r,n).delete(t).catch(ie)}function Tr(e){return rt((function(){return Oe.letThrough=!0,e()}))}function wr(){var e;return!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){var r=function(){return indexedDB.databases().finally(t)};e=setInterval(r,100),r()})).finally((function(){return clearInterval(e)})):Promise.resolve()}function Dr(e){var t=e._state,r=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then((function(){return t.dbOpenError?mt(t.dbOpenError):e}));U&&(t.openCanceller._stackHolder=K()),t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var n=t.openCanceller;function i(){if(t.openCanceller!==n)throw new te.DatabaseClosed("db.open() was cancelled")}var o=t.dbReadyResolve,a=null,c=!1;return Le.race([n,("undefined"==typeof navigator?Le.resolve():wr()).then((function(){return new Le((function(n,o){if(i(),!r)throw new te.MissingAPI;var u=e.name,l=t.autoSchema?r.open(u):r.open(u,Math.round(10*e.verno));if(!l)throw new te.MissingAPI;l.onerror=Yt(o),l.onblocked=Je(e._fireOnBlocked),l.onupgradeneeded=Je((function(n){if(a=l.transaction,t.autoSchema&&!e._options.allowEmptyDB){l.onerror=Qt,a.abort(),l.result.close();var i=r.deleteDatabase(u);i.onsuccess=i.onerror=Je((function(){o(new te.NoSuchDatabase("Database "+u+" doesnt exist"))}))}else{a.onerror=Yt(o);var s=n.oldVersion>Math.pow(2,62)?0:n.oldVersion;c=s<1,e._novip.idbdb=l.result,pr(e,s/10,a,o)}}),o),l.onsuccess=Je((function(){a=null;var r,i=e._novip.idbdb=l.result,o=b(i.objectStoreNames);if(o.length>0)try{var d=i.transaction(1===(r=o).length?r[0]:r,"readonly");t.autoSchema?function(e,t,r){var n=e._novip;n.verno=t.version/10;var i=n._dbSchema=yr(0,t,r);n._storeNames=b(t.objectStoreNames,0),dr(n,[n._allTables],s(i),i)}(e,i,d):(br(e,e._dbSchema,d),function(e,t){var r=mr(yr(0,e.idbdb,t),e._dbSchema);return!(r.add.length||r.change.some((function(e){return e.add.length||e.change.length})))}(e,d)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),lr(e,d)}catch(e){}yt.push(e),i.onversionchange=Je((function(r){t.vcFired=!0,e.on("versionchange").fire(r)})),i.onclose=Je((function(t){e.on("close").fire(t)})),c&&function(e,t){var r=e.indexedDB,n=e.IDBKeyRange;!Cr(r)&&"__dbnames"!==t&&_r(r,n).put({name:t}).catch(ie)}(e._deps,u),n()}),o)}))}))]).then((function(){return i(),t.onReadyBeingFired=[],Le.resolve(Tr((function(){return e.on.ready.fire(e.vip)}))).then((function r(){if(t.onReadyBeingFired.length>0){var n=t.onReadyBeingFired.reduce(he,ie);return t.onReadyBeingFired=[],Le.resolve(Tr((function(){return n(e.vip)}))).then(r)}}))})).finally((function(){t.onReadyBeingFired=null,t.isBeingOpened=!1})).then((function(){return e})).catch((function(r){t.dbOpenError=r;try{a&&a.abort()}catch(e){}return n===t.openCanceller&&e._close(),mt(r)})).finally((function(){t.openComplete=!0,o()}))}function Pr(e){var t=function(t){return e.next(t)},r=i(t),n=i((function(t){return e.throw(t)}));function i(e){return function(t){var i=e(t),o=i.value;return i.done?o:o&&"function"==typeof o.then?o.then(r,n):a(o)?Promise.all(o).then(r,n):r(o)}}return i(t)()}function kr(e,t,r){var n=arguments.length;if(n<2)throw new te.InvalidArgument("Too few arguments");for(var i=new Array(n-1);--n;)i[n-1]=arguments[n];r=i.pop();var o=k(i);return[e,o,r]}function Er(e,t,r,n,i){return Le.resolve().then((function(){var o=Oe.transless||Oe,s=e._createTransaction(t,r,e._dbSchema,n),a={trans:s,transless:o};if(n)s.idbtrans=n.idbtrans;else try{s.create(),e._state.PR1398_maxLoop=3}catch(n){return n.name===Z.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then((function(){return Er(e,t,r,null,i)}))):mt(n)}var c,u=F(i);u&&nt();var l=Le.follow((function(){if(c=i.call(s,s))if(u){var e=it.bind(null,null);c.then(e,e)}else"function"==typeof c.next&&"function"==typeof c.throw&&(c=Pr(c))}),a);return(c&&"function"==typeof c.then?Le.resolve(c).then((function(e){return s.active?e:mt(new te.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))})):l.then((function(){return c}))).then((function(e){return n&&s._resolve(),s._completion.then((function(){return e}))})).catch((function(e){return s._reject(e),mt(e)}))}))}function Ir(e,t,r){for(var n=a(e)?e.slice():[e],i=0;i<r;++i)n.push(t);return n}var Or={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return n(n({},e),{table:function(t){var r=e.table(t),i=r.schema,o={},s=[];function a(e,t,r){var i=ar(e),c=o[i]=o[i]||[],u=null==e?0:"string"==typeof e?1:e.length,l=t>0,d=n(n({},r),{isVirtual:l,keyTail:t,keyLength:u,extractKey:ir(e),unique:!l&&r.unique});return c.push(d),d.isPrimaryKey||s.push(d),u>1&&a(2===u?e[0]:e.slice(0,u-1),t+1,r),c.sort((function(e,t){return e.keyTail-t.keyTail})),d}var c=a(i.primaryKey.keyPath,0,i.primaryKey);o[":id"]=[c];for(var u=0,l=i.indexes;u<l.length;u++){var d=l[u];a(d.keyPath,0,d)}function h(t){var r,i,o=t.query.index;return o.isVirtual?n(n({},t),{query:{index:o,range:(r=t.query.range,i=o.keyTail,{type:1===r.type?2:r.type,lower:Ir(r.lower,r.lowerOpen?e.MAX_KEY:e.MIN_KEY,i),lowerOpen:!0,upper:Ir(r.upper,r.upperOpen?e.MIN_KEY:e.MAX_KEY,i),upperOpen:!0})}}):t}return n(n({},r),{schema:n(n({},i),{primaryKey:c,indexes:s,getIndexByKeyPath:function(e){var t=o[ar(e)];return t&&t[0]}}),count:function(e){return r.count(h(e))},query:function(e){return r.query(h(e))},openCursor:function(t){var n=t.query.index,i=n.keyTail,o=n.isVirtual,s=n.keyLength;return o?r.openCursor(h(t)).then((function(r){return r&&function(r){return Object.create(r,{continue:{value:function(n){null!=n?r.continue(Ir(n,t.reverse?e.MAX_KEY:e.MIN_KEY,i)):t.unique?r.continue(r.key.slice(0,s).concat(t.reverse?e.MIN_KEY:e.MAX_KEY,i)):r.continue()}},continuePrimaryKey:{value:function(t,n){r.continuePrimaryKey(Ir(t,e.MAX_KEY,i),n)}},primaryKey:{get:function(){return r.primaryKey}},key:{get:function(){var e=r.key;return 1===s?e[0]:e.slice(0,s)}},value:{get:function(){return r.value}}})}(r)})):r.openCursor(t)}})}})}};function Br(e,t,r,n){return r=r||{},n=n||"",s(e).forEach((function(i){if(d(t,i)){var o=e[i],s=t[i];if("object"==typeof o&&"object"==typeof s&&o&&s){var a=A(o);a!==A(s)?r[n+i]=t[i]:"Object"===a?Br(o,s,r,n+i+"."):o!==s&&(r[n+i]=t[i])}else o!==s&&(r[n+i]=t[i])}else r[n+i]=void 0})),s(t).forEach((function(i){d(e,i)||(r[n+i]=t[i])})),r}var xr={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return n(n({},e),{table:function(t){var r=e.table(t),o=r.schema.primaryKey;return n(n({},r),{mutate:function(e){var s=Oe.trans,a=s.table(t).hook,c=a.deleting,u=a.creating,l=a.updating;switch(e.type){case"add":if(u.fire===ie)break;return s._promise("readwrite",(function(){return h(e)}),!0);case"put":if(u.fire===ie&&l.fire===ie)break;return s._promise("readwrite",(function(){return h(e)}),!0);case"delete":if(c.fire===ie)break;return s._promise("readwrite",(function(){return h(e)}),!0);case"deleteRange":if(c.fire===ie)break;return s._promise("readwrite",(function(){return function(e){return function e(t,i,s){return r.query({trans:t,values:!1,query:{index:o,range:i},limit:s}).then((function(r){var o=r.result;return h({type:"delete",keys:o,trans:t}).then((function(r){return r.numFailures>0?Promise.reject(r.failures[0]):o.length<s?{failures:[],numFailures:0,lastResult:void 0}:e(t,n(n({},i),{lower:o[o.length-1],lowerOpen:!0}),s)}))}))}(e.trans,e.range,1e4)}(e)}),!0)}return r.mutate(e);function h(e){var t=Oe.trans,s=e.keys||function(e,t){return"delete"===t.type?t.keys:t.keys||t.values.map(e.extractKey)}(o,e);if(!s)throw new Error("Keys missing");return"delete"!==(e="add"===e.type||"put"===e.type?n(n({},e),{keys:s}):n({},e)).type&&(e.values=i([],e.values,!0)),e.keys&&(e.keys=i([],e.keys,!0)),function(e,t,r){return"add"===t.type?Promise.resolve([]):e.getMany({trans:t.trans,keys:r,cache:"immutable"})}(r,e,s).then((function(n){var i=s.map((function(r,i){var s=n[i],a={onerror:null,onsuccess:null};if("delete"===e.type)c.fire.call(a,r,s,t);else if("add"===e.type||void 0===s){var h=u.fire.call(a,r,e.values[i],t);null==r&&null!=h&&(r=h,e.keys[i]=r,o.outbound||w(e.values[i],o.keyPath,r))}else{var f=Br(s,e.values[i]),p=l.fire.call(a,f,r,s,t);if(p){var m=e.values[i];Object.keys(p).forEach((function(e){d(m,e)?m[e]=p[e]:w(m,e,p[e])}))}}return a}));return r.mutate(e).then((function(t){for(var r=t.failures,o=t.results,a=t.numFailures,c=t.lastResult,u=0;u<s.length;++u){var l=o?o[u]:s[u],d=i[u];null==l?d.onerror&&d.onerror(r[u]):d.onsuccess&&d.onsuccess("put"===e.type&&n[u]?e.values[u]:l)}return{failures:r,results:o,numFailures:a,lastResult:c}})).catch((function(e){return i.forEach((function(t){return t.onerror&&t.onerror(e)})),Promise.reject(e)}))}))}}})}})}};function Ar(e,t,r){try{if(!t)return null;if(t.keys.length<e.length)return null;for(var n=[],i=0,o=0;i<t.keys.length&&o<e.length;++i)0===Nt(t.keys[i],e[o])&&(n.push(r?B(t.values[i]):t.values[i]),++o);return n.length===e.length?n:null}catch(e){return null}}var Lr,Nr={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var r=e.table(t);return n(n({},r),{getMany:function(e){if(!e.cache)return r.getMany(e);var t=Ar(e.keys,e.trans._cache,"clone"===e.cache);return t?Le.resolve(t):r.getMany(e).then((function(t){return e.trans._cache={keys:e.keys,values:"clone"===e.cache?B(t):t},t}))},mutate:function(e){return"add"!==e.type&&(e.trans._cache=null),r.mutate(e)}})}}}};function Mr(e){return!("from"in e)}var jr=function(e,t){if(!this){var r=new jr;return e&&"d"in e&&c(r,e),r}c(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0})};function Fr(e,t,r){var n=Nt(t,r);if(!isNaN(n)){if(n>0)throw RangeError();if(Mr(e))return c(e,{from:t,to:r,d:1});var i=e.l,o=e.r;if(Nt(r,e.from)<0)return i?Fr(i,t,r):e.l={from:t,to:r,d:1,l:null,r:null},Gr(e);if(Nt(t,e.to)>0)return o?Fr(o,t,r):e.r={from:t,to:r,d:1,l:null,r:null},Gr(e);Nt(t,e.from)<0&&(e.from=t,e.l=null,e.d=o?o.d+1:1),Nt(r,e.to)>0&&(e.to=r,e.r=null,e.d=e.l?e.l.d+1:1);var s=!e.r;i&&!e.l&&Ur(e,i),o&&s&&Ur(e,o)}}function Ur(e,t){Mr(t)||function e(t,r){var n=r.from,i=r.to,o=r.l,s=r.r;Fr(t,n,i),o&&e(t,o),s&&e(t,s)}(e,t)}function $r(e,t){var r=Wr(t),n=r.next();if(n.done)return!1;for(var i=n.value,o=Wr(e),s=o.next(i.from),a=s.value;!n.done&&!s.done;){if(Nt(a.from,i.to)<=0&&Nt(a.to,i.from)>=0)return!0;Nt(i.from,a.from)<0?i=(n=r.next(a.from)).value:a=(s=o.next(i.from)).value}return!1}function Wr(e){var t=Mr(e)?null:{s:0,n:e};return{next:function(e){for(var r=arguments.length>0;t;)switch(t.s){case 0:if(t.s=1,r)for(;t.n.l&&Nt(e,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!r||Nt(e,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function Gr(e){var t,r,i=((null===(t=e.r)||void 0===t?void 0:t.d)||0)-((null===(r=e.l)||void 0===r?void 0:r.d)||0),o=i>1?"r":i<-1?"l":"";if(o){var s="r"===o?"l":"r",a=n({},e),c=e[o];e.from=c.from,e.to=c.to,e[o]=c[o],a[o]=c[s],e[s]=a,a.d=Kr(a)}e.d=Kr(e)}function Kr(e){var t=e.r,r=e.l;return(t?r?Math.max(t.d,r.d):t.d:r?r.d:0)+1}h(jr.prototype,((Lr={add:function(e){return Ur(this,e),this},addKey:function(e){return Fr(this,e,e),this},addKeys:function(e){var t=this;return e.forEach((function(e){return Fr(t,e,e)})),this}})[L]=function(){return Wr(this)},Lr));var zr,qr={stack:"dbcore",level:0,create:function(e){var t=e.schema.name,r=new jr(e.MIN_KEY,e.MAX_KEY);return n(n({},e),{table:function(i){var o=e.table(i),c=o.schema,u=c.primaryKey,l=u.extractKey,d=u.outbound,h=n(n({},o),{mutate:function(e){var n=e.trans,s=n.mutatedParts||(n.mutatedParts={}),u=function(e){var r="idb://"+t+"/"+i+"/"+e;return s[r]||(s[r]=new jr)},l=u(""),d=u(":dels"),h=e.type,f="deleteRange"===e.type?[e.range]:"delete"===e.type?[e.keys]:e.values.length<50?[[],e.values]:[],p=f[0],m=f[1],g=e.trans._cache;return o.mutate(e).then((function(e){if(a(p)){"delete"!==h&&(p=e.results),l.addKeys(p);var t=Ar(p,g);t||"add"===h||d.addKeys(p),(t||m)&&function(e,t,r,n){t.indexes.forEach((function(t){var i=e(t.name||"");function o(e){return null!=e?t.extractKey(e):null}var s=function(e){return t.multiEntry&&a(e)?e.forEach((function(e){return i.addKey(e)})):i.addKey(e)};(r||n).forEach((function(e,t){var i=r&&o(r[t]),a=n&&o(n[t]);0!==Nt(i,a)&&(null!=i&&s(i),null!=a&&s(a))}))}))}(u,c,t,m)}else if(p){var n={from:p.lower,to:p.upper};d.add(n),l.add(n)}else l.add(r),d.add(r),c.indexes.forEach((function(e){return u(e.name).add(r)}));return e}))}}),f=function(t){var r,n,i=t.query,o=i.index,s=i.range;return[o,new jr(null!==(r=s.lower)&&void 0!==r?r:e.MIN_KEY,null!==(n=s.upper)&&void 0!==n?n:e.MAX_KEY)]},p={get:function(e){return[u,new jr(e.key)]},getMany:function(e){return[u,(new jr).addKeys(e.keys)]},count:f,query:f,openCursor:f};return s(p).forEach((function(e){h[e]=function(s){var a=Oe.subscr;if(a){var c=function(e){var r="idb://"+t+"/"+i+"/"+e;return a[r]||(a[r]=new jr)},u=c(""),h=c(":dels"),f=p[e](s),m=f[0],g=f[1];if(c(m.name||"").add(g),!m.isPrimaryKey){if("count"!==e){var v="query"===e&&d&&s.values&&o.query(n(n({},s),{values:!1}));return o[e].apply(this,arguments).then((function(t){if("query"===e){if(d&&s.values)return v.then((function(e){var r=e.result;return u.addKeys(r),t}));var r=s.values?t.result.map(l):t.result;s.values?u.addKeys(r):h.addKeys(r)}else if("openCursor"===e){var n=t,i=s.values;return n&&Object.create(n,{key:{get:function(){return h.addKey(n.primaryKey),n.key}},primaryKey:{get:function(){var e=n.primaryKey;return h.addKey(e),e}},value:{get:function(){return i&&u.addKey(n.primaryKey),n.value}}})}return t}))}h.add(r)}}return o[e].apply(this,arguments)}})),h}})}},Vr=function(){function e(t,r){var i=this;this._middlewares={},this.verno=0;var o=e.dependencies;this._options=r=n({addons:e.addons,autoOpen:!0,indexedDB:o.indexedDB,IDBKeyRange:o.IDBKeyRange},r),this._deps={indexedDB:r.indexedDB,IDBKeyRange:r.IDBKeyRange};var s=r.addons;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var a,c={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:ie,dbReadyPromise:null,cancelOpen:ie,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};c.dbReadyPromise=new Le((function(e){c.dbReadyResolve=e})),c.openCanceller=new Le((function(e,t){c.cancelOpen=t})),this._state=c,this.name=t,this.on=Pt(this,"populate","blocked","versionchange","close",{ready:[he,ie]}),this.on.ready.subscribe=R(this.on.ready.subscribe,(function(t){return function(r,n){e.vip((function(){var e=i._state;if(e.openComplete)e.dbOpenError||Le.resolve().then(r),n&&t(r);else if(e.onReadyBeingFired)e.onReadyBeingFired.push(r),n&&t(r);else{t(r);var o=i;n||t((function e(){o.on.ready.unsubscribe(r),o.on.ready.unsubscribe(e)}))}}))}})),this.Collection=(a=this,kt(Ft.prototype,(function(e,t){this.db=a;var r=Tt,n=null;if(t)try{r=t()}catch(e){n=e}var i=e._ctx,o=i.table,s=o.hook.reading.fire;this._ctx={table:o,index:i.index,isPrimKey:!i.index||o.schema.primKey.keyPath&&i.index===o.schema.primKey.name,range:r,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:n,or:i.or,valueMapper:s!==oe?s:null}}))),this.Table=function(e){return kt(Dt.prototype,(function(t,r,n){this.db=e,this._tx=n,this.name=t,this.schema=r,this.hook=e._allTables[t]?e._allTables[t].hook:Pt(null,{creating:[ce,ie],reading:[se,oe],updating:[le,ie],deleting:[ue,ie]})}))}(this),this.Transaction=function(e){return kt(Zt.prototype,(function(t,r,n,i,o){var s=this;this.db=e,this.mode=t,this.storeNames=r,this.schema=n,this.chromeTransactionDurability=i,this.idbtrans=null,this.on=Pt(this,"complete","error","abort"),this.parent=o||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new Le((function(e,t){s._resolve=e,s._reject=t})),this._completion.then((function(){s.active=!1,s.on.complete.fire()}),(function(e){var t=s.active;return s.active=!1,s.on.error.fire(e),s.parent?s.parent._reject(e):t&&s.idbtrans&&s.idbtrans.abort(),mt(e)}))}))}(this),this.Version=function(e){return kt(Rr.prototype,(function(t){this.db=e,this._cfg={version:t,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}}))}(this),this.WhereClause=function(e){return kt(Jt.prototype,(function(t,r,n){this.db=e,this._ctx={table:t,index:":id"===r?null:r,or:n};var i=e._deps.indexedDB;if(!i)throw new te.MissingAPI;this._cmp=this._ascending=i.cmp.bind(i),this._descending=function(e,t){return i.cmp(t,e)},this._max=function(e,t){return i.cmp(e,t)>0?e:t},this._min=function(e,t){return i.cmp(e,t)<0?e:t},this._IDBKeyRange=e._deps.IDBKeyRange}))}(this),this.on("versionchange",(function(e){e.newVersion>0?console.warn("Another connection wants to upgrade database '"+i.name+"'. Closing db now to resume the upgrade."):console.warn("Another connection wants to delete database '"+i.name+"'. Closing db now to resume the delete request."),i.close()})),this.on("blocked",(function(e){!e.newVersion||e.newVersion<e.oldVersion?console.warn("Dexie.delete('"+i.name+"') was blocked"):console.warn("Upgrade '"+i.name+"' blocked by other connection holding version "+e.oldVersion/10)})),this._maxKey=nr(r.IDBKeyRange),this._createTransaction=function(e,t,r,n){return new i.Transaction(e,t,r,i._options.chromeTransactionDurability,n)},this._fireOnBlocked=function(e){i.on("blocked").fire(e),yt.filter((function(e){return e.name===i.name&&e!==i&&!e._state.vcFired})).map((function(t){return t.on("versionchange").fire(e)}))},this.use(Or),this.use(xr),this.use(qr),this.use(Nr),this.vip=Object.create(this,{_vip:{value:!0}}),s.forEach((function(e){return e(i)}))}return e.prototype.version=function(e){if(isNaN(e)||e<.1)throw new te.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new te.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,r=t.filter((function(t){return t._cfg.version===e}))[0];return r||(r=new this.Version(e),t.push(r),t.sort(fr),r.stores({}),this._state.autoSchema=!1,r)},e.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||Oe.letThrough||this._vip)?e():new Le((function(e,r){if(t._state.openComplete)return r(new te.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._options.autoOpen)return void r(new te.DatabaseClosed);t.open().catch(ie)}t._state.dbReadyPromise.then(e,r)})).then(e)},e.prototype.use=function(e){var t=e.stack,r=e.create,n=e.level,i=e.name;i&&this.unuse({stack:t,name:i});var o=this._middlewares[t]||(this._middlewares[t]=[]);return o.push({stack:t,create:r,level:null==n?10:n,name:i}),o.sort((function(e,t){return e.level-t.level})),this},e.prototype.unuse=function(e){var t=e.stack,r=e.name,n=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter((function(e){return n?e.create!==n:!!r&&e.name!==r}))),this},e.prototype.open=function(){return Dr(this)},e.prototype._close=function(){var e=this._state,t=yt.indexOf(this);if(t>=0&&yt.splice(t,1),this.idbdb){try{this.idbdb.close()}catch(e){}this._novip.idbdb=null}e.dbReadyPromise=new Le((function(t){e.dbReadyResolve=t})),e.openCanceller=new Le((function(t,r){e.cancelOpen=r}))},e.prototype.close=function(){this._close();var e=this._state;this._options.autoOpen=!1,e.dbOpenError=new te.DatabaseClosed,e.isBeingOpened&&e.cancelOpen(e.dbOpenError)},e.prototype.delete=function(){var e=this,t=arguments.length>0,r=this._state;return new Le((function(n,i){var o=function(){e.close();var t=e._deps.indexedDB.deleteDatabase(e.name);t.onsuccess=Je((function(){Sr(e._deps,e.name),n()})),t.onerror=Yt(i),t.onblocked=e._fireOnBlocked};if(t)throw new te.InvalidArgument("Arguments not allowed in db.delete()");r.isBeingOpened?r.dbReadyPromise.then(o):o()}))},e.prototype.backendDB=function(){return this.idbdb},e.prototype.isOpen=function(){return null!==this.idbdb},e.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&"DatabaseClosed"===e.name},e.prototype.hasFailed=function(){return null!==this._state.dbOpenError},e.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(e.prototype,"tables",{get:function(){var e=this;return s(this._allTables).map((function(t){return e._allTables[t]}))},enumerable:!1,configurable:!0}),e.prototype.transaction=function(){var e=kr.apply(this,arguments);return this._transaction.apply(this,e)},e.prototype._transaction=function(e,t,r){var n=this,i=Oe.trans;i&&i.db===this&&-1===e.indexOf("!")||(i=null);var o,s,a=-1!==e.indexOf("?");e=e.replace("!","").replace("?","");try{if(s=t.map((function(e){var t=e instanceof n.Table?e.name:e;if("string"!=typeof t)throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return t})),"r"==e||"readonly"===e)o="readonly";else{if("rw"!=e&&"readwrite"!=e)throw new te.InvalidArgument("Invalid transaction mode: "+e);o="readwrite"}if(i){if("readonly"===i.mode&&"readwrite"===o){if(!a)throw new te.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");i=null}i&&s.forEach((function(e){if(i&&-1===i.storeNames.indexOf(e)){if(!a)throw new te.SubTransaction("Table "+e+" not included in parent transaction.");i=null}})),a&&i&&!i.active&&(i=null)}}catch(e){return i?i._promise(null,(function(t,r){r(e)})):mt(e)}var c=Er.bind(null,this,o,s,i,r);return i?i._promise(o,c,"lock"):Oe.trans?lt(Oe.transless,(function(){return n._whenReady(c)})):this._whenReady(c)},e.prototype.table=function(e){if(!d(this._allTables,e))throw new te.InvalidTable("Table "+e+" does not exist");return this._allTables[e]},e}(),Hr="undefined"!=typeof Symbol&&"observable"in Symbol?Symbol.observable:"@@observable",Jr=function(){function e(e){this._subscribe=e}return e.prototype.subscribe=function(e,t,r){return this._subscribe(e&&"function"!=typeof e?e:{next:e,error:t,complete:r})},e.prototype[Hr]=function(){return this},e}();function Yr(e,t){return s(t).forEach((function(r){Ur(e[r]||(e[r]=new jr),t[r])})),e}function Qr(e){return new Jr((function(t){var r=F(e),n=!1,i={},o={},a={get closed(){return n},unsubscribe:function(){n=!0,Xt.storagemutated.unsubscribe(d)}};t.start&&t.start(a);var c=!1,u=!1;function l(){return s(o).some((function(e){return i[e]&&$r(i[e],o[e])}))}var d=function(e){Yr(i,e),l()&&h()},h=function(){if(!c&&!n){i={};var s={},f=function(t){r&&nt();var n=function(){return rt(e,{subscr:t,trans:null})},i=Oe.trans?lt(Oe.transless,n):n();return r&&i.then(it,it),i}(s);u||(Xt("storagemutated",d),u=!0),c=!0,Promise.resolve(f).then((function(e){c=!1,n||(l()?h():(i={},o=s,t.next&&t.next(e)))}),(function(e){c=!1,t.error&&t.error(e),a.unsubscribe()}))}};return h(),a}))}try{zr={indexedDB:o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:o.IDBKeyRange||o.webkitIDBKeyRange}}catch(e){zr={indexedDB:null,IDBKeyRange:null}}var Xr=Vr;function Zr(e){var t=en;try{en=!0,Xt.storagemutated.fire(e)}finally{en=t}}h(Xr,n(n({},ne),{delete:function(e){return new Xr(e,{addons:[]}).delete()},exists:function(e){return new Xr(e,{addons:[]}).open().then((function(e){return e.close(),!0})).catch("NoSuchDatabaseError",(function(){return!1}))},getDatabaseNames:function(e){try{return function(e){var t=e.indexedDB,r=e.IDBKeyRange;return Cr(t)?Promise.resolve(t.databases()).then((function(e){return e.map((function(e){return e.name})).filter((function(e){return"__dbnames"!==e}))})):_r(t,r).toCollection().primaryKeys()}(Xr.dependencies).then(e)}catch(e){return mt(new te.MissingAPI)}},defineClass:function(){return function(e){c(this,e)}},ignoreTransaction:function(e){return Oe.trans?lt(Oe.transless,e):e()},vip:Tr,async:function(e){return function(){try{var t=Pr(e.apply(this,arguments));return t&&"function"==typeof t.then?t:Le.resolve(t)}catch(e){return mt(e)}}},spawn:function(e,t,r){try{var n=Pr(e.apply(r,t||[]));return n&&"function"==typeof n.then?n:Le.resolve(n)}catch(e){return mt(e)}},currentTransaction:{get:function(){return Oe.trans||null}},waitFor:function(e,t){var r=Le.resolve("function"==typeof e?Xr.ignoreTransaction(e):e).timeout(t||6e4);return Oe.trans?Oe.trans.waitFor(r):r},Promise:Le,debug:{get:function(){return U},set:function(e){$(e,"dexie"===e?function(){return!0}:Ct)}},derive:m,extend:c,props:h,override:R,Events:Pt,on:Xt,liveQuery:Qr,extendObservabilitySet:Yr,getByKeyPath:T,setByKeyPath:w,delByKeyPath:function(e,t){"string"==typeof t?w(e,t,void 0):"length"in t&&[].map.call(t,(function(t){w(e,t,void 0)}))},shallowClone:D,deepClone:B,getObjectDiff:Br,cmp:Nt,asap:C,minKey:-1/0,addons:[],connections:yt,errnames:Z,dependencies:zr,semVer:"3.2.1",version:"3.2.1".split(".").map((function(e){return parseInt(e)})).reduce((function(e,t,r){return e+t/Math.pow(10,2*r)}))})),Xr.maxKey=nr(Xr.dependencies.IDBKeyRange),"undefined"!=typeof dispatchEvent&&"undefined"!=typeof addEventListener&&(Xt("storagemutated",(function(e){var t;en||(bt?(t=document.createEvent("CustomEvent")).initCustomEvent("x-storagemutated-1",!0,!0,e):t=new CustomEvent("x-storagemutated-1",{detail:e}),en=!0,dispatchEvent(t),en=!1)})),addEventListener("x-storagemutated-1",(function(e){var t=e.detail;en||Zr(t)})));var en=!1;if("undefined"!=typeof BroadcastChannel){var tn=new BroadcastChannel("x-storagemutated-1");Xt("storagemutated",(function(e){en||tn.postMessage(e)})),tn.onmessage=function(e){e.data&&Zr(e.data)}}else if("undefined"!=typeof self&&"undefined"!=typeof navigator){Xt("storagemutated",(function(e){try{en||("undefined"!=typeof localStorage&&localStorage.setItem("x-storagemutated-1",JSON.stringify({trig:Math.random(),changedParts:e})),"object"==typeof self.clients&&i([],self.clients.matchAll({includeUncontrolled:!0}),!0).forEach((function(t){return t.postMessage({type:"x-storagemutated-1",changedParts:e})})))}catch(e){}})),addEventListener("storage",(function(e){if("x-storagemutated-1"===e.key){var t=JSON.parse(e.newValue);t&&Zr(t.changedParts)}}));var rn=self.document&&navigator.serviceWorker;rn&&rn.addEventListener("message",(function(e){var t=e.data;t&&"x-storagemutated-1"===t.type&&Zr(t.changedParts)}))}Le.rejectionMapper=function(e,t){if(!e||e instanceof J||e instanceof TypeError||e instanceof SyntaxError||!e.name||!re[e.name])return e;var r=new re[e.name](t||e.message,e);return"stack"in e&&p(r,"stack",{get:function(){return this.inner.stack}}),r},$(U,Ct)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBState=void 0;const n=r(7);t.DBState=class{constructor(e){this.state=[],this.state=e}checkExceedDBMax(e){return this.getAllSize()+e.data.byteLength>n.DBUtils.dbMaxSize?{state:"overDBMax"}:{state:"lessThanDBMax"}}checkExceedRidMax(){return new Set(this.state.map(e=>e.rid)).size>=n.DBUtils.ridMaxNum?{state:"overRidMax"}:{state:"lessThanRidMax"}}checkRidExistence(e){return this.state.some(t=>t.rid===e.rid)?{state:"hasRid"}:{state:"notHavingRid"}}checkSliceExistence(e){var t,r;const{rid:i,range:o}=e,s=`${i}:${n.DBUtils.getRangeMB(o).rangeMB}`;return(null===(r=null===(t=this.selectById(s))||void 0===t?void 0:t.rangeArr)||void 0===r?void 0:r.includes(o))?{state:"hasRidAndIDAndSlice"}:{state:"hasRidAndIDNotSlice"}}checkIDExistence(e){const{rid:t,range:r}=e,i=`${t}:${n.DBUtils.getRangeMB(r).rangeMB}`;return this.selectById(i)?{state:"hasRidAndID"}:{state:"hasRidNotID"}}getAllSize(){return this.state.reduce((e,t)=>e+n.DBUtils.getSizeFromRangeArr(t.rangeArr),0)}findCanDeleteRids(){const e=Date.now(),t=[];let r=0;for(const{rid:i,lastUpdatedTime:o}of this.state){const s=e-o;s>=n.DBUtils.canDeleteMaxTimeDelta?t.push(i):s>=r&&(r=s)}return t.length?t:n.DBUtils.canDeleteMaxTimeDelta-r}getPriorityArr(e){if(!e)return this.state.filter(({id:e,priority:t,rangeArr:r})=>({id:e,priority:t,rangeArr:r})).sort((e,t)=>e.priority-t.priority);const t=this.selectByRid(e);return[...new Map(t.map(e=>[e.rid,{rid:e.rid,priority:e.priority}])).values()].sort((e,t)=>e.priority-t.priority)}selectByRid(e){return"string"==typeof e?this.state.filter(t=>t.rid===e):this.state.filter(t=>e.includes(t.rid))}selectById(e){return this.state.find(t=>t.id===e)}selectAll(e){return this.state.map(t=>e.reduce((e,r)=>Object.assign(Object.assign({},e),{[r]:t[r]}),{}))}updateState(e,t){const r=this.state.find(t=>t.id===e);if(r)return void t(r);const n={};t(n),this.state.push(n)}delete(e,t){this.state="id"!==e?"string"==typeof t?this.state.filter(e=>e.rid!==t):this.state.filter(e=>!t.includes(e.rid)):"string"==typeof t?this.state.filter(e=>e.id!==t):this.state.filter(e=>!t.includes(e.id))}notEmpty(){return this.state.length>0}isEmpty(){return 0===this.state.length}destroy(){this.state=[]}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dbEncryption=void 0,t.dbEncryption=new class{constructor(){this.hex="0123456789abcdef",this.chars="ghijklmnopqrstuv",this.map={};for(let e=0;e<this.hex.length;++e)this.map[this.hex[e]]=this.chars[e],this.map[this.chars[e]]=this.hex[e]}encode(e){let t="";for(let r=0;r<e.length;++r){const n=e.charCodeAt(r).toString(16);t+=this.hexTransformation(n)}return t+".nc"}decode(e){if(".nc"!==e.slice(-3))return e;const t=this.hexTransformation(e.slice(0,-3));let r="";for(let e=0;e<t.length;e+=2){const n=parseInt(t.slice(e,e+2),16);r+=String.fromCharCode(n)}return r}hexTransformation(e){let t="";for(let r=0;r<e.length;++r)t+=this.map[e[r]];return t}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCFactory=t.create=void 0;const n=r(0),i=r(20),o=r(66),s=n.__importDefault(r(3)),a=r(9),c=n.__importDefault(r(2)),u=r(7),l=n.__importDefault(r(6)),d=n.__importDefault(r(67)),h=r(70);function f(e,...t){switch(e){case"leecher":return new i.WebRTCLeecher(...t);case"seeder":return new o.WebRTCSeeder(...t)}}t.create=f;class p{constructor(e,t,r,n){this.sdk=e,this.socketController=t,this.dbController=r,this.promiseQueue=n,this.seeders=[],this.maxSeederNumOneTab=this.sdk.fawkesConfig.maxSeederNumOneTab,this.maxSeedersNumMultiTab=2,this.rtcStat=this.sdk.state.rtcStat,this.webrtcWorkshop1=new d.default(this.sdk,this.socketController),this.webrtcWorkshop2=new h.WebrtcWorkshop2(this.sdk,this.socketController),this.socketController.on(s.default.SOCKET_MESSAGE,this.onSocketMessage)}onSocketMessage(e){var t;return"activePeerV3"===(null==e?void 0:e.type)?this.sdk.saveDataEnabled?(this.dbController.initSaving(),this.dbController.enableReport=this.heartbeat(),this.dbController.enableReport?void this.dbController.initReport():void u.DBUtils.sLog("让存不让报")):(this.dbController.enableReport=!1,void u.DBUtils.sLog("不让存不让报")):e&&e.fromSocketID&&e.rid?"offer"===e.type&&e.data&&0===e.s?(this.rtcStat.receivedOffer+=1,null===(t=this.socketController)||void 0===t||t.reportStatToTracker("offerReceived"),void this.createSeeder({desc:e.data,leecherSid:e.fromSocketID,isSameIP:Boolean(e.isSameIP),rid:""+e.rid,db:this.dbController})):"released"===e.type?(u.DBUtils.sLog("tracker发来一个release消息",e.fromSocketID,e.rid),void this.releaseBySocket(e.fromSocketID,e.rid)):void 0:void 0}createSeeder(e){var t;const{leecherSid:r,isSameIP:n,rid:i,desc:o,db:c}=e,l=[this.sdk.isAdminBanSeeder(),this.handleOneTab(),this.handleMultiTab()].find(e=>e.banned);if(l){const e=a.createMessage("offerRejected",{code:l.code,rid:i,cPeerSocketID:r,msg:l.msg,s:1});return this.socketController.sendMessage(r,e),void u.DBUtils.sLog("received offer, but create seeder fail because it's been banned",{reason:l.msg,code:l.code,cPeerSid:r,seeders:this.seeders,offer:o})}this.rtcStat.offerAccepted++,null===(t=this.socketController)||void 0===t||t.reportStatToTracker("offerAccepted");const d=f("seeder",this.sdk,this.socketController,c,{leecherSid:r,isSameIP:n,rid:i});this.seeders.push(d),u.DBUtils.sLog("received offer, 创建了seeder并push到seeder数组里了",{seeders:this.seeders,cPeerSid:r}),d.on(s.default.WEBRTC_ANSWER_TIMEOUT,this.releaseBySocket),d.on(s.default.WEBRTC_CHANNEL_CLOSE,this.releaseBySocket),d.createAnswer(o)}handleOneTab(){return this.seeders.length>=this.maxSeederNumOneTab?{banned:!0,msg:`One SDK cannot handle over ${this.maxSeederNumOneTab} leechers`,code:40008}:{banned:!1}}handleMultiTab(){const[e,t]=c.default.tryCatchSync(JSON.parse,c.default.getLocalStorage("bp_nc_multi_tab"));return!e&&c.default.isObject(t)&&t[this.sdk.saveDataToken]?{banned:!1}:{banned:!0,msg:`Only allow for ${this.maxSeedersNumMultiTab} tabs supplying blood simultaneously`,code:40009}}releaseBySocket(e,t,r,n){if(!e)return;let i=-1;if(i=r?this.seeders.findIndex(n=>n.cPeerSocketID===e&&n.path===t&&n.uuid===r):this.seeders.findIndex(r=>r.cPeerSocketID===e&&r.path===t),-1===i)return void u.DBUtils.sLog((n||"tracker")+"触发了releaseSocket, 但是没找到",{sid:e,uuid:r,seeders:this.seeders});let[o]=this.seeders.splice(i,1);o.off(s.default.WEBRTC_ANSWER_TIMEOUT,this.releaseBySocket),o.off(s.default.WEBRTC_CHANNEL_CLOSE,this.releaseBySocket),o.destroy(),o=null,u.DBUtils.sLog((n||"tracker")+"触发了releaseSocket, 删除成功",{sid:e,uuid:r,seeders:this.seeders})}getData(e){const{path:t,rangeStart:r,rangeEnd:n,token:i,bitrate:o,latency:s,startTime:a}=e;return this.webrtcWorkshop2.getData(t,{start:r,end:n},i,o,s,a)}abortGetData(e){this.webrtcWorkshop1.abortGetData(e),this.webrtcWorkshop2.abortGetData(e)}destroy(){var e,t,r,n,i,o;null===(e=this.seeders)||void 0===e||e.forEach(e=>null==e?void 0:e.destroy()),this.seeders=[],null===(t=this.webrtcWorkshop1)||void 0===t||t.destroy(),null===(r=this.webrtcWorkshop2)||void 0===r||r.destroy(),(null===(n=this.dbController)||void 0===n?void 0:n.enableReport)&&this.beforeUnload(this.sdk.saveDataToken),this.heartbeatIntervalTimer&&window.clearInterval(this.heartbeatIntervalTimer),null===(o=null===(i=this.socketController)||void 0===i?void 0:i.off)||void 0===o||o.call(i,s.default.SOCKET_MESSAGE,this.onSocketMessage),delete this.webrtcWorkshop1,delete this.webrtcWorkshop2,delete this.sdk,delete this.socketController,delete this.dbController}beforeUnload(e){var t;const[r,n]=c.default.tryCatchSync(JSON.parse,c.default.getLocalStorage("bp_nc_multi_tab"));!r&&c.default.isObject(n)&&(delete n[(null===(t=this.sdk)||void 0===t?void 0:t.saveDataToken)||e],c.default.setLocalStorage("bp_nc_multi_tab",n))}heartbeat(){const e=this.sdk.saveDataToken,t=t=>c.default.setLocalStorage("bp_nc_multi_tab",Object.assign(Object.assign({},t),{[e]:Date.now()})),r=e=>{const[r,n]=c.default.tryCatchSync(JSON.parse,c.default.getLocalStorage("bp_nc_multi_tab"));if(r||!c.default.isObject(n))return t(),!0;if(!e)return void t(n);const i=Object.keys(n);if(i.length>=this.maxSeedersNumMultiTab){if(n[this.sdk.saveDataToken])return t(n),!0;const e=i.find(e=>Date.now()-n[e]>12e4);return!!e&&(delete n[e],t(n),!0)}return t(n),!0},n=r(!0);return n&&(void 0!==this.heartbeatIntervalTimer&&window.clearInterval(this.heartbeatIntervalTimer),this.heartbeatIntervalTimer=window.setInterval(()=>r(!1),3e4),c.default.onBeforeUnload(this.beforeUnload.bind(this,this.sdk.saveDataToken))),n}}n.__decorate([l.default],p.prototype,"onSocketMessage",null),n.__decorate([l.default],p.prototype,"releaseBySocket",null),n.__decorate([l.default],p.prototype,"beforeUnload",null),t.WebRTCFactory=p},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCSeeder=void 0;const n=r(0),i=n.__importDefault(r(6)),o=r(9),s=r(19),a=r(7),c=n.__importDefault(r(3)),u=n.__importDefault(r(1)),l=n.__importDefault(r(2)),d=r(37);class h extends d.WebRTCBase{constructor(e,t,r,n){super(e,t,n.leecherSid,n.isSameIP,n.rid),this.db=r,this.answerTimeoutTimer=0,this.answerTimeoutTime=3e4,this.uuid=l.default.randomString(10),this.bitrateLimit={maxBitrate:this.sdk.fawkesConfig.seederMaxBitrate,limitInterval:10},this.totalSentBytes=0,this.singleSentBytes=0,this.receivedCandidate=0,this.receivedCandidateAbove3=!1,this.identity="seeder",this.socketController.on(c.default.SOCKET_MESSAGE,this.onSocketMessage),this.init()}init(){super.init(),this.leecherSid=this.cPeerSocketID,this.rtcStat.answerInit=++this.rtcStat.answerInit||1,this.createAnswerTimeout(!1),this.dataChannel=this.peerConnection.createDataChannel("seederDataChannel",{ordered:!0,negotiated:!0,id:0}),this.dataChannelBindEvent()}dataChannelBindEvent(){this.dataChannel.onmessage=e=>{},this.dataChannel.onopen=()=>{var e,t;if("open"===(null===(e=this.dataChannel)||void 0===e?void 0:e.readyState)){this.createAnswerTimeout();const e=this.peerConnection.sctp;e&&e.maxMessageSize&&(this.maxMessageSize=e.maxMessageSize),u.default.getInstance().log(`${this.path} WebRTCSeeder dataChannel open -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, maxMessageSize: `+this.maxMessageSize),this.rtcStat.answerDataChannelOpen=++this.rtcStat.answerDataChannelOpen||1,null===(t=this.socketController)||void 0===t||t.reportStatToTracker("seederDataChannelOpen")}},this.dataChannel.onclose=()=>{this.isDestroyed||(a.DBUtils.sLog("datachannel close触发了",this.createLogData()),this.trigger(c.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.uuid,"dataChannel close"))}}selectSuitableBuffer(){var e;if(!this.fullResource)throw Object.assign(new Error("fullResource doesn't exist"),{code:40018});const[t,r]=a.DBUtils.parseRange(null===(e=this.getDataParam)||void 0===e?void 0:e.useRange);let n;if(n=Object.keys(this.fullResource).find(e=>a.DBUtils.isContainRange(e,t,r))){if(n===this.getDataParam.useRange)return this.fullResource[n];const e=a.DBUtils.parseRange(n)[0];return this.fullResource[n].slice(t-e,r-e+1)}return null}getDataFromDBOrCache(e=!1){return n.__awaiter(this,void 0,void 0,(function*(){if(!this.fullResource||e){const e=yield this.db.getResource(this.path,this.getDataParam.useRange,!0);this.fullResource=e.responseData;const t=this.selectSuitableBuffer();if(!t)throw new s.DBError(43007,"获取资源时没有该资源");return{getResourceTime:e.getResourceTime,responseData:t}}const t=this.selectSuitableBuffer();return t?{getResourceTime:0,responseData:t}:this.getDataFromDBOrCache(!0)}))}sendDataFromDB(){var e,t;return n.__awaiter(this,void 0,void 0,(function*(){if(this.createAnswerTimeout(!0),"open"===(null===(e=this.dataChannel)||void 0===e?void 0:e.readyState))try{const e=yield this.getDataFromDBOrCache();if(this.rtcStat.getDataFromDBSuccess=++this.rtcStat.getDataFromDBSuccess||1,e.responseData.byteLength!==this.getDataParam.needLength)throw Object.assign(new Error(`buffer:${e.responseData.byteLength} from indexedDB has unequal length with getDataParam:${this.getDataParam.needLength}`),{code:43015});if(this.isDestroyed)return;this.getFromDBTime=e.getResourceTime,this.sendData(e.responseData)}catch(e){if(this.isDestroyed)return;this.rtcStat.getDataFromDBFail=++this.rtcStat.getDataFromDBFail||1;const r=o.createMessage("getDataFromDBFail",{code:e.code,rid:this.path,data:JSON.stringify({range:this.getDataParam.useRange}),cPeerSocketID:this.cPeerSocketID,msg:e.message,s:1});null===(t=this.socketController)||void 0===t||t.sendMessage(this.leecherSid,r),u.default.getInstance().log("answer peer getDataFromDB Failed",e)}}))}sendData(e){var t;return n.__awaiter(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.byteLength)||"open"!==(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState)||(null==e?void 0:e.byteLength)!==this.getDataParam.needLength)return;u.default.getInstance().log(`${this.path} webRTCController sendData -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, totalSize: `+e.byteLength);const{maxMessageSize:r,bitrateLimit:{maxBitrate:n,limitInterval:i}}=this;let o=1e3*n/8*1e3/(1e3/i);o=o<=r?o:r,this.singleSentBytes=0,this.dataChannel.send(""+e.byteLength),this.sendDataWithBitrateLimit(e,o),this.rtcStat.sendSuccess=++this.rtcStat.sendSuccess||1}))}sendDataWithBitrateLimit(e,t,r=0,i=Date.now(),o=0){var s,c;return n.__awaiter(this,void 0,void 0,(function*(){if("open"!==(null===(s=this.dataChannel)||void 0===s?void 0:s.readyState))return;const n=e.byteLength;if(r*t>=n)return a.DBUtils.sLog("dataChannel发完了",Object.assign(Object.assign({},this.createLogData()),{singleSentTime:(Date.now()-i)/1e3,singleSentBytes:e.byteLength})),null===(c=this.socketController)||void 0===c||c.reportStatToTracker("sendSuccessBytes",e.byteLength),void this.rtcStat.sendFinished++;if(null===this.dataChannel)return void a.DBUtils.sLog("dataChannel断开了",this.createLogData());const u=(r+1)*t>=n?n-r*t:t,l=this.dataChannel.bufferedAmount;this.dataChannel.send(new Uint8Array(e,r*t,u)),this.dataChannel.bufferedAmountLowThreshold=l,this.rtcStat.sendBytes+=u;const d=performance.now();yield new Promise(e=>{this.dataChannel.onbufferedamountlow=()=>{this.dataChannel&&(this.dataChannel.onbufferedamountlow=null),this.singleSentBytes+=u,this.totalSentBytes+=u,this.rtcStat.sendSuccessBytes+=u,e()}});const h=performance.now()-d,f=10-h-o;if(f>0&&(r+1)*t<n){const n=performance.now(),o=yield new Promise(e=>window.setTimeout(()=>{const t=performance.now()-n;e(t-f)},f));this.sendDataWithBitrateLimit(e,t,r+1,i,o<0?0:o)}else this.sendDataWithBitrateLimit(e,t,r+1,i,10-h>0?Math.abs(f):o)}))}sendDataWithBitrateLimit2(e,t=Date.now(),r=0,i=0){return n.__awaiter(this,void 0,void 0,(function*(){const n=e.byteLength,{maxMessageSize:o,bitrateLimit:{maxBitrate:s,limitInterval:a}}=this;let c=1e3*s/8*1e3/(1e3/a);c=c<=o?c:o;const u=e.slice(r*c,(r+1)*c);if(r*n>=n)return;const l=this.dataChannel.bufferedAmount;this.dataChannel.send(u),this.dataChannel.bufferedAmountLowThreshold=l,yield new Promise(e=>this.dataChannel.addEventListener("bufferedamountlow",e)),Date.now()-t>1e3?this.sendDataWithBitrateLimit2(e,Date.now(),r+1,0):i>=125e3?(yield new Promise(e=>window.setTimeout(e,1e3-(Date.now()-t))),this.sendDataWithBitrateLimit2(e,Date.now(),r+1,0)):this.sendDataWithBitrateLimit2(e,t,r+1,i)}))}onSocketMessage(e){var t,r,n;if(e.rid===this.path&&e.fromSocketID===this.cPeerSocketID&&!this.isDestroyed){if("candidate"===e.type&&0===e.s){switch(this.receivedCandidate++,this.receivedCandidate){case 1:this.rtcStat.receivedCandidate1++,null===(t=this.socketController)||void 0===t||t.reportStatToTracker("receivedCandidate1");break;case 2:this.rtcStat.receivedCandidate2++,null===(r=this.socketController)||void 0===r||r.reportStatToTracker("receivedCandidate2");break;default:this.receivedCandidateAbove3||(this.receivedCandidateAbove3=!0,this.rtcStat.receivedCandidate3++,null===(n=this.socketController)||void 0===n||n.reportStatToTracker("receivedCandidate3"))}return u.default.getInstance().log("--------seeder onSocketMessage",this.cPeerSocketID,e),void super.addIcecandidate(e)}"getData"===e.type&&(this.getDataParam=JSON.parse(e.data),this.getDataParam.needLength=a.DBUtils.getSizeFromRange(this.getDataParam.useRange),a.DBUtils.sLog("seeder收到getData消息了",this.getDataParam),this.rtcStat.receivedGetData++,this.sendDataFromDB())}}createAnswer(e){e&&this.peerConnection&&(this.peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(e))).then(()=>{this.isDestroyed||(this.hasRemoteDescription=!0,u.default.getInstance().log(`${this.path} webRTCController setRemoteDescription success -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`))}).catch(e=>{var t;this.rtcStat.setRemoteDescErr++,null===(t=this.socketController)||void 0===t||t.reportStatToTracker("setRemoteDescErr"),u.default.getInstance().warn(`${this.path} webRTCController setRemoteDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, errorMessage: ${""+e}`)}),this.peerConnection.createAnswer().then(e=>{var t,r,n;if(this.isDestroyed)return;null===(t=this.peerConnection)||void 0===t||t.setLocalDescription(e).then(()=>{this.hasLocalDescription=!0,u.default.getInstance().log(`${this.path} webRTCController setLocalDescription success -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`)}).catch(e=>{var t;u.default.getInstance().warn(`${this.path} webRTCController setLocalDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, errorMessage: ${""+e}`),this.rtcStat.setLocalDescErr++,null===(t=this.socketController)||void 0===t||t.reportStatToTracker("setLocalDescErr")});const i=o.createMessage("answer",{data:JSON.stringify(e),rid:this.path,s:1});null===(r=this.socketController)||void 0===r||r.sendMessage(this.cPeerSocketID,i),null===(n=this.socketController)||void 0===n||n.reportStatToTracker("answerSent")},e=>{var t;null===(t=this.socketController)||void 0===t||t.reportStatToTracker("createAnswerErr"),this.isDestroyed||(this.rtcStat.createAnswerErr++,u.default.getInstance().warn(`${this.path} webRTCController createAnswer error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}, error: `+e.toString()))}))}destroy(){var e;u.default.getInstance().log(`${this.path} webRTCController destroy -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.identity}`),null===(e=this.socketController)||void 0===e||e.off(c.default.SOCKET_MESSAGE,this.onSocketMessage),this.receivedCandidate=0,this.receivedCandidateAbove3=!1,this.fullResource=null,super.destroy(),this.answerTimeoutTimer&&(window.clearTimeout(this.answerTimeoutTimer),this.answerTimeoutTimer=0)}createLogData(){const{rid:e,useRange:t,startTime:r,needLength:n}=this.getDataParam||{};return{rid:e,useRange:t,needLength:n,usedTime:(Date.now()-r)/1e3,cPeerSid:this.cPeerSocketID,totalSentBytes:this.totalSentBytes,singleSentBytes:this.singleSentBytes,getFromDBTime:this.getFromDBTime}}createAnswerTimeout(e=!0){e&&window.clearTimeout(this.answerTimeoutTimer),this.answerTimeoutTimer=window.setTimeout(()=>{a.DBUtils.sLog("answerTimeout触发了, 销毁RTC实例",this.createLogData()),this.trigger(c.default.WEBRTC_ANSWER_TIMEOUT,this.cPeerSocketID,this.path,this.uuid,"answer timeout")},this.answerTimeoutTime)}}n.__decorate([i.default],h.prototype,"onSocketMessage",null),t.WebRTCSeeder=h},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importDefault(r(3)),o=n.__importDefault(r(6)),s=n.__importDefault(r(1)),a=r(20),c=n.__importDefault(r(68)),u=r(9);class l{constructor(e,t){this.peerRtcInfoByRid={},this.receivedBufferInfoByRid={},this.getDataTimeoutTimerByRid={},this.channelOpenTimeoutTimerByRid={},this.retryCountMax=2,this.peersCounter=0,this.sdk=e,this.socketController=t,this.webrtcStore=new c.default,this.bind()}bind(){this.webrtcStore.addListener("eject",e=>{const{rid:t,range:r,arrayBuffer:n}=e,{startTime:i,originRange:o,latency:s,retryCount:a,availablePeerRtcControllers:c}=this.peerRtcInfoByRid[t];this.peerRtcInfoByRid[t].resolve({code:24e3,msg:"success",responseData:{range:r,from:0,path:t,getDataTime:Date.now()-i,data:n,gotDataByte:n.byteLength,cPeerSID:"store",originRange:o,useRange:r,startTime:i,usePeerSids:c.map(e=>e.cPeerSocketID),latency:s,retryCount:a}})}),this.webrtcStore.addListener("pause",({rid:e,sid:t})=>{const r=u.createMessage("pause",{rid:e});this.socketController.sendMessage(t,r)}),this.webrtcStore.addListener("resume",({rid:e,sid:t})=>{const r=u.createMessage("resume",{rid:e});this.socketController.sendMessage(t,r)})}createWorkShop(e,t,r,i,o,s,a,c){return n.__awaiter(this,void 0,void 0,(function*(){this.peerRtcInfoByRid[e]||(this.peerRtcInfoByRid[e]={}),s||(this.peerRtcInfoByRid[e].resolve=a,this.peerRtcInfoByRid[e].reject=c),this.peerRtcInfoByRid[e].rid=e,this.peerRtcInfoByRid[e].originRange=t,this.peerRtcInfoByRid[e].originToken=r,this.peerRtcInfoByRid[e].bitrate=i,this.peerRtcInfoByRid[e].latency=o,this.peerRtcInfoByRid[e].retryCount=s,this.peerRtcInfoByRid[e].startTime=Date.now(),this.webrtcStore.setActiveRange(e,t)}))}checkRidCount(e){const t=Object.keys(this.peerRtcInfoByRid);if(s.default.getInstance().log("[checkRidCount], rids: "+t),t.length>=3&&t.filter(e=>e.indexOf("30280.m4s")>0)){const[r]=t.filter(t=>t.indexOf("30280.m4s")<0&&t!==e);this.releasePeer(r,!0),this.clearReceivedBufferInfo(r),this.clearGetDataTimeout(r),this.clearChannelOpenTimeout(r),this.clearPeerInfo(r)}}setPeersByRid(e){var t,r,o;return n.__awaiter(this,void 0,void 0,(function*(){if(null===(t=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===t?void 0:t.length){const t=this.peerRtcInfoByRid[e].peerRtcControllers;for(let r=0;r<t.length;r++)"open"!==t[r].dataChannelState&&this.releasePeer(e,t[r].index);if(this.peerRtcInfoByRid[e].peerRtcControllers.length)return}const{peers:n,shouldResPeerNum:s}=yield this.getPeers(e);for(let t=0;t<n.length;t++){this.peersCounter++;const s=new a.WebRTCLeecher(this.sdk,this.socketController,n[t].id,Boolean(n[t].isSameIP),e,this.peersCounter,"",this.webrtcStore);s.createOffer(),s.on(i.default.WEBRTC_CHANNEL_CLOSE,this.onWebRTCChannelClose),s.on(i.default.WEBRTC_GET_DATA_FAIL,this.onWebRTCGetDataFail),s.on(i.default.WEBRTC_OFFER_REJECTED,this.onWebRTCOfferRejected),(null===(r=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===r?void 0:r.length)||(this.peerRtcInfoByRid[e].peerRtcControllers=[]),(null===(o=this.peerRtcInfoByRid[e].availablePeerRtcControllers)||void 0===o?void 0:o.length)||(this.peerRtcInfoByRid[e].availablePeerRtcControllers=[]),this.peerRtcInfoByRid[e].peerRtcControllers.push(s)}this.peerRtcInfoByRid[e].shouldResPeerNum=s,yield this.createChannelOpenTimeout(e)}))}createChannelOpenTimeout(e){return new Promise((t,r)=>{s.default.getInstance().log("[createChannelOpenTimeout], rid: "+e);const n=this.peerRtcInfoByRid[e].peerRtcControllers;for(let r=0;r<n.length;r++){const o=n[r];o.on(i.default.WEBRTC_CHANNEL_OPEN,()=>{s.default.getInstance().log(`[onWebRTCChannelOpen], sid: ${o.cPeerSocketID}, rid: ${e}, index: ${o.index}`),this.peerRtcInfoByRid[e].availablePeerRtcControllers.push(o),this.peerRtcInfoByRid[e].peerRtcControllers.length===this.peerRtcInfoByRid[e].availablePeerRtcControllers.length&&(this.clearChannelOpenTimeout(e),t())})}this.channelOpenTimeoutTimerByRid[e]=window.setTimeout(()=>{if(this.clearChannelOpenTimeout(e),!this.peerRtcInfoByRid[e])return;const n=this.peerRtcInfoByRid[e].peerRtcControllers;for(let t=0;t<n.length;t++)"open"!==n[t].dataChannelState&&this.releasePeer(e,n[t].index);this.peerRtcInfoByRid[e].availablePeerRtcControllers.length?t():(s.default.getInstance().log("[channelOpenTimeout], rid: "+e),r({code:41e3,msg:"webrtc data channel open timeout",responseData:this.makeResponseData(e)}))},2e3)})}setUseRanges(e){var t;return n.__awaiter(this,void 0,void 0,(function*(){const r=this.peerRtcInfoByRid[e].originRange,n=this.peerRtcInfoByRid[e].availablePeerRtcControllers.length;if(n<=1)return void(this.peerRtcInfoByRid[e].useRanges=[r]);const i=r.start;let o=r.end-i+1,s=0,a=[];for(;o>0;)s=s>=n?0:s,a[s]||(a[s]=0),o<l.allocatedByteLength?a[s]+=o:a[s]+=l.allocatedByteLength,o-=l.allocatedByteLength,s++;const c=[];for(let e=0;e<a.length;e++){let r=(null===(t=c[e-1])||void 0===t?void 0:t.end)+1||i,n=r+a[e]-1;c.push({start:r,end:n})}this.peerRtcInfoByRid[e].useRanges=c}))}getPeers(e){return n.__awaiter(this,void 0,void 0,(function*(){const{originRange:t,bitrate:r}=this.peerRtcInfoByRid[e];return yield this.socketController.getPeerInfo(e,t,r)}))}createFlowLine(e,t){return n.__awaiter(this,void 0,void 0,(function*(){let{useRanges:r,originToken:n,originRange:i,bitrate:o,latency:s,retryCount:a,startTime:c,resolve:u,reject:d}=this.peerRtcInfoByRid[e],h=this.peerRtcInfoByRid[e].availablePeerRtcControllers;if(t&&(i={start:t,end:1/0},h.length<1))try{this.peerRtcInfoByRid[e].isStoreResume=!0,yield this.setPeersByRid(e),h=this.peerRtcInfoByRid[e].availablePeerRtcControllers}catch(r){this.createFlowLine(e,t)}finally{this.peerRtcInfoByRid[e].isStoreResume=!1}const f=[];for(let t=0;t<h.length;t++){const r=h[t];r&&f.push(r.getData({rid:e,originRange:i,useRange:i,originToken:n,token:n,startTime:c||Date.now(),latency:s,retryCount:a,prefetch:Math.ceil(this.webrtcStore.defaultMinUseHeapSize/h.length),totalPeerCount:h.length,allocatedByteLength:l.allocatedByteLength,allocatedIndex:+t}))}this.peerRtcInfoByRid[e].bufferPromise=f}))}mergeFlowLines(e,t=0){return new Promise((r,i)=>{const{bufferPromise:o}=this.peerRtcInfoByRid[e],s=[],a=[];if(o&&o.length)for(let c=0;c<o.length;c++)o[c].then(e=>{s.push(e)}).catch(e=>{a.push(e)}).finally(()=>n.__awaiter(this,void 0,void 0,(function*(){var n;if(null===(n=this.peerRtcInfoByRid[e])||void 0===n||delete n.bufferPromise,a.length>0)return this.clearReceivedBufferInfo(e),void i(a[0]);yield this.handlePromiseFulfilledResult(e,s),yield this.handlePromiseRejectedResult(e,a,t),s.length===o.length&&r()})))})}handlePromiseFulfilledResult(e,t){return n.__awaiter(this,void 0,void 0,(function*(){if(t.length)for(let r=0;r<t.length;r++){const{start:n,end:i}=t[r].responseData.useRange,o=`${n}-${i}`;this.receivedBufferInfoByRid[e]||(this.receivedBufferInfoByRid[e]={}),this.receivedBufferInfoByRid[e][o]=t[r]}}))}handlePromiseRejectedResult(e,t,r){return n.__awaiter(this,void 0,void 0,(function*(){if(!t.length)return;if(r>this.retryCountMax)return;const n=[];for(let e=0;e<t.length;e++)n.push(t[e].responseData.useRange);yield this.createFlowLine(e),yield this.mergeFlowLines(e,++r)}))}mergeRanges(e,t,r){const n=t.sort((e,t)=>e.start-t.start),i=n[0].start,o=n[n.length-1].end;for(let t=0;t<n.length;t++){const{start:r,end:i}=n[t],o=this.peerRtcInfoByRid[e].useRanges.findIndex(e=>e.start===r&&e.end===i);this.peerRtcInfoByRid[e].useRanges.splice(o,1)}const s={start:i,end:o};return this.peerRtcInfoByRid[e].useRanges.push(s),[s]}mergeResult(e){const t=Object.keys(this.receivedBufferInfoByRid[e]).sort((e,t)=>+e.split("-")[0]-+t.split("-")[0]);let r,n,i,o=[];for(let r=0;r<t.length;r++){o.push(this.receivedBufferInfoByRid[e][t[r]].responseData.cPeerSID);const{uint8:s,originRange:a}=this.receivedBufferInfoByRid[e][t[r]].responseData,c=a.end-a.start+1;n||(n=new Uint8Array(c),i=0),n.set(s,i),i+=s.byteLength}return r={code:this.receivedBufferInfoByRid[e][t[0]].code,msg:this.receivedBufferInfoByRid[e][t[0]].msg,responseData:Object.assign(Object.assign({},this.receivedBufferInfoByRid[e][t[0]].responseData),{usePeerSids:o})},r.responseData.retryCount=this.peerRtcInfoByRid[e].retryCount,r.responseData.data=n.buffer,r.responseData.gotDataByte=n.byteLength,r.responseData.getDataTime=Date.now()-r.responseData.startTime,delete r.responseData.uint8,delete r.responseData.useRange,delete r.responseData.cPeerSID,this.clearReceivedBufferInfo(e),r}clearReceivedBufferInfo(e){delete this.receivedBufferInfoByRid[e]}clearPeerInfo(e){delete this.peerRtcInfoByRid[e]}onWebRTCGetDataFail(e,t,r){s.default.getInstance().log(`[onWebRTCGetDataFail], sid: ${e}, rid: ${t}, index: ${r}`),this.releasePeer(t,r)}onWebRTCChannelOpen(e,t,r){s.default.getInstance().log(`[onWebRTCChannelOpen], sid: ${e}, rid: ${t}, index: ${r}`);const n=this.peerRtcInfoByRid[t].peerRtcControllers;for(let r=0;r<n.length;r++)if(n[r].cPeerSocketID===e){this.peerRtcInfoByRid[t].availablePeerRtcControllers.push(n[r]);break}}onWebRTCChannelClose(e,t,r){s.default.getInstance().log(`[onWebRTCChannelClose], sid: ${e}, rid: ${t}, index: ${r}`),this.releasePeer(t,r)}onWebRTCOfferRejected(e,t,r,n){s.default.getInstance().log(`[onWebRTCOfferRejected], sid: ${e}, rid: ${t}, index: ${r}`),this.peerRtcInfoByRid[t].offerRejectedRes=n,this.releasePeer(t,r)}releasePeer(e,t){if(s.default.getInstance().log(`[releasePeer], rid: ${e}, arg: ${t}`),!this.peerRtcInfoByRid[e])return;if("auto"===t){const t=this.peerRtcInfoByRid[e].peerRtcControllers.sort((e,t)=>e.getReceivedDataByte()-t.getReceivedDataByte());if(!t.length)return;const r=t[0];return this.socketController.releasePeerInfo(r.cPeerSocketID,e),this.webrtcStore.rmPeerStateFromSid(e,r.cPeerSocketID),r.off(i.default.WEBRTC_CHANNEL_OPEN),r.off(i.default.WEBRTC_CHANNEL_CLOSE),r.off(i.default.WEBRTC_GET_DATA_FAIL),r.off(i.default.WEBRTC_OFFER_REJECTED),r.destroy(),this.peerRtcInfoByRid[e].peerRtcControllers=this.peerRtcInfoByRid[e].peerRtcControllers.filter(e=>e.index!==r.index),void(this.peerRtcInfoByRid[e].availablePeerRtcControllers=this.peerRtcInfoByRid[e].availablePeerRtcControllers.filter(e=>e.index!==r.index))}const r=this.peerRtcInfoByRid[e].peerRtcControllers;for(let n=0;n<(null==r?void 0:r.length);n++){const o=r[n];if(o.path===e&&(o.index===t||!0===t)){this.socketController.releasePeerInfo(o.cPeerSocketID,e),this.webrtcStore.rmPeerStateFromSid(e,o.cPeerSocketID),o.off(i.default.WEBRTC_CHANNEL_OPEN),o.off(i.default.WEBRTC_CHANNEL_CLOSE),o.off(i.default.WEBRTC_GET_DATA_FAIL),o.off(i.default.WEBRTC_OFFER_REJECTED),o.destroy(),this.peerRtcInfoByRid[e].peerRtcControllers=this.peerRtcInfoByRid[e].peerRtcControllers.filter(e=>e.index!==o.index),this.peerRtcInfoByRid[e].availablePeerRtcControllers=this.peerRtcInfoByRid[e].availablePeerRtcControllers.filter(e=>e.index!==o.index);break}}const n=this.webrtcStore.clearInvalidArrayBuffer(e);s.default.getInstance().log(`[store-resume-pre], rid: ${e}, latestRangeStart: ${n}`,this.peerRtcInfoByRid[e].isStoreResume),n&&!this.peerRtcInfoByRid[e].isStoreResume&&(s.default.getInstance().log(`[store-resume], rid: ${e}, latestRangeStart: ${n}`),this.createFlowLine(e,n))}getPeersLegacy(e){const{peerRtcControllers:t,availablePeerRtcControllers:r}=this.peerRtcInfoByRid[e];let n=[],i=0,o=0;if(!t||!r)return{uint8Array:new Uint8Array(i),receivedDataByte:o};for(let e=0;e<t.length;e++){const r=t[e],s=r.getReceivedU8Buffer()||new Uint8Array(0);n.push(s),i+=s.byteLength,o+=r.getReceivedDataByte()}let s=0,a=new Uint8Array(i);for(let e=0;e<n.length;e++)a.set(n[e],s),s+=n[e].byteLength;return{uint8Array:a,receivedDataByte:o}}makeResponseData(e){var t;const{originRange:r,startTime:n,retryCount:i,latency:o,availablePeerRtcControllers:s}=this.peerRtcInfoByRid[e],a=[];if(s)for(let e=0;e<s.length;e++)a.push(s[e].cPeerSocketID);return{range:r.start+"-"+r.end,originRange:r,usePeerSids:a,from:0,path:e,getDataTime:Date.now()-n,startTime:n,latency:o,gotDataByte:(null===(t=this.webrtcStore.getIncompleteArrayBuffer(e,r))||void 0===t?void 0:t.byteLength)||0,cPeerSID:"",retryCount:i}}clearGetDataTimeout(e){s.default.getInstance().log("[clearGetDataTimeout], rid: "+e),this.getDataTimeoutTimerByRid[e]&&(clearTimeout(this.getDataTimeoutTimerByRid[e]),delete this.getDataTimeoutTimerByRid[e])}clearChannelOpenTimeout(e){s.default.getInstance().log("[clearChannelOpenTimeout], rid: "+e),this.channelOpenTimeoutTimerByRid[e]&&(clearTimeout(this.channelOpenTimeoutTimerByRid[e]),delete this.channelOpenTimeoutTimerByRid[e])}pausePeerSynthesizedData(e){s.default.getInstance().log("[pausePeerSynthesizedData], rid: "+e);let t=this.peerRtcInfoByRid[e].availablePeerRtcControllers;for(let e=0;e<t.length;e++){const r=t[e];r&&r.reset()}}createGetDataTimeout(e,t,r){s.default.getInstance().log(`[createGetDataTimeout], rid: ${e}, latency: ${t}, retryCount: ${r}`),r||(this.clearGetDataTimeout(e),this.getDataTimeoutTimerByRid[e]=window.setTimeout(()=>{if(s.default.getInstance().log(`[getDataTimeoutTimerByRid], rid: ${e}, latency: ${t}, retryCount: ${r}`),!this.peerRtcInfoByRid[e])return;const n={code:40003,msg:"getData timeout",responseData:this.makeResponseData(e)};this.pausePeerSynthesizedData(e),this.clearReceivedBufferInfo(e),this.clearGetDataTimeout(e),this.releasePeer(e,"auto"),this.webrtcStore.restoreArrayBuffer(e),this.peerRtcInfoByRid[e].reject(n)},t-30))}useWorkShop(e,t,r,i=0,o=5e3,a=0){return new Promise((c,u)=>n.__awaiter(this,void 0,void 0,(function*(){try{switch(this.createGetDataTimeout(e,o,a),yield this.createWorkShop(e,t,r,i,o,a,c,u),this.webrtcStore.detectActiveBuffer(e)){case"create":break;case"short":case"pending":case"resolve":return}this.webrtcStore.restoreArrayBuffer(e),yield this.setPeersByRid(e),yield this.createFlowLine(e)}catch(n){if(!this.getDataTimeoutTimerByRid[e])return;if(s.default.getInstance().log(`[useWorkShop catch], rid: ${e}, retryCount: ${a}`,n),n.responseData||(n.responseData=this.makeResponseData(e)),a>0)u(n);else{if([40003,40001,40007,51007].includes(n.code))return void u(n);this.useWorkShop(e,t,r,i,o,++a).then(c).catch(u)}}})))}destroy(){for(const e in this.peerRtcInfoByRid)this.releasePeer(e,!0),this.clearReceivedBufferInfo(e),this.clearGetDataTimeout(e),this.clearChannelOpenTimeout(e),this.clearPeerInfo(e);this.webrtcStore.removeAllListeners("eject"),this.webrtcStore.removeAllListeners("pause"),this.webrtcStore.removeAllListeners("resume"),this.webrtcStore.destroy(),delete this.webrtcStore,delete this.sdk,delete this.socketController}getData(e,t,r,i=0,o=5e3){return n.__awaiter(this,void 0,void 0,(function*(){try{return yield this.useWorkShop(e,t,r,i,o)}catch(e){throw e}finally{this.clearGetDataTimeout(e)}}))}abortGetData(e){this.clearGetDataTimeout(e.path)}}l.allocatedByteLength=32768,n.__decorate([o.default],l.prototype,"onWebRTCGetDataFail",null),n.__decorate([o.default],l.prototype,"onWebRTCChannelOpen",null),n.__decorate([o.default],l.prototype,"onWebRTCChannelClose",null),n.__decorate([o.default],l.prototype,"onWebRTCOfferRejected",null),t.default=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importStar(r(69)),o=n.__importDefault(r(1));class s extends i.EventEmitter{constructor(){super(...arguments),this.arraybufferInfoFromRid={},this.activeRangeFromRid={},this.defaultMaxGap=10485760,this.defaultMinUseHeapSize=10485760}getSavedByteLength(){let e=0;for(let t in this.arraybufferInfoFromRid){let r=0;for(let e in this.arraybufferInfoFromRid[t].arraybufferFromRangeString)r+=this.arraybufferInfoFromRid[t].arraybufferFromRangeString[e].byteLength;e+=r,o.default.getInstance().log("[getSavedByteLength]",t,r,r/1024/1024)}return e}setActiveRange(e,t){this.activeRangeFromRid[e]=t}rmPeerStateFromSid(e,t){this.arraybufferInfoFromRid[e]&&delete this.arraybufferInfoFromRid[e].peerStateFromSid[t]}saveArrayBuffer(e,t,r,n,i,s){const a=n+i*s,c=`${a}-${a+r.byteLength-1}`;if(o.default.getInstance().log("[saveArrayBuffer]",e,"start:",n,"saveRangeIndex:",i,"key:",c,"allocatedByteLength",s),!this.arraybufferInfoFromRid[e])return this.arraybufferInfoFromRid[e]={rid:e,allocatedByteLength:s,receivedLastDataCount:0,peerStateFromSid:{},arraybufferFromRangeString:{[c]:r}},void this.detectActiveBuffer(e);this.arraybufferInfoFromRid[e].peerStateFromSid[t]||(this.arraybufferInfoFromRid[e].peerStateFromSid[t]={savedByteLength:0}),this.arraybufferInfoFromRid[e].peerStateFromSid[t].savedByteLength+=r.byteLength,this.arraybufferInfoFromRid[e].arraybufferFromRangeString[c]=r,this.detectActiveBuffer(e)}getArrayBuffer(e,t,r){if(!this.arraybufferInfoFromRid[e])return null;if(!this.activeRangeFromRid[e])return null;o.default.getInstance().log("[getArrayBuffer]","enoughRange:",r,t);let n=new Uint8Array(0);for(let i in t){const o=+t[+i].split("-")[0],s=+t[+i].split("-")[1],a=`${o}-${s}`;if(o>=r.start&&s<=r.end){const{start:t,end:i}=this.activeRangeFromRid[e];let c,u=this.arraybufferInfoFromRid[e].arraybufferFromRangeString[a];if(delete this.arraybufferInfoFromRid[e].arraybufferFromRangeString[a],o<t&&(this.calLeftByteLength(e,t-o),u=u.slice(t-o)),c=n,n=new Uint8Array(n.byteLength+u.byteLength),n.set(c),n.set(u,c.byteLength),s===r.end){const o=i-t+1,s=n.slice(0,o),a=n.slice(o);if(a.byteLength){const t=r.end-a.byteLength+1,n=r.end;this.arraybufferInfoFromRid[e].arraybufferFromRangeString[`${t}-${n}`]=a}return this.calLeftByteLength(e,o),this.resumeSend(e),s}}else o<r.start&&(this.calLeftByteLength(e,s-o+1),delete this.arraybufferInfoFromRid[e].arraybufferFromRangeString[a])}return null}getIncompleteArrayBuffer(e,t){if(!this.arraybufferInfoFromRid[e])return null;o.default.getInstance().log("[getIncompleteArrayBuffer]","targetRange:",t);const r=Object.keys(this.arraybufferInfoFromRid[e].arraybufferFromRangeString).sort((e,t)=>+e.split("-")[0]-+t.split("-")[0]);let n;for(let i in r){const o=+r[+i].split("-")[0],s=+r[+i].split("-")[1],a=`${o}-${s}`,c=this.arraybufferInfoFromRid[e].arraybufferFromRangeString[a];if(o<=t.start&&s>=t.start){if(!n){n=new Uint8Array(c);continue}const e=n;n=new Uint8Array(c.byteLength+e.byteLength),n.set(e),n.set(c,e.byteLength)}else if(o>=t.start&&s<=t.end){if(!n){n=new Uint8Array(c);continue}const e=n;n=new Uint8Array(c.byteLength+e.byteLength),n.set(e),n.set(c,e.byteLength)}else if(o>=t.start&&o<=t.end&&s>=t.start){if(!n){n=new Uint8Array(c);continue}const e=n;n=new Uint8Array(c.byteLength+e.byteLength),n.set(e),n.set(c,e.byteLength)}}return n}calLeftByteLength(e,t){const r=Object.keys(this.arraybufferInfoFromRid[e].peerStateFromSid),n=Math.floor(t/r.length),i=t%r.length;for(let t=0;t<r.length;t++)this.arraybufferInfoFromRid[e].peerStateFromSid[r[t]].savedByteLength-=n,t===r.length-1&&(this.arraybufferInfoFromRid[e].peerStateFromSid[r[t]].savedByteLength-=i);o.default.getInstance().log("[calLeftByteLength-end]",e,"consumedByteLength:",t,"state:",JSON.stringify(this.arraybufferInfoFromRid[e].peerStateFromSid))}resumeSend(e,t,r){if(this.arraybufferInfoFromRid[e].receivedLastDataCount>=5)return;const n=Object.keys(this.arraybufferInfoFromRid[e].peerStateFromSid);for(let i=0;i<n.length;i++){const s=n[i];if(!t||t===s){const{savedByteLength:t}=this.arraybufferInfoFromRid[e].peerStateFromSid[s];(r||t<=Math.ceil(this.defaultMinUseHeapSize/Object.keys(this.arraybufferInfoFromRid[e].peerStateFromSid).length))&&(o.default.getInstance().log("[resumeSend]",e,s,"savedByteLength:",t),this.emit("resume",{rid:e,sid:s}))}}}checkSavedArrayBuffer(e,t,r,n){var i;o.default.getInstance().log("[checkSavedArrayBuffer]",e,"enoughRangeStart:",t,"enoughRangeEnd:",r);const{start:s,end:a}=this.activeRangeFromRid[e],c=[];let u=0;for(let l in n){const d=+n[+l].split("-")[0],h=+n[+l].split("-")[1],f=`${d}-${h}`,p=+(null===(i=n[+l+1])||void 0===i?void 0:i.split("-")[0]);if(h<s)this.calLeftByteLength(e,h-d+1),delete this.arraybufferInfoFromRid[e].arraybufferFromRangeString[f];else{if(p&&p-h!=1)return u++,u*this.arraybufferInfoFromRid[e].allocatedByteLength>=this.defaultMaxGap&&(o.default.getInstance().log("[break-gap-pauseSend]",e,t,r,n),this.clearInvalidArrayBuffer(e)),o.default.getInstance().log("[checkSavedArrayBuffer-break]",e,t,r,f,n),"short";if(c.push(n[l]),h>=a)return this.emit("eject",{rid:e,range:this.activeRangeFromRid[e],arrayBuffer:this.getArrayBuffer(e,c,{start:t,end:h}).buffer}),delete this.activeRangeFromRid[e],"resolve"}}}restoreArrayBuffer(e){o.default.getInstance().log("[restoreArrayBuffer]",e),delete this.arraybufferInfoFromRid[e]}clearInvalidArrayBuffer(e){var t,r,n;if(!this.arraybufferInfoFromRid[e])return;const i=Object.keys(this.arraybufferInfoFromRid[e].arraybufferFromRangeString).sort((e,t)=>+e.split("-")[0]-+t.split("-")[0]);if(!i.length)return;for(let n in i){const s=+i[+n].split("-")[0],a=+i[+n].split("-")[1],c=`${s}-${a}`,u=+(null===(t=i[+n+1])||void 0===t?void 0:t.split("-")[0]),l=`${u}-${+(null===(r=i[+n+1])||void 0===r?void 0:r.split("-")[1])}`;u&&u-a!=1&&(o.default.getInstance().log("[clearInvalidArrayBuffer]",e,c,l),delete this.arraybufferInfoFromRid[e].arraybufferFromRangeString[c],delete this.arraybufferInfoFromRid[e].arraybufferFromRangeString[l])}const s=Object.keys(this.arraybufferInfoFromRid[e].arraybufferFromRangeString).sort((e,t)=>+e.split("-")[0]-+t.split("-")[0]);return+(null===(n=s[s.length-1])||void 0===n?void 0:n.split("-")[0])}detectActiveBuffer(e){let t="default";if(!this.activeRangeFromRid[e])return t="ready",o.default.getInstance().log("[detectActiveBuffer]",e,t),t;if(!this.arraybufferInfoFromRid[e])return t="create",o.default.getInstance().log("[detectActiveBuffer]",e,t),t;const r=Object.keys(this.arraybufferInfoFromRid[e].arraybufferFromRangeString).sort((e,t)=>+e.split("-")[0]-+t.split("-")[0]);if(!r.length)return o.default.getInstance().log("[detectActiveBuffer]",e,t),t="forward",t;let n=+r[0].split("-")[0],i=+r[r.length-1].split("-")[1];const{start:s,end:a}=this.activeRangeFromRid[e];return n<=s&&i>=a?t=this.checkSavedArrayBuffer(e,n,i,r):n>s?t="backward":s>i?t="forward":i>n&&(t="pending"),o.default.getInstance().log("[detectActiveBuffer]",e,"hasRange:",{rangeStart:n,rangeEnd:i},"activeRange:",this.activeRangeFromRid[e],"detect status:",t),t}setReceivedLastDataCount(e,t){this.arraybufferInfoFromRid[e]&&(0===t?this.arraybufferInfoFromRid[e].receivedLastDataCount=0:this.arraybufferInfoFromRid[e].receivedLastDataCount++)}getReceivedLastDataCount(e){var t;return(null===(t=this.arraybufferInfoFromRid[e])||void 0===t?void 0:t.receivedLastDataCount)||0}destroy(){this.arraybufferInfoFromRid={},this.activeRangeFromRid={}}}t.default=s},function(e,t,r){"use strict";var n,i="object"==typeof Reflect?Reflect:null,o=i&&"function"==typeof i.apply?i.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};n=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,e.exports.once=function(e,t){return new Promise((function(r,n){function i(r){e.removeListener(t,o),n(r)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",i),r([].slice.call(arguments))}v(e,t,o,{once:!0}),"error"!==t&&function(e,t,r){"function"==typeof e.on&&v(e,"error",t,r)}(e,i,{once:!0})}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function u(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function d(e,t,r,n){var i,o,s,a;if(u(r),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),s=o[t]),void 0===s)s=o[t]=r,++e._eventsCount;else if("function"==typeof s?s=o[t]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),(i=l(e))>0&&s.length>i&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,a=c,console&&console.warn&&console.warn(a)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=h.bind(n);return i.listener=r,n.wrapFn=i,i}function p(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):g(i,i.length)}function m(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function g(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function v(e,t,r,n){if("function"==typeof e.on)n.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(o){n.once&&e.removeEventListener(t,i),r(o)}))}}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=i[e];if(void 0===c)return!1;if("function"==typeof c)o(c,this,t);else{var u=c.length,l=g(c,u);for(r=0;r<u;++r)o(l[r],this,t)}return!0},a.prototype.addListener=function(e,t){return d(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return d(this,e,t,!0)},a.prototype.once=function(e,t){return u(t),this.on(e,f(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return u(t),this.prependListener(e,f(this,e,t)),this},a.prototype.removeListener=function(e,t){var r,n,i,o,s;if(u(t),void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){s=r[o].listener,i=o;break}if(i<0)return this;0===i?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,o=Object.keys(r);for(n=0;n<o.length;++n)"removeListener"!==(i=o[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},a.prototype.listeners=function(e){return p(this,e,!0)},a.prototype.rawListeners=function(e){return p(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},a.prototype.listenerCount=m,a.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebrtcWorkshop2=void 0;const n=r(0),i=n.__importStar(r(3)),o=n.__importDefault(r(6)),s=n.__importDefault(r(1)),a=r(20),c=n.__importDefault(r(2)),u=n.__importDefault(r(12));class l{constructor(e,t){this.peerRtcInfoByRid={},this.overallTimeoutTimerByRid={},this.peersCounter=0,this.sdk=e,this.socketController=t,u.default.getInstance().on(i.WorkshopEvent.GET_DATA_SUCCESS,this.onWorkshopGetDataSuccess),u.default.getInstance().on(i.WorkshopEvent.GET_DATA_FAIL,this.onWorkshopGetDataFail)}getData(e,t,r,i=0,o=5e3,s){return n.__awaiter(this,void 0,void 0,(function*(){return new Promise((a,c)=>n.__awaiter(this,void 0,void 0,(function*(){const n=t=>r=>(t(r),this.afterOutermostResolveOrReject(e));o=this.fiddleLatency(o,s),this.createWorkShop(e,t,r,i,o,n(a),n(c)),this.createOverallTimeout(e,o,n(c));try{yield this.initLeecher(e)}catch(e){return void n(c)(e)}this.startConnection(e)})))}))}fiddleLatency(e,t){const r=e;return t>0&&(e-=Date.now()-t),(isNaN(e)||e<100)&&(e=100),r-e>1e3&&s.default.getInstance().log(`------ latency is ${e}, originLatency is ${r}`),e}abortGetData(e){this.clearOverallTimeout(e.path)}createWorkShop(e,t,r,n,i,o,s){this.peerRtcInfoByRid[e]||(this.peerRtcInfoByRid[e]={},this.checkRidCount(e)),this.peerRtcInfoByRid[e]=Object.assign(Object.assign({},this.peerRtcInfoByRid[e]),{rid:e,originRange:t,originToken:r,bitrate:n,latency:i,startTime:Date.now(),outermostResolve:o,outermostReject:s,receivedTotalBytes:0,receivedSuccessBytes:0,bufferPromise:[],finished:!1,failureReason:[]})}checkRidCount(e){const t=Object.keys(this.peerRtcInfoByRid||{});if(t.length>=3){const r=t.find(t=>!t.includes("30280.m4s")&&t!==e);this.releasePeer(r,!0),this.clearPeerInfo(r),this.clearOverallTimeout(r)}}createOverallTimeout(e,t,r){s.default.getInstance().log(`[createGetDataTimeout], rid: ${e}, latency: ${t}`),this.overallTimeoutTimerByRid[e]=window.setTimeout(()=>{var n,i;if(this.overallTimeoutTimerByRid[e]=0,s.default.getInstance().log(`[getDataTimeoutTimerByRid], rid: ${e}, latency: ${t}`),!this.peerRtcInfoByRid[e])return;const o={code:40003,msg:"getData timeout: "+(null===(i=null===(n=this.peerRtcInfoByRid[e].failureReason)||void 0===n?void 0:n.map(e=>e.msg))||void 0===i?void 0:i.join(",")),responseData:this.makeResponseData(e)};this.releasePeer(e,"auto"),r(o)},t-this.sdk.fawkesConfig.dashBufferTime)}initLeecher(e){var t,r,o;return n.__awaiter(this,void 0,void 0,(function*(){if(null===(t=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===t?void 0:t.length){const{peerRtcControllers:t}=this.peerRtcInfoByRid[e];for(const r of t)"open"!==r.dataChannelState&&this.releasePeer(e,r.index);if(t.length)return void(t.some(e=>"browser"===e.peerTarget)&&(null===(r=this.socketController)||void 0===r||r.reportStatToTracker("hasBrowserPeer")))}const[n,s]=yield c.default.tryCatchAsync(this.getPeers(e));if(n)throw{code:n.code||40016,msg:n.msg,responseData:this.makeResponseData(e)};this.peerRtcInfoByRid[e].shouldResPeerNum=s.shouldResPeerNum,this.peerRtcInfoByRid[e].donationShouldResPeerNum=s.donationShouldResPeerNum,this.peerRtcInfoByRid[e].peerRtcControllers=[];for(const{id:t,isSameIP:r}of s.peers){const n=new a.WebRTCLeecher(this.sdk,this.socketController,t,!!r,e,this.peersCounter,c.default.randomString(10));n.createOffer(),n.on(i.default.WEBRTC_CHANNEL_OPEN,this.onWebRTCChannelOpen),n.on(i.default.WEBRTC_CHANNEL_CLOSE,this.onWebRTCChannelClose),n.on(i.default.WEBRTC_CHANNEL_OPEN_TIMEOUT,this.onWebRTCChannelOpenTimeout),n.on(i.default.WEBRTC_GET_DATA_FAIL,this.onWebRTCGetDataFail),n.on(i.default.WEBRTC_GET_DATA_TIMEOUT,this.onWebRTCGetDataTimeout),n.on(i.default.WEBRTC_OFFER_REJECTED,this.onWebRTCOfferRejected),this.peerRtcInfoByRid[e].peerRtcControllers.push(n),this.peersCounter++}this.peerRtcInfoByRid[e].peerRtcControllers.some(e=>"browser"===e.peerTarget)&&(null===(o=this.socketController)||void 0===o||o.reportStatToTracker("hasBrowserPeer"))}))}getPeers(e){const{originRange:t,bitrate:r}=this.peerRtcInfoByRid[e];return this.socketController.getPeerInfo(e,t,r)}startConnection(e){const{peerRtcControllers:t}=this.peerRtcInfoByRid[e];this.setUseRanges(e,2*t.length);for(const r of t.filter(e=>e.isOpen)){const t=this.peerRtcInfoByRid[e].useRanges.find(e=>!e.assigned||e.aborted);if(!t)return;this.assignTask(r,t,e)}}setUseRanges(e,t){const r=e=>({range:e,assigned:!1,completed:!1,aborted:!1}),n=this.peerRtcInfoByRid[e].originRange;if(t<=2)return void(this.peerRtcInfoByRid[e].useRanges=[r(n)]);const{start:i,end:o}=n,s=Math.floor((o-i+1)/t),a=Math.floor((o-i+1)%t);if(s<=1)return void(this.peerRtcInfoByRid[e].useRanges=[r(n)]);const c=[];for(let e=0;e<t;e++){let n=i+e*s,o=i+(e+1)*s-1;e===t-1&&(o+=a),c.push(r({start:n,end:o}))}this.peerRtcInfoByRid[e].useRanges=c}assignTask(e,t,r){if("open"!==(null==e?void 0:e.dataChannelState)||(null==e?void 0:e.isSucking)||this.isRidFinished(r)||!t)return;s.default.getInstance().log("派活啦",e.index,JSON.stringify(t),r);const{originToken:n,originRange:o,latency:a,startTime:c}=this.peerRtcInfoByRid[r]||{};this.setUseRangeStatus(t,"start"),this.peerRtcInfoByRid[r].bufferPromise.push({leecher:e,promise:e.getData({rid:r,originRange:o,useRange:t.range,originToken:n,token:n+"-"+t.range.end,startTime:c||Date.now(),latency:a}).then(n=>{if(!this.isRidFinished(r))return this.setUseRangeStatus(t,"fulfilled",e.index),s.default.getInstance().log(e.index,"完成任务",r,JSON.stringify(t)),u.default.getInstance().trigger(i.WorkshopEvent.GET_DATA_SUCCESS,e,r),this.mergeBuffer(r,n),n}).catch(e=>{if(!this.isRidFinished(r))return this.setUseRangeStatus(t,"rejected"),u.default.getInstance().trigger(i.WorkshopEvent.GET_DATA_FAIL,r,t),l.isPromiseResponse(e)&&(this.peerRtcInfoByRid[r].receivedTotalBytes+=e.responseData.gotDataByte||0,this.peerRtcInfoByRid[r].failureReason.push({code:e.code,msg:e.msg})),e})})}isRidFinished(e){var t,r;return void 0===(null===(t=this.peerRtcInfoByRid[e])||void 0===t?void 0:t.finished)||!0===(null===(r=this.peerRtcInfoByRid[e])||void 0===r?void 0:r.finished)}mergeBuffer(e,t){var r;let{originRange:n,useRanges:i}=this.peerRtcInfoByRid[e];if(!n||!i)throw{code:40015,msg:"merge buffer error",responseData:{gotDataByte:t.responseData.uint8.byteLength}};const o=n.end-n.start+1,s=(r=this.peerRtcInfoByRid[e]).resBuffer||(r.resBuffer=new Uint8Array(o));s.set(t.responseData.uint8,t.responseData.useRange.start-n.start),this.peerRtcInfoByRid[e].receivedTotalBytes+=t.responseData.uint8.byteLength,this.peerRtcInfoByRid[e].receivedSuccessBytes+=t.responseData.uint8.byteLength,i.every(e=>e.completed)&&this.peerRtcInfoByRid[e].receivedSuccessBytes===o&&s.byteLength===o&&this.peerRtcInfoByRid[e].outermostResolve({code:24e3,msg:"success",responseData:Object.assign(Object.assign({},this.makeResponseData(e)),{data:s.buffer,cPeerSID:""})})}setUseRangeStatus(e,t,r){switch(t){case"start":e.assigned=!0,e.completed=!1,e.aborted=!1;break;case"fulfilled":e.assigned=!0,e.completed=!0,e.aborted=!1,e.ownerIndex=r;break;case"rejected":e.assigned=!0,e.completed=!1,e.aborted=!0}}onWebRTCGetDataFail(e,t,r){s.default.getInstance().log(`[onWebRTCGetDataFail], sid: ${e}, rid: ${t}, index: ${r}`),this.releasePeer(t,r)}onWebRTCChannelClose(e,t,r,n){var i,o;s.default.getInstance().log(`[onWebRTCChannelClose], sid: ${e}, rid: ${t}, index: ${r}`),n&&(null===(i=this.peerRtcInfoByRid[t].failureReason)||void 0===i||i.push({code:n.code,msg:n.msg})),"browser"===c.default.getPeerTarget(e)&&(null===(o=this.socketController)||void 0===o||o.reportStatToTracker("browserSeederClose")),this.releasePeer(t,r)}onWebRTCOfferRejected(e,t,r,{code:n,msg:i}){var o;s.default.getInstance().log(`[onWebRTCOfferRejected], sid: ${e}, rid: ${t}, index: ${r}`),null===(o=this.peerRtcInfoByRid[t].failureReason)||void 0===o||o.push({code:n,msg:i}),this.releasePeer(t,r)}onWebRTCGetDataTimeout(e,t,r){s.default.getInstance().log(`[onWebRTCGetDataTimeout], sid: ${e}, rid: ${t}, index: ${r}`),this.releasePeer(t,r)}onWebRTCChannelOpenTimeout(e,t,r){var n;s.default.getInstance().log(`[onWebRTCChannelOpenTimeout], sid: ${e}, rid: ${t}, index: ${r}`),null===(n=this.peerRtcInfoByRid[t].failureReason)||void 0===n||n.push({code:40012,msg:"channelOpenTimeout"}),this.releasePeer(t,r),this.updateChannelOpenFailRecord(e,"incr"),this.updateBadHistoryPeers(e)}onWebRTCChannelOpen(e,t,r){s.default.getInstance().log(`[onWebRTCChannelOpen], sid: ${e}, rid: ${t}, index: ${r}`),this.updateChannelOpenFailRecord(e,"clear"),this.updateGoodHistoryPeers(e);const{useRanges:n,peerRtcControllers:i}=this.peerRtcInfoByRid[t]||{},o=i.find(e=>e.index===r),a=n.find(e=>!e.assigned||e.aborted);a&&this.assignTask(o,a,t)}onWorkshopGetDataSuccess(e,t){s.default.getInstance().log(`[onWorkshopGetDataSuccess], rid: ${t}, leecher: ${e}`);const r=this.peerRtcInfoByRid[t].useRanges.find(e=>!e.assigned||e.aborted);r&&this.assignTask(e,r,t)}onWorkshopGetDataFail(e,t){s.default.getInstance().log(`[onWorkshopGetDataFail], rid: ${e}, useRange: ${JSON.stringify(t)}`);const r=this.peerRtcInfoByRid[e].peerRtcControllers.find(e=>"open"===e.dataChannelState&&!e.isSucking);r&&this.assignTask(r,t,e)}updateChannelOpenFailRecord(e,t){var r;const n=c.default.getPeerTarget(e);if("unknown"!==n)if("incr"!==t)"clear"!==t||("box"===n?"number"==typeof this.socketController.channelOpenFailRecord.boxPeer&&(this.socketController.channelOpenFailRecord.boxPeer=0):"number"==typeof this.socketController.channelOpenFailRecord.browserPeer&&(this.socketController.channelOpenFailRecord.browserPeer=0));else{const e=this.socketController.channelOpenFailRecord,t=this.sdk.fawkesConfig.maxRetryPeerConfig;"box"===n&&"rejected"!==e.boxPeer?++e.boxPeer>=t.boxPeer&&(e.boxPeer="rejected",this.instantReject("all",`successive ${t.boxPeer} box peer cannot open, shut down nc`),this.socketController.disconnect()):"browser"===n&&"rejected"!==e.browserPeer&&++e.browserPeer>=t.browserPeer&&(null===(r=this.socketController)||void 0===r||r.reportStatToTracker("successiveBrowserPeerNotOpen"),e.browserPeer="rejected")}}updateBadHistoryPeers(e){var t;const{badHistoryPeers:r,goodHistoryPeers:n}=this.socketController;if(n.includes(e))return;const i=r[e]||(r[e]={count:0,reported:!1});if(i.count++,i.count>=this.sdk.fawkesConfig.badHistoryPeerMax&&!n.length)return this.instantReject("all","this client's quality is bad, shut down nc"),void this.socketController.disconnect();i.count>=5&&!i.reported&&(i.reported=!0,null===(t=this.socketController)||void 0===t||t.reportBadCPeerSID(e))}updateGoodHistoryPeers(e){const{goodHistoryPeers:t,badHistoryPeers:r}=this.socketController;t.includes(e)||t.push(e),r[e]&&delete r[e]}afterOutermostResolveOrReject(e){var t;(null===(t=this.peerRtcInfoByRid)||void 0===t?void 0:t[e])&&(delete this.peerRtcInfoByRid[e].resBuffer,delete this.peerRtcInfoByRid[e].bufferPromise,this.peerRtcInfoByRid[e].receivedTotalBytes=0,this.peerRtcInfoByRid[e].finished=!0,this.peerRtcInfoByRid[e].failureReason=[],this.clearOverallTimeout(e))}instantReject(e,t){Object.keys(this.peerRtcInfoByRid||{}).forEach(e=>{this.peerRtcInfoByRid[e].outermostReject({code:40020,msg:t,responseData:this.makeResponseData(e)}),this.peerRtcInfoByRid[e].finished=!0})}makeResponseData(e){const{originRange:t,startTime:r,latency:n,receivedTotalBytes:i=0,useRanges:o,peerRtcControllers:s}=this.peerRtcInfoByRid[e]||{},a=(c=(o||[]).filter(e=>"number"==typeof e.ownerIndex).map(e=>e.ownerIndex).reduce((e,t)=>{const r=s.find(e=>e.index===t);return(null==r?void 0:r.cPeerSocketID)&&e.push(r.cPeerSocketID),e},[]),[...new Set(c)]);var c;return{range:(null==t?void 0:t.start)+"-"+(null==t?void 0:t.end),originRange:t,usePeerSids:a,from:0,path:e,getDataTime:Date.now()-r,startTime:r,latency:n,gotDataByte:i+((null==s?void 0:s.reduce((e,t)=>e+t.getReceivedDataByte(),0))||0)}}clearOverallTimeout(e){this.overallTimeoutTimerByRid[e]&&window.clearTimeout(this.overallTimeoutTimerByRid[e]),delete this.overallTimeoutTimerByRid[e]}clearPeerInfo(e){delete this.peerRtcInfoByRid[e]}destroy(){Object.keys(this.peerRtcInfoByRid||{}).forEach(e=>{this.releasePeer(e,!0),this.clearPeerInfo(e),this.clearOverallTimeout(e)}),u.default.getInstance().off(i.WorkshopEvent.GET_DATA_SUCCESS,this.onWorkshopGetDataSuccess),u.default.getInstance().off(i.WorkshopEvent.GET_DATA_FAIL,this.onWorkshopGetDataFail),delete this.sdk,delete this.socketController}releasePeer(e,t){var r,n,o,a,c;if(s.default.getInstance().log(`[releasePeer], rid: ${e}, arg: ${t}`),!this.peerRtcInfoByRid[e])return;const{peerRtcControllers:u=[],useRanges:l=[]}=this.peerRtcInfoByRid[e];let d=!1;for(const n of u)"auto"===t&&n.getReceivedDataByte()===n.getNeedDataByte()&&0!==n.getReceivedDataByte()||("auto"===t&&0!==n.getNeedDataByte()&&n.getReceivedDataByte()/n.getNeedDataByte()>=.85?s.default.getInstance().log(`[releasePeer-continue], rid: ${e}, arg: ${n.index}`):"auto"===t&&l.some(({ownerIndex:e})=>"number"==typeof e&&e===n.index)||n.path===e&&(n.index!==t&&"auto"!==t&&!0!==t||(d=!0,this.socketController.releasePeerInfo(n.cPeerSocketID,e),n.off(i.default.WEBRTC_CHANNEL_OPEN,this.onWebRTCChannelOpen),n.off(i.default.WEBRTC_CHANNEL_CLOSE,this.onWebRTCChannelClose),n.off(i.default.WEBRTC_GET_DATA_FAIL,this.onWebRTCGetDataFail),n.off(i.default.WEBRTC_OFFER_REJECTED,this.onWebRTCOfferRejected),n.off(i.default.WEBRTC_GET_DATA_TIMEOUT,this.onWebRTCGetDataTimeout),n.destroy(),this.peerRtcInfoByRid[e].peerRtcControllers=(null===(r=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===r?void 0:r.filter(e=>e.index!==n.index))||[])));0===(null===(n=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===n?void 0:n.length)&&this.overallTimeoutTimerByRid[e]&&d&&this.peerRtcInfoByRid[e].outermostReject({code:(null===(o=this.peerRtcInfoByRid[e].failureReason[0])||void 0===o?void 0:o.code)||40016,msg:null===(c=null===(a=this.peerRtcInfoByRid[e].failureReason)||void 0===a?void 0:a.map(e=>e.msg))||void 0===c?void 0:c.join(","),responseData:this.makeResponseData(e)})}static isPromiseResponse(e){return"code"in e&&"msg"in e&&"responseData"in e}}n.__decorate([o.default],l.prototype,"onWebRTCGetDataFail",null),n.__decorate([o.default],l.prototype,"onWebRTCChannelClose",null),n.__decorate([o.default],l.prototype,"onWebRTCOfferRejected",null),n.__decorate([o.default],l.prototype,"onWebRTCGetDataTimeout",null),n.__decorate([o.default],l.prototype,"onWebRTCChannelOpenTimeout",null),n.__decorate([o.default],l.prototype,"onWebRTCChannelOpen",null),n.__decorate([o.default],l.prototype,"onWorkshopGetDataSuccess",null),n.__decorate([o.default],l.prototype,"onWorkshopGetDataFail",null),t.WebrtcWorkshop2=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromiseQueue=void 0,t.PromiseQueue=class{constructor(){this._queue=[],this.isPending=!1}enqueue(e,t=!1){return new Promise((r,n)=>{this._queue[t?"unshift":"push"]({promiseMaker:e,resolve:r,reject:n}),this._dequeue()})}_dequeue(){if(this.isPending)return!1;const e=this._queue.shift();if(!e)return!1;try{this.isPending=!0,e.promiseMaker().then(t=>{this.isPending=!1,e.resolve(t),this._dequeue()}).catch(t=>{this.isPending=!1,e.reject(t),this._dequeue()})}catch(t){this.isPending=!1,e.reject(t),this._dequeue()}}destroy(){this._queue=[],this.isPending=!1}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0;const n=r(0),i=r(7),o=n.__importDefault(r(1)),s=n.__importDefault(r(2));t.Config=class{constructor(e,t){this.sdk=e,this.enableReportTrackerRatio=5,this.leecherChannelOpenTimeout=2e3,this.dashBufferTime=30,this.leecherChannelMessageTimeout=3500,this.realNcAllowedMaxQn=30076,this.realNcAllowedAV1MaxQn=100025,this.resourceBlockSize=100,this.maxSeederNumOneTab=1,this.maxRetryPeerConfig={browserPeer:20,boxPeer:10},this.disableDonationTime=5,this.vendors=["tx","hw"],this.cidLastNums=[100,0],this.vendor="tx",this.badHistoryPeerMax=30,this.seederMaxBitrate=2,this.getFawkesConfig(t),this.setVendor(t)}getFawkesConfig(e){if(s.default.isObject(e)&&s.default.isObject(e.fawkesConfig)){if(e.fawkesConfig["nc_sdk_policy.enable_report_tracker_ratio"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.enable_report_tracker_ratio"]);Number.isNaN(t)||(this.enableReportTrackerRatio=t),this.sdk.reportToTrackerEnabled=Math.floor(100*Math.random())<this.enableReportTrackerRatio}if(e.fawkesConfig["nc_sdk_policy.leecher_channel_open_timeout"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.leecher_channel_open_timeout"]);Number.isNaN(t)||(this.leecherChannelOpenTimeout=t)}if(e.fawkesConfig["nc_sdk_policy.leecher_channel_message_timeout"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.leecher_channel_message_timeout"]);Number.isNaN(t)||(this.leecherChannelMessageTimeout=t)}if(e.fawkesConfig["nc_sdk_policy.dash_buffer_time"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.dash_buffer_time"]);Number.isNaN(t)||(this.dashBufferTime=t)}if(e.fawkesConfig["nc_sdk_policy.real_nc_allowed_max_qn"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.real_nc_allowed_max_qn"]);Number.isNaN(t)||(this.realNcAllowedMaxQn=t),s.default.realP2PRestrictions.qn[0][1]=this.realNcAllowedMaxQn}if(e.fawkesConfig["nc_sdk_policy.real_nc_allowed_av1_max_qn"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.real_nc_allowed_av1_max_qn"]);Number.isNaN(t)||(this.realNcAllowedAV1MaxQn=t),s.default.realP2PRestrictions.qn[2][1]=this.realNcAllowedAV1MaxQn}if(e.fawkesConfig["nc_sdk_policy.resource_block_size"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.resource_block_size"]);Number.isNaN(t)||(this.resourceBlockSize=t),i.DBUtils.resourceBlockSize=this.resourceBlockSize}if(e.fawkesConfig["nc_sdk_policy.max_seeder_num_one_tab"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.max_seeder_num_one_tab"]);Number.isNaN(t)||(this.maxSeederNumOneTab=t)}if(e.fawkesConfig["nc_sdk_policy.max_retry_peer_config"])try{const t=JSON.parse(e.fawkesConfig["nc_sdk_policy.max_retry_peer_config"]),r=Object.keys(t),n=["browserPeer","boxPeer"];for(const e of r){const r=parseInt(t[e]);if(Number.isNaN(r)||r<=0)throw new Error("值不为数字或者值小于等于0")}if(!n.every(e=>r.includes(e)))throw new Error("少 key");this.maxRetryPeerConfig=t}catch(e){o.default.getInstance().warn("JSON.parse nc_sdk_policy.max_retry_peer_config error"+e)}if(e.fawkesConfig["nc_sdk_policy.disable_donation_time"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.disable_donation_time"]);Number.isNaN(t)||(this.disableDonationTime=t)}if(e.fawkesConfig["nc_sdk_policy.seeder_max_bitrate"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.seeder_max_bitrate"]);Number.isNaN(t)||(this.seederMaxBitrate=t)}if(e.fawkesConfig["common_policy.vendors"])try{this.vendors=JSON.parse(e.fawkesConfig["common_policy.vendors"])}catch(e){o.default.getInstance().warn("parse common_policy.vendors error!")}if(e.fawkesConfig["common_policy.cid_last_nums"])try{this.cidLastNums=JSON.parse(e.fawkesConfig["common_policy.cid_last_nums"])}catch(e){o.default.getInstance().warn("parse common_policy.cid_last_nums error!")}if(e.fawkesConfig["nc_sdk_policy.bad_history_peer_max"]){const t=parseInt(e.fawkesConfig["nc_sdk_policy.bad_history_peer_max"]);Number.isNaN(t)||(this.badHistoryPeerMax=t)}}}setVendor(e){const t=e.cid.toString(),r=+t.substring(t.length-2),n=this.vendors,i=this.cidLastNums;for(let e in i)if(r<i[e]){n[e]&&(this.vendor=n[e]);break}}}},function(e,t,r){"use strict";r.r(t);var n={};r.r(n),r.d(n,"shimGetUserMedia",(function(){return _})),r.d(n,"shimGetDisplayMedia",(function(){return C})),r.d(n,"shimMediaStream",(function(){return S})),r.d(n,"shimOnTrack",(function(){return T})),r.d(n,"shimGetSendersWithDtmf",(function(){return w})),r.d(n,"shimGetStats",(function(){return D})),r.d(n,"shimSenderReceiverGetStats",(function(){return P})),r.d(n,"shimAddTrackRemoveTrackWithNative",(function(){return k})),r.d(n,"shimAddTrackRemoveTrack",(function(){return E})),r.d(n,"shimPeerConnection",(function(){return I})),r.d(n,"fixNegotiationNeeded",(function(){return O}));var i={};r.r(i),r.d(i,"shimGetUserMedia",(function(){return A})),r.d(i,"shimGetDisplayMedia",(function(){return L})),r.d(i,"shimPeerConnection",(function(){return N})),r.d(i,"shimReplaceTrack",(function(){return M}));var o={};r.r(o),r.d(o,"shimGetUserMedia",(function(){return j})),r.d(o,"shimGetDisplayMedia",(function(){return F})),r.d(o,"shimOnTrack",(function(){return U})),r.d(o,"shimPeerConnection",(function(){return $})),r.d(o,"shimSenderGetStats",(function(){return W})),r.d(o,"shimReceiverGetStats",(function(){return G})),r.d(o,"shimRemoveStream",(function(){return K})),r.d(o,"shimRTCDataChannel",(function(){return z})),r.d(o,"shimAddTransceiver",(function(){return q})),r.d(o,"shimGetParameters",(function(){return V})),r.d(o,"shimCreateOffer",(function(){return H})),r.d(o,"shimCreateAnswer",(function(){return J}));var s={};r.r(s),r.d(s,"shimLocalStreamsAPI",(function(){return Y})),r.d(s,"shimRemoteStreamsAPI",(function(){return Q})),r.d(s,"shimCallbacksAPI",(function(){return X})),r.d(s,"shimGetUserMedia",(function(){return Z})),r.d(s,"shimConstraints",(function(){return ee})),r.d(s,"shimRTCIceServerUrls",(function(){return te})),r.d(s,"shimTrackEventTransceiver",(function(){return re})),r.d(s,"shimCreateOfferLegacy",(function(){return ne})),r.d(s,"shimAudioContext",(function(){return ie}));var a={};r.r(a),r.d(a,"shimRTCIceCandidate",(function(){return ae})),r.d(a,"shimMaxMessageSize",(function(){return ce})),r.d(a,"shimSendThrowTypeError",(function(){return ue})),r.d(a,"shimConnectionState",(function(){return le})),r.d(a,"removeAllowExtmapMixed",(function(){return de}));let c=!0,u=!0;function l(e,t,r){const n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function d(e,t,r){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,i=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return i.apply(this,arguments);const o=e=>{const t=r(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,o),i.apply(this,[e,o])};const o=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(r))return o.apply(this,arguments);const n=this._eventMap[t].get(r);return this._eventMap[t].delete(r),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function h(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(c=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function f(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(u=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function p(){if("object"==typeof window){if(c)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function m(e,t){u&&console.warn(e+" is deprecated, please use "+t+" instead.")}function g(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:r}=e;if(r.mozGetUserMedia)t.browser="firefox",t.version=l(r.userAgent,/Firefox\/(\d+)\./,1);else if(r.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=l(r.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(r.mediaDevices&&r.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=l(r.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!r.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=l(r.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}function v(e){return"[object Object]"===Object.prototype.toString.call(e)}function y(e){return v(e)?Object.keys(e).reduce((function(t,r){const n=v(e[r]),i=n?y(e[r]):e[r],o=n&&!Object.keys(i).length;return void 0===i||o?t:Object.assign(t,{[r]:i})}),{}):e}function b(e,t,r){const n=r?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;const o=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)}),o.forEach(t=>{e.forEach(r=>{r.type===n&&r.trackId===t.id&&function e(t,r,n){r&&!n.has(r.id)&&(n.set(r.id,r),Object.keys(r).forEach(i=>{i.endsWith("Id")?e(t,t.get(r[i]),n):i.endsWith("Ids")&&r[i].forEach(r=>{e(t,t.get(r),n)})}))}(e,r,i)})}),i}const R=p;function _(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const r=g(e),n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;const n="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[i("min",r)]=n.ideal,t.optional.push(e),e={},e[i("max",r)]=n.ideal,t.optional.push(e)):(e[i("",r)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",r)]=n.exact):["min","max"].forEach(e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,r)]=n[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,i){if(r.version>=61)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=r.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||s)){let r;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?r=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(r=["front"]),r)return t.mediaDevices.enumerateDevices().then(t=>{let s=(t=t.filter(e=>"videoinput"===e.kind)).find(e=>r.some(t=>e.label.toLowerCase().includes(t)));return!s&&t.length&&r.includes("back")&&(s=t[t.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=n(e.video),R("chrome: "+JSON.stringify(e)),i(e)})}e.video=n(e.video)}return R("chrome: "+JSON.stringify(e)),i(e)},o=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,n){i(e,e=>{t.webkitGetUserMedia(e,r,e=>{n&&n(o(e))})})}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return i(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return e},e=>Promise.reject(o(e))))}}}function C(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then(t=>{const n=r.video&&r.video.width,i=r.video&&r.video.height,o=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},n&&(r.video.mandatory.maxWidth=n),i&&(r.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(r)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function S(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function T(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===r.track.id):{track:r.track};const i=new Event("track");i.track=r.track,i.receiver=n,i.transceiver={receiver:n},i.streams=[t.stream],this.dispatchEvent(i)}),t.stream.getTracks().forEach(r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===r.id):{track:r};const i=new Event("track");i.track=r,i.receiver=n,i.transceiver={receiver:n},i.streams=[t.stream],this.dispatchEvent(i)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else d(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function w(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let i=r.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function D(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const i=function(e){const t={};return e.result().forEach(e=>{const r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{r[t]=e.stat(t)}),t[r.id]=r}),t},o=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};if(arguments.length>=2){const n=function(e){r(o(i(e)))};return t.apply(this,[n,e])}return new Promise((e,r)=>{t.apply(this,[function(t){e(o(i(t)))},r])}).then(r,n)}}function P(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>b(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),d(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>b(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,r,n;return this.getSenders().forEach(r=>{r.track===e&&(t?n=!0:t=r)}),this.getReceivers().forEach(t=>(t.track===e&&(r?n=!0:r=t),t.track===e)),n||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function k(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();r.apply(this,arguments);const n=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const r=this._shimmedLocalStreams[t].indexOf(e);-1!==r&&this._shimmedLocalStreams[t].splice(r,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),i.apply(this,arguments)}}function E(e){if(!e.RTCPeerConnection)return;const t=g(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return k(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const r=new e.MediaStream(t.getTracks());this._streams[t.id]=r,this._reverseStreams[r.id]=t,t=r}n.apply(this,[t])};const i=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(i.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:r})}function s(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const i=this.getSenders().find(e=>e.track===t);if(i)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[r.id];if(o)o.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const n=new e.MediaStream([t]);this._streams[r.id]=n,this._reverseStreams[n.id]=r,this.addStream(n)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[t=>{const r=o(this,t);e[0].apply(null,[r])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):r.apply(this,arguments).then(e=>o(this,e))}};e.RTCPeerConnection.prototype[t]=n[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=s(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(r=>{this._streams[r].getTracks().find(t=>e.track===t)&&(t=this._streams[r])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function I(e){const t=g(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const r=0===e.RTCPeerConnection.prototype.addIceCandidate.length;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}));const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return r||arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function O(e){const t=g(e);d(e,"negotiationneeded",e=>{const r=e.target;if(!(t.version<72||r.getConfiguration&&"plan-b"===r.getConfiguration().sdpSemantics)||"stable"===r.signalingState)return e})}var B=r(38),x=r.n(B);function A(e){const t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch(e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))}}function L(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}function N(e){const t=g(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const r=new Event("enabled");r.enabled=e,this.dispatchEvent(r)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const r=x()(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let r=!1;return(e=JSON.parse(JSON.stringify(e))).filter(e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&m("RTCIceServer.url","RTCIceServer.urls");const n="string"==typeof t;return n&&(t=[t]),t=t.filter(e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r}),delete e.url,e.urls=n?t[0]:t,!!t.length}})}(e.iceServers,t.version),p("ICE servers after filtering:",e.iceServers)),new r(e)},e.RTCPeerConnection.prototype=r.prototype}function M(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}function j(e){const t=g(e),r=e&&e.navigator,n=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){m("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return"object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),e(r.audio,"autoGainControl","mozAutoGainControl"),e(r.audio,"noiseSuppression","mozNoiseSuppression")),t(r)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const r=t.apply(this,arguments);return e(r,"mozAutoGainControl","autoGainControl"),e(r,"mozNoiseSuppression","noiseSuppression"),r}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(r){return"audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),e(r,"autoGainControl","mozAutoGainControl"),e(r,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[r])}}}}function F(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}function U(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function $(e){const t=g(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]})),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,o]=arguments;return n.apply(this,[e||null]).then(e=>{if(t.version<53&&!i)try{e.forEach(e=>{e.type=r[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,n)=>{e.set(n,Object.assign({},t,{type:r[t.type]||t.type}))})}return e}).then(i,o)}}function W(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function G(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),d(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function K(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){m("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function z(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach(e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const n=t.apply(this,arguments);if(r){const{sender:t}=n,r=t.getParameters();(!("encodings"in r)||1===r.encodings.length&&0===Object.keys(r.encodings[0]).length)&&(r.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(r).then(()=>{delete t.sendEncodings}).catch(()=>{delete t.sendEncodings})))}return n})}function V(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function H(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function J(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function Y(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(r=>t.call(this,r,e)),e.getVideoTracks().forEach(r=>t.call(this,r,e))},e.RTCPeerConnection.prototype.addTrack=function(e,...r){return r&&r.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const r=e.getTracks();this.getSenders().forEach(e=>{r.includes(e.track)&&this.removeTrack(e)})})}}function Q(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const r=new Event("addstream");r.stream=t,e.dispatchEvent(r)})}),t.apply(e,arguments)}}}function X(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,i=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i};let a=function(e,t,r){const n=i.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,r){const n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,r){const n=s.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=a}function Z(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>r(ee(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n)}.bind(t))}function ee(e){return e&&void 0!==e.video?Object.assign({},e,{video:y(e.video)}):e}function te(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){const t=[];for(let r=0;r<e.iceServers.length;r++){let n=e.iceServers[r];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(m("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[r])}e.iceServers=t}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function re(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ne(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video")}return t.apply(this,arguments)}}function ie(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var oe=r(10),se=r.n(oe);function ae(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const r=new t(e),n=se.a.parseCandidate(e.candidate),i=Object.assign(r,n);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,d(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function ce(e){if(!e.RTCPeerConnection)return;const t=g(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const r=function(e){if(!e||!e.sdp)return!1;const t=se.a.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=se.a.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const r=parseInt(t[1],10);return r!=r?-1:r},i=function(e){let r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},o=function(e,r){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const i=se.a.matchPrefix(e.sdp,"a=max-message-size:");return i.length>0?n=parseInt(i[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(r(arguments[0])){const e=n(arguments[0]),t=i(e),r=o(arguments[0],e);let s;s=0===t&&0===r?Number.POSITIVE_INFINITY:0===t||0===r?Math.max(t,r):Math.min(t,r);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>s}),this._sctp=a}return s.apply(this,arguments)}}function ue(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const r=e.send;e.send=function(){const n=arguments[0],i=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}const r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=r.apply(this,arguments);return t(e,this),e},d(e,"datachannel",e=>(t(e.channel,e.target),e))}function le(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function de(e){if(!e.RTCPeerConnection)return;const t=g(e);if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n")),r.apply(this,arguments)}}const he=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const r=p,c=g(e),u={browserDetails:c,commonShim:a,extractVersion:l,disableLog:h,disableWarnings:f};switch(c.browser){case"chrome":if(!n||!I||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),u;if(null===c.version)return r("Chrome shim can not determine version, not shimming."),u;r("adapter.js shimming chrome."),u.browserShim=n,_(e),S(e),I(e),T(e),E(e),w(e),D(e),P(e),O(e),ae(e),le(e),ce(e),ue(e),de(e);break;case"firefox":if(!o||!$||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),u;r("adapter.js shimming firefox."),u.browserShim=o,j(e),$(e),U(e),K(e),W(e),G(e),z(e),q(e),V(e),H(e),J(e),ae(e),le(e),ce(e),ue(e);break;case"edge":if(!i||!N||!t.shimEdge)return r("MS edge shim is not included in this adapter release."),u;r("adapter.js shimming edge."),u.browserShim=i,A(e),L(e),N(e),M(e),ce(e),ue(e);break;case"safari":if(!s||!t.shimSafari)return r("Safari shim is not included in this adapter release."),u;r("adapter.js shimming safari."),u.browserShim=s,te(e),ne(e),X(e),Y(e),Q(e),re(e),Z(e),ie(e),ae(e),ce(e),ue(e),de(e);break;default:r("Unsupported browser!")}return u}({window:"undefined"==typeof window?void 0:window});t.default=he},function(e,t,r){"use strict";r.r(t);var n=function(e){var t=this.constructor;return this.then((function(r){return t.resolve(e()).then((function(){return r}))}),(function(r){return t.resolve(e()).then((function(){return t.reject(r)}))}))},i=setTimeout;function o(e){return Boolean(e&&void 0!==e.length)}function s(){}function a(e){if(!(this instanceof a))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],f(e,this)}function c(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,a._immediateFn((function(){var r=1===e._state?t.onFulfilled:t.onRejected;if(null!==r){var n;try{n=r(e._value)}catch(e){return void l(t.promise,e)}u(t.promise,n)}else(1===e._state?u:l)(t.promise,e._value)}))):e._deferreds.push(t)}function u(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if(t instanceof a)return e._state=3,e._value=t,void d(e);if("function"==typeof r)return void f((n=r,i=t,function(){n.apply(i,arguments)}),e)}e._state=1,e._value=t,d(e)}catch(t){l(e,t)}var n,i}function l(e,t){e._state=2,e._value=t,d(e)}function d(e){2===e._state&&0===e._deferreds.length&&a._immediateFn((function(){e._handled||a._unhandledRejectionFn(e._value)}));for(var t=0,r=e._deferreds.length;t<r;t++)c(e,e._deferreds[t]);e._deferreds=null}function h(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}function f(e,t){var r=!1;try{e((function(e){r||(r=!0,u(t,e))}),(function(e){r||(r=!0,l(t,e))}))}catch(e){if(r)return;r=!0,l(t,e)}}a.prototype.catch=function(e){return this.then(null,e)},a.prototype.then=function(e,t){var r=new this.constructor(s);return c(this,new h(e,t,r)),r},a.prototype.finally=n,a.all=function(e){return new a((function(t,r){if(!o(e))return r(new TypeError("Promise.all accepts an array"));var n=Array.prototype.slice.call(e);if(0===n.length)return t([]);var i=n.length;function s(e,o){try{if(o&&("object"==typeof o||"function"==typeof o)){var a=o.then;if("function"==typeof a)return void a.call(o,(function(t){s(e,t)}),r)}n[e]=o,0==--i&&t(n)}catch(e){r(e)}}for(var a=0;a<n.length;a++)s(a,n[a])}))},a.resolve=function(e){return e&&"object"==typeof e&&e.constructor===a?e:new a((function(t){t(e)}))},a.reject=function(e){return new a((function(t,r){r(e)}))},a.race=function(e){return new a((function(t,r){if(!o(e))return r(new TypeError("Promise.race accepts an array"));for(var n=0,i=e.length;n<i;n++)a.resolve(e[n]).then(t,r)}))},a._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){i(e,0)},a._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var p=a,m=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();"Promise"in m?m.Promise.prototype.finally||(m.Promise.prototype.finally=n):m.Promise=p}]).default},"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("BPP2PSDK",[],t):"object"==typeof exports?exports.BPP2PSDK=t():e.BPP2PSDK=t();